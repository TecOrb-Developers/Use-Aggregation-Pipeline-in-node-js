"use strict";var _interopRequireDefault=require("@babel/runtime/helpers/interopRequireDefault");exports.__esModule=true;exports.default=void 0;var _inheritsLoose2=_interopRequireDefault(require("@babel/runtime/helpers/inheritsLoose"));var _commonchartapi=_interopRequireDefault(require("@fusioncharts/charts/src/chart/_internal/commonchartapi"));var _sankey=_interopRequireDefault(require("../../dataset/sankey"));var _sankeyDatasetFactory=_interopRequireDefault(require("../../factories/sankey-dataset-factory"));var _isArray=_interopRequireDefault(require("@fusioncharts/utils/src/type/is-array"));var _lib=require("@fusioncharts/core/src/lib");var _legend=_interopRequireDefault(require("@fusioncharts/charts/src/factories/legend"));var _sankeyhelper=require("../../dataset/sankey/sankeyhelper");var DEFAULT_NODE_WIDTH=20,VERTICAL="vertical",HORIZONTAL="horizontal",RIGHT="right",INVALIDGRAPH="Self loops and circular links are not supported.",prepareData=function prepareData(dataSource){var parsedNodes=[],parsedLinks=[],nodes=dataSource.nodes||[],links=dataSource.links||[],nodeId,nodeIds={};nodes.forEach((function(node){nodeId=(0,_lib.pluck)(node.id,node.label);if(!nodeId)return;nodeIds[nodeId.toString()]=node}));Object.keys(nodeIds).forEach((function(id,index){parsedNodes.push(Object.assign({},nodeIds[id],{props:{}}));parsedNodes[index].id=(0,_lib.parseUnsafeString)((parsedNodes[index].id||parsedNodes[index].label).toString());parsedNodes[index].label=(0,_lib.parseUnsafeString)((parsedNodes[index].label||parsedNodes[index].id).toString())}));links.forEach((function(link){if(!nodeIds[link.from]||!nodeIds[link.to])return;parsedLinks.push(Object.assign({},link,{props:{source:(0,_lib.parseUnsafeString)(link.from),target:(0,_lib.parseUnsafeString)(link.to)},value:(0,_lib.pluck)(link.value,"0")}))}));return{nodes:parsedNodes,links:parsedLinks}};var Sankey=function(_CommonAPI){(0,_inheritsLoose2.default)(Sankey,_CommonAPI);function Sankey(){var _this;_this=_CommonAPI.call(this)||this;_this.registerFactory("legend",_legend.default);_this.registerFactory("dataset",_sankeyDatasetFactory.default,["legend"]);return _this}var _proto=Sankey.prototype;_proto.__setDefaultConfig=function __setDefaultConfig(){_CommonAPI.prototype.__setDefaultConfig.call(this);var chartConfig=this.config;this.legendposition=RIGHT;chartConfig.legendPosition=_lib.preDefStr.POSITION_BOTTOM;chartConfig.orientation=HORIZONTAL;chartConfig.skipCanvasDrawing=true;chartConfig.alignCaptionWithCanvas=false;chartConfig.basefontsize=11};Sankey.getName=function getName(){return"sankey"};_proto.getName=function getName(){return"sankey"};_proto.getDSdef=function getDSdef(){return _sankey.default};_proto._checkInvalidData=function _checkInvalidData(){var dataSource=this.getFromEnv("dataSource");if(!(0,_isArray.default)(dataSource.nodes)||!dataSource.nodes.length){delete this.config.errorMessage;return true}return false};_proto._checkInvalidSpecificData=function _checkInvalidSpecificData(){var chart=this,parsedData=prepareData(chart.getFromEnv("dataSource"));(0,_sankeyhelper.createNodeLinks)(parsedData);if(!(0,_sankeyhelper.traverseGraph)(parsedData)){chart.config.errorMessage=INVALIDGRAPH;return true}delete chart.config.errorMessage;chart.addToEnv("sankey-graph",parsedData);return false};_proto.setChartMessage=function setChartMessage(message,chartObj,_container){var errorMessage=this.config.errorMessage;_CommonAPI.prototype.setChartMessage.call(this,message||errorMessage,chartObj,_container)};_proto.configureAttributes=function configureAttributes(inputConfig){if(inputConfig===void 0){inputConfig={}}_CommonAPI.prototype.configureAttributes.call(this,inputConfig);var chart=this,chartConfig=chart.config,chartAttr=inputConfig.chart||{},numberFormatter=chart.getFromEnv("number-formatter"),graph=chart.getFromEnv("sankey-graph"),nodes=graph.nodes,links=graph.links;if(typeof chartAttr.orientation!=="undefined"){chartConfig.orientation=chartAttr.orientation.toString().toLowerCase();chartConfig.orientation=chartConfig.orientation===VERTICAL?VERTICAL:HORIZONTAL}else{chartConfig.orientation=HORIZONTAL}if(typeof chartAttr.legendposition!=="undefined"){chartConfig.legendPosition=["top-left","top","top-right","right-top","right","right-bottom","bottom-right","bottom","bottom-left","left-bottom","left","left-top"].includes(chartAttr.legendposition.toString().toLowerCase())?chartAttr.legendposition.toString().toLowerCase():_lib.preDefStr.POSITION_BOTTOM}else{chartConfig.legendPosition=RIGHT}chartConfig.legendposition=chartConfig.legendPosition;chart.addToEnv("orientation",chartConfig.orientation);chartConfig.nodeWidth=Math.max(0,numberFormatter.getCleanValue((0,_lib.pluck)(chartAttr.nodewidth,DEFAULT_NODE_WIDTH)));nodes.forEach((function(node){node.nodeWidth=chartConfig.nodeWidth}));links.forEach((function(link){link.value=Math.max(0,numberFormatter.getCleanValue((0,_lib.pluck)(link.value,0)))}));(0,_sankeyhelper.createNodeValues)(graph)};_proto._spaceManager=function _spaceManager(){var chart=this,chartConfig=chart.config,legendPosition=chartConfig.legendPosition,showLegend=chartConfig.showLegend,marginLeft=chartConfig.marginLeft,marginTop=chartConfig.marginTop,marginRight=chartConfig.marginRight,marginBottom=chartConfig.marginBottom,width=+chart.getFromEnv("chartWidth"),height=+chart.getFromEnv("chartHeight"),legend,allotedSpace,actionBarSpace,legendSpace;width-=marginLeft+marginRight;height-=marginTop+marginBottom;actionBarSpace=chart._manageActionBarSpace(.225*height);chart._allocateSpace(actionBarSpace);if(showLegend){legendPosition=legendPosition||[];if(legendPosition.split("-")[0]===_lib.POSITION_TOP||legendPosition.split("-")[0]===_lib.preDefStr.POSITION_BOTTOM){allotedSpace=height*.3}else{allotedSpace=width*.3;if(legendPosition.split("-")[0]===_lib.POSITION_LEFT){chart._allocateSpace({left:11})}else if(legendPosition.split("-")[0]===_lib.POSITION_RIGHT){chart._allocateSpace({right:11})}}legend=chart.getChildren("legend")[0];legendSpace=legend._manageLegendPosition(allotedSpace);chart._allocateSpace(legendSpace)}chart._manageChartMenuBar(.6*chartConfig.availableHeight)};_proto._postSpaceManagement=function _postSpaceManagement(){var chart=this,showLegend=chart.config.showLegend,legends=chart.getChildren("legend");if(legends.length&&showLegend){legends.forEach((function(legend){return legend.postSpaceManager()}))}chart.allocateDimensionOfChartMenuBar()};return Sankey}(_commonchartapi.default);var _default=Sankey;exports.default=_default;