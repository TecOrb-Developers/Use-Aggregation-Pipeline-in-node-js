"use strict";var _interopRequireDefault=require("@babel/runtime/helpers/interopRequireDefault");exports.__esModule=true;exports.default=void 0;var _assertThisInitialized2=_interopRequireDefault(require("@babel/runtime/helpers/assertThisInitialized"));var _inheritsLoose2=_interopRequireDefault(require("@babel/runtime/helpers/inheritsLoose"));var _commonchartapi=_interopRequireDefault(require("@fusioncharts/charts/src/chart/_internal/commonchartapi"));var _arrayHasContent=_interopRequireDefault(require("@fusioncharts/utils/src/type/array-has-content"));var _isObject=_interopRequireDefault(require("@fusioncharts/utils/src/type/is-object"));var _chordLegend=_interopRequireDefault(require("@fusioncharts/charts/src/factories/chord-legend"));var _nodeLinkManager=_interopRequireDefault(require("../../factories/node-link-manager"));var _linear=_interopRequireDefault(require("@fusioncharts/utils/src/scales/linear"));var _lib=require("@fusioncharts/core/src/lib");var _equal=_interopRequireDefault(require("@fusioncharts/utils/src/string/equal"));var _safeMax=_interopRequireDefault(require("@fusioncharts/utils/src/array/safe-max"));var _nodeLinkManager2=_interopRequireDefault(require("../../dataset/chord/node-link-manager"));var _legendSpacemanager=require("@fusioncharts/charts/src/chart/_internal/legend-spacemanager");var CHART_STR="Chord",POST="post",PRE="pre",DEFAULT_PALETTE_COLOR=["1E77B4","FF7F0E","2BA02C","D62728","9466BD","8C564B","E376C2","7F7F7F","BCBD22","17BECF"],DEACTIVE_COLOR="#c4c4c4",DEFAULT_BG_COLOR="FFFFFF,FFFFFF",TANGENTIAL="tangential",OUTSIDE="outside",INSIDE="inside",DEF_FONT_FAMILY="Verdana,sans",ITALIC="italic",NODE_LABEL_COLOR="#5F5F5F",LABEL_POSITIONS=[TANGENTIAL,OUTSIDE,INSIDE],isValidLink=function isValidLink(obj){return(0,_isObject.default)(obj)&&(0,_lib.parseUnsafeString)(obj.from)&&(0,_lib.parseUnsafeString)(obj.to)},isValidNode=function isValidNode(obj,nodeMap){return(0,_isObject.default)(obj)&&(0,_lib.parseUnsafeString)(obj.label)&&nodeMap[obj.label]};var Chord=function(_CommonAPI){(0,_inheritsLoose2.default)(Chord,_CommonAPI);function Chord(id){var _this;_this=_CommonAPI.call(this,id)||this;var chart=(0,_assertThisInitialized2.default)(_this);chart.deregisterFactory("canvas");chart.registerFactory("legend",_chordLegend.default);chart.registerFactory("nodelinkManager",_nodeLinkManager.default);chart.defaultPaletteOptions={paletteColors:[DEFAULT_PALETTE_COLOR,DEFAULT_PALETTE_COLOR,DEFAULT_PALETTE_COLOR,DEFAULT_PALETTE_COLOR,DEFAULT_PALETTE_COLOR],bgColor:[DEFAULT_BG_COLOR,DEFAULT_BG_COLOR,DEFAULT_BG_COLOR,DEFAULT_BG_COLOR,DEFAULT_BG_COLOR]};return _this}var _proto=Chord.prototype;_proto.__setDefaultConfig=function __setDefaultConfig(){_CommonAPI.prototype.__setDefaultConfig.call(this);var config=this.config;config.skipCanvasDrawing=true;config.friendlyName=CHART_STR;config.nodes={};config.mode=POST;config.isPost=true;config.nodeSpacing=2;config.minNodeSize=.01;config.startingAngle=0;config.links={};config.linksOrder=[];config.nodesOrder=[];config.totalAngle=360;config.clockwise=1;config.nodeLabelGap=10;config.nodeLabelPosition=10;config.nodeThickness=12;config.nodeLinkPadding=3;config.linkAlpha=70;config.linkBorderAlpha=100;config.linkBorderThickness=1;config.nodeHoverAlpha=100;config.linkHoverAlpha=100;config.nodeHoverColor=_lib.UNDEF;config.linkHoverColor=_lib.UNDEF;config.showNodeLabels=1;config.showNodeBorder=1;config.showLinkBorder=1;config.nodeBorderColor=_lib.UNDEF;config.nodeBorderThickness=1;config.nodeBorderDashed=0;config.nodeBorderDashedLen=2;config.nodeBorderDashedGap=1;config.nodeBorderAlpha=100;config.showLinkValueOnHover=1;config.nodeAlpha=70;config.nodeLabelPosition=TANGENTIAL;config.nodeLabelFont=DEF_FONT_FAMILY;config.nodeLabelFontSize=12;config.nodeLabelFontBold=_lib.NORMAL;config.nodeLabelFontItalic=_lib.NORMAL;config.highlightEffect=1;config.enableToggle=1;config.chordradius=100;config.nodeLabelColor=NODE_LABEL_COLOR;config.unfocussedAlpha=35;config.deactiveNodeColor=DEACTIVE_COLOR;config.sortOrder=_lib.UNDEF;config.tooltipsepchar=_lib.BLANKSTRING;config.linkColorByDominance=1;config.useEllipsesOnOverflow=1};_proto.configureAttributes=function configureAttributes(dataObj){_CommonAPI.prototype.configureAttributes.call(this,dataObj);var chart=this,config=chart.config,nodes=config.nodes,links=config.links,nodesArr=config.nodesOrder,linksArr=config.linksOrder,connectors=config.connectors=dataObj.links,len=connectors.length,numberFormatter=chart.getFromEnv("number-formatter"),chartAttrs=dataObj.chart,colorM=chart.getFromEnv("color-manager"),i;config.mode=chartAttrs.mode===PRE?PRE:POST;config.isPost=(0,_equal.default)(config.mode,POST);config.minNodeSize=(0,_lib.pluckNumber)(chartAttrs.minnodesize,config.minNodeSize);config.startingAngle=(0,_lib.pluckNumber)(chartAttrs.startingangle,config.startingAngle);config.totalAngle=(0,_lib.pluckNumber)(chartAttrs.totalangle,config.totalAngle);config.nodeLabelGap=(0,_lib.pluckNumber)(chartAttrs.nodelabelpadding,config.nodeLabelGap);config.nodeThickness=(0,_lib.pluckNumber)(chartAttrs.nodethickness,config.nodeThickness);config.nodeSpacing=(0,_lib.pluckNumber)(chartAttrs.nodespacing,config.nodeSpacing);config.clockwise=(0,_lib.pluckNumber)(chartAttrs.clockwise,config.clockwise);config.nodeLinkPadding=(0,_lib.pluckNumber)(chartAttrs.nodelinkpadding,config.nodeLinkPadding);config.linkAlpha=(0,_lib.pluckNumber)(chartAttrs.linkalpha,config.linkAlpha);config.linkBorderAlpha=(0,_lib.pluckNumber)(chartAttrs.linkborderalpha,config.linkBorderAlpha);config.linkBorderThickness=(0,_lib.pluckNumber)(chartAttrs.linkborderthickness,config.linkBorderThickness);config.nodeHoverAlpha=(0,_lib.pluckNumber)(chartAttrs.nodehoveralpha,config.nodeHoverAlpha);config.linkHoverAlpha=(0,_lib.pluckNumber)(chartAttrs.linkhoveralpha,config.linkHoverAlpha);config.showLinkValueOnHover=(0,_lib.pluckNumber)(chartAttrs.showlinkvalueonhover,config.showLinkValueOnHover);config.showNodeLabels=(0,_lib.pluckNumber)(chartAttrs.shownodelabels,config.showNodeLabels);config.showNodeBorder=(0,_lib.pluckNumber)(chartAttrs.shownodeborder,config.showNodeBorder);config.showLinkBorder=(0,_lib.pluckNumber)(chartAttrs.showlinkborder,config.showLinkBorder);config.nodeBorderColor=(0,_lib.pluck)(chartAttrs.nodebordercolor,config.nodeBorderColor);config.nodeBorderThickness=(0,_lib.pluckNumber)(chartAttrs.nodeborderthickness,config.nodeBorderThickness);config.nodeBorderDashed=(0,_lib.pluckNumber)(chartAttrs.nodeborderdashed,config.nodeBorderDashed);config.nodeBorderDashedLen=(0,_lib.pluckNumber)(chartAttrs.nodeborderdashedlen,config.nodeBorderDashedLen);config.nodeBorderDashedGap=(0,_lib.pluckNumber)(chartAttrs.nodeborderdashedgap,config.nodeBorderDashedGap);config.nodeBorderAlpha=(0,_lib.pluckNumber)(chartAttrs.nodeborderalpha,config.nodeBorderAlpha);config.nodeAlpha=(0,_lib.pluckNumber)(chartAttrs.nodealpha,config.nodeAlpha);config.nodeLabelPosition=LABEL_POSITIONS.includes(chartAttrs.nodelabelposition)?chartAttrs.nodelabelposition:config.nodeLabelPosition;config.nodeLabelFont=(0,_lib.pluck)(chartAttrs.nodelabelfont,chartAttrs.basefont,config.nodeLabelFont);config.nodeLabelFontSize=(0,_lib.pluckFontSize)(chartAttrs.nodelabelfontsize,this.computeFontSize(chartAttrs.basefontsize),config.nodeLabelFontSize);config.nodeLabelFontBold=(0,_lib.pluckNumber)(chartAttrs.nodelabelfontbold,0)?_lib.BOLD:_lib.NORMAL;config.nodeLabelColor=(0,_lib.pluck)(chartAttrs.nodelabelcolor,chartAttrs.basefontcolor,config.nodeLabelColor);config.nodeLabelFontItalic=(0,_lib.pluckNumber)(chartAttrs.nodelabelfontitalic,0)?ITALIC:_lib.NORMAL;config.highlightEffect=(0,_lib.pluckNumber)(chartAttrs.highlighteffect,config.highlightEffect);config.enableToggle=(0,_lib.pluckNumber)(chartAttrs.enabletoggle,config.enableToggle);config.chordradius=Math.max((0,_lib.pluckNumber)(chartAttrs.chordradius,config.chordradius),0);config.unfocussedAlpha=(0,_lib.pluckNumber)(chartAttrs.unfocussedalpha,config.unfocussedAlpha);config.deactiveNodeColor=(0,_lib.pluck)(chartAttrs.deactivenodecolor,config.deactiveNodeColor);config.sortOrder=(0,_lib.pluck)(chartAttrs.sortorder,config.sortOrder);config.linkColorByDominance=(0,_lib.pluckNumber)(chartAttrs.linkcolorbydominance,config.linkColorByDominance);config.textOutline=(0,_lib.pluckNumber)(chartAttrs.textoutline,0);config.useEllipsesOnOverflow=(0,_lib.pluckNumber)(chartAttrs.useellipsesonoverflow,config.useEllipsesOnOverflow);config.datalabelStyle={"font-size":config.nodeLabelFontSize,"font-family":config.nodeLabelFont,"font-weight":config.nodeLabelFontBold,"font-style":config.nodeLabelFontItalic};if(config.nodeLabelPosition===INSIDE){config.nodeLabelGap=0}for(i=0;i<len;++i){if(isValidLink(connectors[i])){var connector=connectors[i],from=connector.from,to=connector.to,value=connector.value,tooltext=connector.tooltext,sanitisedValue=(0,_safeMax.default)([numberFormatter.getCleanValue(value),0],Number),key=void 0,link=void 0;from=(0,_lib.parseUnsafeString)(from);to=(0,_lib.parseUnsafeString)(to);key=[from,to].sort().toString();if(!nodes[from]){nodes[from]={index:nodesArr.push(from)-1,total:0,adjustedTotal:0,nodeCovered:0,label:from,linkedLinks:[],scale:new _linear.default,active:true,nodeLabelGap:config.nodeLabelGap,unfocussed:false,hovered:false,toolTipSepChar:config.tooltipsepchar,showToolTip:config.showToolTip}}if(!nodes[to]){nodes[to]={index:nodesArr.push(to)-1,total:0,adjustedTotal:0,nodeCovered:0,label:to,linkedLinks:[],scale:new _linear.default,active:true,nodeLabelGap:config.nodeLabelGap,unfocussed:false,hovered:false,toolTipSepChar:config.tooltipsepchar,showToolTip:config.showToolTip}}if(!links[key]){link=links[key]={key:key,points:[],dominantNode:[],subservientNode:[],subservientFlowDataValue:[],dominantFlowDataValue:[],dominantNodeColor:[],subservientNodeColor:[],index:linksArr.push(key)-1,linkedNodes:config.isPost?[to,from]:[from,to],tooltip:{},visible:true,tooltext:tooltext,unfocussed:false,hovered:false,focussedState:{},unfocussedState:{},normalState:{},sanitisedValue:0,toolTipSepChar:config.tooltipsepchar,showToolTip:config.showToolTip};nodes[from].linkedLinks.push(key);nodes[to].linkedLinks.push(key);link.alpha=(0,_lib.pluckNumber)(connector.alpha,config.linkAlpha);link.hoverAlpha=(0,_lib.pluckNumber)(connector.hoveralpha,config.linkHoverAlpha);link.borderAlpha=(0,_lib.pluckNumber)(connector.borderalpha,config.linkBorderAlpha);link.tooltext=(0,_lib.pluck)(connector.tooltext,config.linktooltext,_lib.UNDEF);link.showBorder=config.showLinkBorder;link.borderThickness=config.linkBorderThickness;link.unfocussedAlpha=(0,_lib.pluckNumber)(connector.unfocussedAlpha,config.unfocussedAlpha);link.style=config.datalabelStyle}else{link=links[key]}nodes[config.isPost?to:from].total+=sanitisedValue;link.tooltip[from+" to "+to]={value:numberFormatter.dataLabels(sanitisedValue)};link.showLinkValueOnHover=config.showLinkValueOnHover;link[config.isPost?to:from]=sanitisedValue;links[key].sanitisedValue+=sanitisedValue}}var _loop=function _loop(_key){if(links.hasOwnProperty(_key)&&links[_key].sanitisedValue===0){delete links[_key];config.linksOrder=linksArr=linksArr.filter((function(link){return link!==_key}));_key.split(",").forEach((function(label){nodes[label].linkedLinks=nodes[label].linkedLinks.filter((function(linkedLink){return linkedLink!==_key}))}))}};for(var _key in links){_loop(_key)}if((0,_arrayHasContent.default)(dataObj.nodes)){dataObj.nodes.forEach((function(node){if(isValidNode(node,nodes)){var label=(0,_lib.parseUnsafeString)(node.label);nodes[label]=Object.assign({},node,nodes[label])}}))}if(config.sortOrder==="ascending"){nodesArr.sort((function(key1,key2){return nodes[key1].total-nodes[key2].total}))}else if(config.sortOrder==="descending"){nodesArr.sort((function(key1,key2){return nodes[key2].total-nodes[key1].total}))}nodesArr.forEach((function(label,index){var node=nodes[label],resolvedStrokeWidth=(config.showNodeBorder?config.nodeBorderThickness:0)||0;node.index=index;node.label=(0,_lib.parseUnsafeString)(node.label);node.alpha=(0,_lib.pluckNumber)(node.alpha,config.nodeAlpha);node.borderAlpha=(0,_lib.pluckNumber)(node.borderalpha,config.nodeBorderAlpha);node.hoverAlpha=(0,_lib.pluckNumber)(node.hoveralpha,config.nodeHoverAlpha);node.borderDashedLen=(0,_lib.pluckNumber)(node.borderdashedlen,config.nodeBorderDashedLen);node.borderDashedGap=(0,_lib.pluckNumber)(node.borderdashedgap,config.nodeBorderDashedGap);node.borderDashed=(0,_lib.pluckNumber)(node.borderdashed,config.nodeBorderDashed)?[node.borderDashedLen,node.borderDashedGap]:"none";node.rawColor=(0,_lib.pluck)(node.color,colorM.getPlotColor(index));node.unfocussedAlpha=(0,_lib.pluckNumber)(node.unfocussedalpha,config.unfocussedAlpha);node.borderColor=(0,_lib.pluck)(node.bordercolor,config.nodeBorderColor,(0,_lib.getDarkColor)(node.rawColor,80));node.tooltext=(0,_lib.pluck)(node.tooltext,chartAttrs.plottooltext,_lib.UNDEF);node.color=(0,_lib.hashify)(node.rawColor);node.labelPosition=(0,_lib.pluck)(node.labelposition,config.nodeLabelPosition);node.nodeLabelGap=config.nodeLabelGap;if((0,_lib.pluckNumber)(chartAttrs.exportenabled)&&(node.labelPosition===OUTSIDE||node.labelPosition===INSIDE)){node.showLabel=0}else{node.showLabel=(0,_lib.pluckNumber)(node.showlabel,config.showNodeLabels)}node.showBorder=config.showNodeBorder;node.labelColor=(0,_lib.pluck)(node.labelcolor,config.nodeLabelColor);node.style=config.datalabelStyle;node.focussedState={fill:(0,_lib.convertColor)(node.rawColor,node.hoverAlpha),stroke:(0,_lib.convertColor)(node.borderColor,node.borderAlpha),"stroke-width":resolvedStrokeWidth,"stroke-dasharray":node.borderDashed};node.normalState={fill:(0,_lib.convertColor)(node.rawColor,node.alpha),stroke:(0,_lib.convertColor)(node.borderColor,node.borderAlpha),"stroke-width":resolvedStrokeWidth,"stroke-dasharray":node.borderDashed};node.unfocussedState={fill:(0,_lib.convertColor)(node.rawColor,node.unfocussedAlpha),stroke:(0,_lib.convertColor)(node.borderColor,node.unfocussedAlpha),"stroke-width":resolvedStrokeWidth,"stroke-dasharray":node.borderDashed};node.deactiveState={fill:config.deactiveNodeColor,stroke:config.deactiveNodeColor,"stroke-width":resolvedStrokeWidth,"stroke-dasharray":node.borderDashed};node.linkedLinks.forEach((function(key){var startsWithRegex=new RegExp("^"+node.label),tooltip=links[key].tooltip;for(var toolKey in tooltip){if(tooltip.hasOwnProperty(toolKey)&&startsWithRegex.test(toolKey)){tooltip[toolKey].color=node.color}}}))}));linksArr.forEach((function(key){var link=links[key],_link$linkedNodes=link.linkedNodes,from=_link$linkedNodes[0],to=_link$linkedNodes[1];if(from===to){link.dominantNode.push(from);link.subservientNode.push(from);link.subservientFlowDataValue.push(numberFormatter.dataLabels(link[from]));link.dominantFlowDataValue.push(numberFormatter.dataLabels(link[from]));link.dominantNodeColor.push(nodes[from].color);link.subservientNodeColor.push(nodes[from].color)}if(link[to]===link[from]){link.dominantNode.push(from,to);link.subservientNode.push(to,from);link.subservientFlowDataValue.push(numberFormatter.dataLabels(link[to]));link.dominantFlowDataValue.push(numberFormatter.dataLabels(link[from]));link.dominantNodeColor.push(nodes[from].color,nodes[to].color);link.subservientNodeColor.push(nodes[to].color,nodes[from].color)}else{if(config.isPost){if((link[to]||0)>(link[from]||0)){config.linkColorByDominance?link.dominantNode.push(to):link.dominantNode.push(from);config.linkColorByDominance?link.subservientNode.push(from):link.subservientNode.push(to);config.linkColorByDominance?link.dominantFlowDataValue.push(numberFormatter.dataLabels(link[to])):link.dominantFlowDataValue.push(numberFormatter.dataLabels(link[from]));config.linkColorByDominance?link.subservientFlowDataValue.push(numberFormatter.dataLabels(link[from])):link.subservientFlowDataValue.push(numberFormatter.dataLabels(link[to]));config.linkColorByDominance?link.dominantNodeColor.push(nodes[to].color):link.dominantNodeColor.push(nodes[from].color);config.linkColorByDominance?link.subservientNodeColor.push(nodes[from].color):link.subservientNodeColor.push(nodes[to].color)}else{config.linkColorByDominance?link.dominantNode.push(from):link.dominantNode.push(to);config.linkColorByDominance?link.subservientNode.push(to):link.subservientNode.push(from);config.linkColorByDominance?link.dominantFlowDataValue.push(numberFormatter.dataLabels(link[from])):link.dominantFlowDataValue.push(numberFormatter.dataLabels(link[to]));config.linkColorByDominance?link.subservientFlowDataValue.push(numberFormatter.dataLabels(link[to])):link.subservientFlowDataValue.push(numberFormatter.dataLabels(link[from]));config.linkColorByDominance?link.dominantNodeColor.push(nodes[from].color):link.dominantNodeColor.push(nodes[to].color);config.linkColorByDominance?link.subservientNodeColor.push(nodes[to].color):link.subservientNodeColor.push(nodes[from].color)}}else{if((link[to]||0)>(link[from]||0)){config.linkColorByDominance?link.dominantNode.push(from):link.dominantNode.push(to);config.linkColorByDominance?link.subservientNode.push(to):link.subservientNode.push(from);config.linkColorByDominance?link.dominantFlowDataValue.push(numberFormatter.dataLabels(link[from])):link.dominantFlowDataValue.push(numberFormatter.dataLabels(link[to]));config.linkColorByDominance?link.subservientFlowDataValue.push(numberFormatter.dataLabels(link[to])):link.subservientFlowDataValue.push(numberFormatter.dataLabels(link[from]));config.linkColorByDominance?link.dominantNodeColor.push(nodes[from].color):link.dominantNodeColor.push(nodes[to].color);config.linkColorByDominance?link.subservientNodeColor.push(nodes[to].color):link.subservientNodeColor.push(nodes[from].color)}else{config.linkColorByDominance?link.dominantNode.push(to):link.dominantNode.push(from);config.linkColorByDominance?link.subservientNode.push(from):link.subservientNode.push(to);config.linkColorByDominance?link.dominantFlowDataValue.push(numberFormatter.dataLabels(link[to])):link.dominantFlowDataValue.push(numberFormatter.dataLabels(link[from]));config.linkColorByDominance?link.subservientFlowDataValue.push(numberFormatter.dataLabels(link[from])):link.subservientFlowDataValue.push(numberFormatter.dataLabels(link[to]));config.linkColorByDominance?link.dominantNodeColor.push(nodes[to].color):link.dominantNodeColor.push(nodes[from].color);config.linkColorByDominance?link.subservientNodeColor.push(nodes[from].color):link.subservientNodeColor.push(nodes[to].color)}}}}))};Chord.getName=function getName(){return"Chord"};_proto.getName=function getName(){return"Chord"};_proto.getDSdef=function getDSdef(){return _nodeLinkManager2.default};_proto._manageLegendSpace=function _manageLegendSpace(){_legendSpacemanager._manageLegendSpace.call(this)};_proto._spaceManager=function _spaceManager(){var chart=this,config=chart.config,height,width,cx,cy,nodesLinkManager=chart.getChildren("node-link-manager")[0],maxNodeDim,maxRadius,minRadius,maxSpace;config.showLegend&&chart._manageLegendSpace();chart._manageChartMenuBar(config.availableHeight*.6);chart.allocateDimensionOfChartMenuBar();chart.config.showLegend&&chart.getChildren("legend")&&chart.getChildren("legend")[0].postSpaceManager();height=config.canvasHeight;width=config.canvasWidth;cx=config.canvasLeft+width/2;cy=config.canvasTop+height/2;maxRadius=Math.min(height,width)/2;minRadius=maxRadius*.3;maxSpace=maxRadius-minRadius-config.nodeLabelGap;maxNodeDim=nodesLinkManager._manageSpace({maxSpace:maxSpace});chart.config.cx=cx;chart.config.cy=cy;var nodeOuterRadius=Math.max((maxRadius-maxNodeDim.width-config.nodeLabelGap)*config.chordradius/100,minRadius),nodeInnerRadius=nodeOuterRadius-config.nodeThickness,ribbonRadius=nodeInnerRadius-config.nodeLinkPadding;config.ribbonRadius=ribbonRadius;nodesLinkManager.setDimension({nodeOuterRadius:nodeOuterRadius,nodeInnerRadius:nodeInnerRadius,ribbonRadius:ribbonRadius});nodesLinkManager.setTranslation(cx,cy)};_proto._checkInvalidData=function _checkInvalidData(){var chartInstance=this.getFromEnv("chartInstance");if(!(0,_arrayHasContent.default)(this.getFromEnv("dataSource").links)){chartInstance.__state.dataReady=false;chartInstance.jsVars.hasNativeMessage=true;chartInstance.jsVars.drawCount+=1;return true}return!this};_proto._checkInvalidSpecificData=function _checkInvalidSpecificData(){return!this};return Chord}(_commonchartapi.default);var _default=Chord;exports.default=_default;