"use strict";var _interopRequireDefault=require("@babel/runtime/helpers/interopRequireDefault");exports.__esModule=true;exports.default=void 0;var _inheritsLoose2=_interopRequireDefault(require("@babel/runtime/helpers/inheritsLoose"));var _lib=require("@fusioncharts/core/src/lib");var _safeMax=_interopRequireDefault(require("@fusioncharts/utils/src/array/safe-max"));var _safeMin=_interopRequireDefault(require("@fusioncharts/utils/src/array/safe-min"));var _schedular=require("@fusioncharts/core/src/schedular");var _mscolumn2d=_interopRequireDefault(require("@fusioncharts/charts/src/chart/mscolumn2d"));var _fetchData=_interopRequireDefault(require("@fusioncharts/core/src/_internal/misc/fetch-data"));var _dependencyManager=require("@fusioncharts/core/src/dependency-manager");var _editableCharts=require("./editable-charts");var UNDEF,transcoders=(0,_dependencyManager.getDepsByType)("transcoder"),UNDERSCORE=_lib.preDefStr.UNDERSCORE,BLANK=_lib.BLANKSTRING,count=0,updateDataLimit=function updateDataLimit(e){var iapi=e.sender.apiInstance,canvas=iapi.getChildren("canvas")[0],vCanvas=canvas.getChildren("vCanvas")[0],iapiConf=iapi.config,dataLimit,data=e.data,endValue=data&&data.endValue,startValue=data&&data.startValue;if(endValue>iapiConf.yMax||endValue<iapiConf.yMin||startValue===iapiConf.yMin||startValue===iapiConf.yMax){dataLimit=vCanvas.getDataLimits();iapiConf.yMax=dataLimit.max;iapiConf.yMin=dataLimit.min}},sanitiseFormatStr=function sanitiseFormatStr(str){return str.toString().toLowerCase()};var DragBase=function(_MSColumn2D){(0,_inheritsLoose2.default)(DragBase,_MSColumn2D);function DragBase(){var _this;_this=_MSColumn2D.call(this)||this;_this.eiMethods.getDataWithId=function(){var chartInstance=this,dataObj=chartInstance.apiInstance&&chartInstance.apiInstance.getJSONData(),returnObj=[[BLANK]],datasets=dataObj.dataset,catArr=dataObj.categories&&dataObj.categories[0]&&dataObj.categories[0].category,i=datasets&&datasets.length||0,vLinePassed=0,setArr,catName,catObj,set,DS,item,dsID,id,j,ln;while(i--){DS=datasets[i];if(DS){returnObj[0][i+1]=DS.id||DS.seriesname;dsID=DS.id||i+1;set=DS.data;ln=set&&set.length||0;for(j=0;j<ln;j+=1){item=j+1;if(!returnObj[item]){catObj=catArr&&catArr[j+vLinePassed]||{};while(catObj.vline){vLinePassed+=1;catObj=catArr[j+vLinePassed]||{}}catName=catObj.label||catObj.name||BLANK;returnObj[item]=[catName]}setArr=returnObj[item];id=set[j].id||item+UNDERSCORE+dsID;setArr[i+1]=[id,Number(set[j].value)]}}}return returnObj};_this.eiMethods.getData=function(format){var chartInstance=this,jsonData=chartInstance.apiInstance&&chartInstance.apiInstance.getJSONData(),returnData,datasets=jsonData.dataset,len=datasets&&datasets.length||0,i=0,transcoderObjSource,sanitisedFormat;if(format){sanitisedFormat=sanitiseFormatStr(format);if(/^json$/gi.test(sanitisedFormat)){returnData=jsonData}else{transcoderObjSource=transcoders[sanitisedFormat]();returnData=transcoderObjSource.fromJSON(jsonData,chartInstance).data}}else{returnData=_fetchData.default.call(chartInstance.apiInstance);returnData.unshift([BLANK]);while(i<len){returnData[0][i+1]=datasets[i++].seriesname}}return returnData};_this.eiMethods.setUpperLimit=function(limit,callback){var iapi=this.apiInstance,output;if(callback){iapi.addJob("setUpperLimitId"+count++,(function(){output=iapi.changeUpperLimits(limit);if(typeof callback==="function"){callback(output)}}),_schedular.priorityList.postRender)}else{return iapi.changeUpperLimits(limit)}};_this.eiMethods.setLowerLimit=function(limit,callback){var iapi=this.apiInstance,output;if(callback){iapi.addJob("setLowerLimitId"+count++,(function(){output=iapi.changeLowerLimits(limit);if(typeof callback==="function"){callback(output)}}),_schedular.priorityList.postRender)}else{return iapi.changeLowerLimits(limit)}};_this.eiMethods.getLowerLimit=function(callback){var iapi=this.apiInstance,yAxis=iapi.getChildren("yAxis")[0];if(yAxis){if(callback){iapi.addJob("getLowerLimitId"+count++,(function(){if(typeof callback==="function"){callback(yAxis.config.axisRange.min)}}),_schedular.priorityList.postRender)}else{return yAxis.config.axisRange.min}}};_this.eiMethods.getUpperLimit=function(callback){var iapi=this.apiInstance,yAxis=iapi.getChildren("yAxis")[0];if(yAxis){if(callback){iapi.addJob("getUpperLimitId"+count++,(function(){if(typeof callback==="function"){callback(yAxis.config.axisRange.max)}}),_schedular.priorityList.postRender)}else{return yAxis.config.axisRange.max}}};return _this}var _proto=DragBase.prototype;_proto.getName=function getName(){return"DragBase"};_proto.configureAttributes=function configureAttributes(dataObj){_MSColumn2D.prototype.configureAttributes.call(this,dataObj);this.getName()!=="DragNode"&&this.getFromEnv("chartInstance").addEventListener("dataplotdragend",updateDataLimit)};_proto.mouseoutHandler=function mouseoutHandler(e,_lastDatasetIndex,_lastPointIndex){var chart=this,datasets=chart.config.datasetOrder||chart.getDatasets(),mouseTracker=chart.getChildren("mouseTracker")[0];if(datasets[_lastDatasetIndex]&&datasets[_lastDatasetIndex].components.data[_lastPointIndex]){datasets[_lastDatasetIndex]._firePlotEvent(_lib.MOUSEOUT,_lastPointIndex,e)}else{chart.getFromEnv("toolTipController").hideAll()}delete mouseTracker._lastDatasetIndex;delete mouseTracker._lastPointIndex};DragBase.getName=function getName(){return"DragBase"};_proto._mouseEvtHandler=function _mouseEvtHandler(e,data){var chart=this,mouseTracker=data.mouseTracker,datasets=chart.config.datasetOrder||chart.getDatasets(),coordinate=(0,_lib.getMouseCoordinate)(chart.getFromEnv("chart-container"),e.originalEvent,chart),dataset,hoveredInfo,pointFound=false,i=datasets.length,j,l,derivedEvensInfo,_lastDatasetIndex=mouseTracker._lastDatasetIndex,_lastPointIndex=mouseTracker._lastPointIndex,dragStart,eventType;_lastPointIndex!==UNDEF&&datasets[_lastDatasetIndex]&&datasets[_lastDatasetIndex].components.data[_lastPointIndex]&&(dragStart=datasets[_lastDatasetIndex].components.data[_lastPointIndex].config.dragStart);if(!dragStart){while(i--&&!pointFound){dataset=datasets[i];if(dataset&&dataset.getState("visible")){hoveredInfo=dataset._getHoveredPlot&&dataset._getHoveredPlot(coordinate.chartX,coordinate.chartY);if(hoveredInfo&&hoveredInfo.hovered){pointFound=true;hoveredInfo.datasetIndex=i;derivedEvensInfo=mouseTracker.getMouseEvents(e,hoveredInfo.datasetIndex,hoveredInfo.pointIndex)}}}}if(dragStart&&_lastDatasetIndex!==UNDEF){eventType=e.type===_lib.MOUSEOUT?_lib.MOUSEMOVE:e.type;datasets[_lastDatasetIndex]&&datasets[_lastDatasetIndex]._firePlotEvent&&datasets[_lastDatasetIndex]._firePlotEvent(eventType,_lastPointIndex,e)}if(!dragStart&&(!pointFound||derivedEvensInfo&&derivedEvensInfo.fireOut)&&_lastDatasetIndex!==UNDEF){if(datasets[_lastDatasetIndex]&&datasets[_lastDatasetIndex]._firePlotEvent){if(derivedEvensInfo&&!derivedEvensInfo.events.length){mouseTracker.mouseoutTimer=setTimeout((function(){chart.mouseoutHandler(e,_lastDatasetIndex,_lastPointIndex)}),20)}else{chart.mouseoutHandler(e,_lastDatasetIndex,_lastPointIndex);clearTimeout(mouseTracker.mouseoutTimer)}}}if(pointFound){l=derivedEvensInfo.events&&derivedEvensInfo.events.length;if(l){mouseTracker._lastDatasetIndex=hoveredInfo.datasetIndex;_lastPointIndex=mouseTracker._lastPointIndex=hoveredInfo.pointIndex}for(j=0;j<l;j+=1){dataset&&dataset._firePlotEvent&&dataset._firePlotEvent(derivedEvensInfo.events[j],_lastPointIndex,e)}}};_proto.parseChartAttr=function parseChartAttr(dataObj){_MSColumn2D.prototype.parseChartAttr.call(this,dataObj);var chart=this,chartAttr=chart.getFromEnv("dataSource").chart,chartConfig;chartConfig=chart.config;chartConfig.formAction=(0,_lib.getValidValue)(chartAttr.formaction);if(chartAttr.submitdataasxml===_lib.ZEROSTRING&&!chartAttr.formdataformat){chartAttr.formdataformat=transcoders.csv().format}chartConfig.formDataFormat=(0,_lib.pluck)(chartAttr.formdataformat,transcoders.xml().format);chartConfig.formTarget=(0,_lib.pluck)(chartAttr.formtarget,"_self");chartConfig.formMethod=(0,_lib.pluck)(chartAttr.formmethod,"POST");chartConfig.submitFormAsAjax=(0,_lib.pluckNumber)(chartAttr.submitformusingajax,1);chartConfig.restoreBtnTitle=(0,_lib.pluck)(chartAttr.restoretext,chartAttr.restorebtntitle,"Restore");chartConfig.submitBtnTitle=(0,_lib.pluck)(chartAttr.submittext,chartAttr.formbtntitle,"Submit");chartConfig.showFormBtn=(0,_lib.pluckNumber)(chartAttr.enablesubmit,chartAttr.showformbtn,1)&&chartConfig.formAction;chartConfig.showRestoreBtn=(0,_lib.pluckNumber)(chartAttr.enablerestore,chartAttr.showrestorebtn,1);chartConfig.formBtnTitle=(0,_lib.pluck)(chartAttr.formbtntitle,"Submit");chartConfig.formBtnStyle={fontSize:chartConfig.style.outCanfontSize,fontFamily:chartConfig.style.outCanfontFamily,fontWeight:"bold"};chartConfig.restoreBtnWidth=(0,_lib.pluckNumber)(chartAttr.restorebtnwidth,0);chartConfig.allowAxisChange=(0,_lib.pluckNumber)(chartAttr.allowaxischange,1);if(chartAttr.toolbary||chartAttr.toolbarx){chartConfig.spaceHardCoded=true}else{delete chartConfig.spaceHardCoded}chartConfig.drawTrendRegion=(0,_lib.pluckNumber)(chartAttr.drawcrossline,0)};_proto._storeIntialLimit=function _storeIntialLimit(min,max){this.config.axisInitialLimit={min:min,max:max}};_proto.attachMenuButtons=function attachMenuButtons(){_MSColumn2D.prototype.attachMenuButtons.call(this);this.addConfigureOptions()};_proto.addConfigureOptions=function addConfigureOptions(){var chart=this,toolbar=chart.getFromEnv("toolbar"),hamburgerMenu=toolbar.getChild("hamburgerMenu-"+toolbar.getId()+"-"+chart.getId()+"-0"),chartConf=chart.config,restore,submit,configureTools=[{name:"Increase Upper Limit",handler:function handler(){var axisRange=chart.getChildren("yAxis")[0].getLimit();chart.changeUpperLimits(axisRange.max+axisRange.tickInterval)},action:"click"},{name:"Increase Lower Limit",handler:function handler(){var axisRange=chart.getChildren("yAxis")[0].getLimit();chart.changeLowerLimits(axisRange.min+axisRange.tickInterval)},action:"click"},{name:"Decrease Upper Limit",handler:function handler(){var axisRange=chart.getChildren("yAxis")[0].getLimit();chart.changeUpperLimits(axisRange.max-axisRange.tickInterval)},action:"click"},{name:"Decrease Lower Limit",handler:function handler(){var axisRange=chart.getChildren("yAxis")[0].getLimit();chart.changeLowerLimits(axisRange.min-axisRange.tickInterval)},action:"click"}];if(chartConf.showFormBtn){submit={name:chartConf.submitBtnTitle,handler:function handler(){_editableCharts.submitData.call(chart)},action:"click"};configureTools.push(submit)}if(chartConf.showRestoreBtn){restore={name:chartConf.restoreBtnTitle,handler:function handler(){chart.restoreData()},action:"click"};configureTools.push(restore)}if(chartConf.allowAxisChange){hamburgerMenu.appendInMenu(configureTools)}};_proto.restoreData=function restoreData(){var chart=this,yAxis=chart.getChildren("yAxis")[0],chartAttr=chart.getFromEnv("chart-attrib"),axisInitialLimit=chart.config.axisInitialLimit;chart.iterateComponents((function(child){var data;if(data=child.getChildren("dataset")){data.forEach((function(dataset){dataset.restore()}))}}));yAxis.resetStoredLimits();yAxis.setAxisConfig({axisMaxValue:chartAttr.yaxismaxvalue,axisMinValue:chartAttr.yaxisminvalue});yAxis.setDataLimit(axisInitialLimit.max,axisInitialLimit.min);chart.fireChartInstanceEvent("dataRestored",{});chart._manageInteractiveSpace()};_proto.changeLowerLimits=function changeLowerLimits(lowerLimit){var chart=this,yAxis=chart.getChildren("yAxis")[0],axisRange=yAxis.getLimit(),min=axisRange.min,config=chart.config,minValue=(0,_safeMin.default)([config.yMin,yAxis.getTrendLineLimits()[0]]),limitchanged=false,max=axisRange.max;chart.getFromEnv("animationManager").setAnimationState("update");if(lowerLimit!==UNDEF&&lowerLimit<minValue&&lowerLimit!==axisRange.min&&config.allowAxisChange){min=lowerLimit;limitchanged=true}if(limitchanged){yAxis.resetStoredLimits();yAxis.setAxisConfig({axisMaxValue:max,axisMinValue:min,showLowerLimit:true});yAxis.setDataLimit(max,min);chart._manageInteractiveSpace()}return limitchanged};_proto.changeUpperLimits=function changeUpperLimits(upperLimit){var chart=this,yAxis=chart.getChildren("yAxis")[0],axisRange=yAxis.getLimit(),min=axisRange.min,config=chart.config,maxValue=(0,_safeMax.default)([config.yMax,yAxis.getTrendLineLimits()[1]]),limitchanged=false,max;chart.getFromEnv("animationManager").setAnimationState("update");if(upperLimit!==UNDEF&&upperLimit>maxValue&&upperLimit!==axisRange.max&&config.allowAxisChange){max=upperLimit;limitchanged=true}if(limitchanged){yAxis.resetStoredLimits();yAxis.setAxisConfig({axisMaxValue:max,axisMinValue:min,showUpperLimit:true});yAxis.setDataLimit(max,min);chart._manageInteractiveSpace()}return limitchanged};_proto.getJSONData=function getJSONData(){var chart=this,canvas=chart.getChildren("canvas")[0],vCanvas=canvas.getChildren("vCanvas")[0],rawObj=chart.getFromEnv("dataSource"),groupManager,datasetsArr=[],dataset,datasets,dataObj,i,len,jsonObj;vCanvas.iterateComponents((function(component){if(component.getType()==="group"){groupManager=component}}));if(groupManager){datasetsArr=groupManager.getJSONData&&groupManager.getJSONData()}else{datasets=chart.getDatasets();len=datasets.length;for(i=0;i<len;i++){dataset=datasets[i];dataObj={seriesname:dataset.config.seriesname,data:dataset.getJSONData().data};datasetsArr.push(dataObj)}}jsonObj=(0,_lib.extend2)({},rawObj);jsonObj.dataset=datasetsArr;return jsonObj};return DragBase}(_mscolumn2d.default);DragBase.prototype._manageInteractiveSpace=_lib._manageInteractiveSpace;var _default=DragBase;exports.default=_default;