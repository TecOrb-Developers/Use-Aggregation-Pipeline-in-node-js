"use strict";var _interopRequireDefault=require("@babel/runtime/helpers/interopRequireDefault");exports.__esModule=true;exports.default=void 0;var _inheritsLoose2=_interopRequireDefault(require("@babel/runtime/helpers/inheritsLoose"));var _lib=require("@fusioncharts/core/src/lib");var _schedular=require("@fusioncharts/core/src/schedular");var UNDEF,DRILLUP="drillup",HIDDEN_STR="hidden",VISIBLE_STR="visible",NONE="none",CLICK_STR="click",CLICKEDSTATE="ClickedState",VISIBLEROOT="VisibileRoot",DATAPLOTCLICK="dataplotclick",DATAPLOTROLLOVER="dataplotrollover",DATAPLOTROLLOUT="dataplotrollout",HOVER="hover",DRILLDOWN="drilldown",BOTH="both",LEFT="left",NO="no",RIGHT="right",STACKED_STR="stacked",id=1,afAPICreator=function afAPICreator(afAPI,containerManager){var iterator,maxDepth,visibleRoot,visibilityController,context;var AbstractTreeMaker=function(){function AbstractTreeMaker(node,bucketIterationMode,cleansingFn){this.node=node;this.bucket=bucketIterationMode?new Bucket:UNDEF;this.cleansingFn=cleansingFn}var _proto=AbstractTreeMaker.prototype;_proto.get=function get(){var orderFn=this.order,bucket=this.bucket,cleansingFn=this.cleansingFn;return function rec(root,level){var pNewNode,index,children,childNode,newNode,notMetaKeys=["label","value","data","svalue"],key;if(root){pNewNode=new TreeNode((0,_lib.parseUnsafeString)(root.label),cleansingFn(root.value),cleansingFn(root.svalue));children=root.data||[];if(children.length===0&&bucket){bucket.addInBucket(pNewNode)}pNewNode.setDepth(level);for(key in root){if(notMetaKeys.indexOf(key)!==-1){continue}pNewNode.setMeta(key,root[key])}}if(orderFn){children=orderFn(children)}for(index=0;index<children.length;index++){childNode=children[index];newNode=rec(childNode,level+1);pNewNode.addChild(newNode)}return pNewNode}(this.node,0)};_proto.getBucket=function getBucket(){return this.bucket};AbstractTreeMaker.getMaxDepth=function getMaxDepth(){return maxDepth};return AbstractTreeMaker}();function setMaxDepth(value){return maxDepth=value}iterator=function iterator(rootNode,controlOptions){var it={},exception=controlOptions&&controlOptions.exception,df,bf;var Iterable=function(){function Iterable(iterAPI){this.iterAPI=iterAPI}var _proto2=Iterable.prototype;_proto2.initWith=function initWith(rootNode){return this.iterAPI(rootNode)};return Iterable}();it.df=function(node){var nextNode=node,dfArr=[],next,reset,isExhausted=false;dfArr.push(nextNode);next=function next(maxDepth){var children,fNode,len;if(isExhausted){return}fNode=dfArr.shift();if(exception&&fNode===exception){fNode=dfArr.shift();if(!fNode){isExhausted=true;return}}children=maxDepth!==UNDEF?fNode.getDepth()>=maxDepth?[]:fNode.getChildren():fNode.getChildren();len=children&&children.length||0;if(len){[].unshift.apply(dfArr,children)}if(dfArr.length===0){isExhausted=true}return fNode};reset=function reset(){isExhausted=false;nextNode=node;dfArr.length=0;dfArr.push(nextNode)};return{next:next,reset:reset}};it.bf=function(node){var nextNode=node,bfArr=[],next,nextBatch,reset,bfBatchArray=[],isExhausted=false;bfArr.push(nextNode);bfBatchArray.push(nextNode);next=function next(){var children,fNode,len;if(isExhausted){return}fNode=bfArr.shift();children=fNode.getChildren();len=children&&children.length||0;if(len){[].push.apply(bfArr,children)}if(bfArr.length===0){isExhausted=true}return fNode};nextBatch=function nextBatch(){var children,fNode,len;if(isExhausted){return}fNode=bfBatchArray.shift();children=fNode.getChildren();len=children&&children.length||0;if(len){[].push.apply(bfBatchArray,children)}if(bfArr.length===0){isExhausted=true}return children};reset=function reset(){isExhausted=false;nextNode=node;bfArr.length=0;bfArr.push(nextNode)};return{next:next,nextBatch:nextBatch,reset:reset}};df=new Iterable(it.df).initWith(rootNode);bf=new Iterable(it.bf).initWith(rootNode);return{df:df,bf:bf}};function initConfigurationForlabel(padding,lineHeightVal,attrs){var lineHeight=lineHeightVal,padX=padding.x,padY=padding.y,halfLineHeight=lineHeight/2,titleHideFlag=attrs.showParent?0:1,showChildLabels=attrs.showChildLabels;return function(node,rect,forcedLabel){var isLeaf=false,textCalConf={x:UNDEF,y:UNDEF,width:UNDEF,height:UNDEF},conf={},rectShiftY=0,textAttr={},highlightAttr={},visibility,availableHeight,meta;meta=node.meta;if(!node){return}if(!node.isLeaf(maxDepth)){isLeaf=true}conf.label=node.getLabel();textCalConf.width=rect.width-2*padX;textCalConf.x=rect.x+rect.width/2;availableHeight=rect.height-2*padY;if(!isLeaf&&availableHeight<lineHeight){textCalConf.height=-1}if(!forcedLabel&&isLeaf){textCalConf.height=showChildLabels?textCalConf.height?textCalConf.height:rect.height-2*padY:-1;textCalConf.y=rect.y+rect.height/2}else{if(!titleHideFlag){textCalConf.height=textCalConf.height?textCalConf.height:lineHeight;textCalConf.y=rect.y+padY+halfLineHeight}else{textCalConf.y=-1;padY=0;lineHeight=0;visibility=HIDDEN_STR}}rectShiftY+=2*padY;rectShiftY+=lineHeight;conf.rectShiftY=rectShiftY;conf.textRect=textCalConf;if(attrs.labelGlow){highlightAttr["stroke-width"]=attrs.labelGlowRadius;highlightAttr.opacity=attrs.labelGlowIntensity;highlightAttr.stroke=attrs.labelGlowColor;highlightAttr.visibility=visibility==="hidden"?"hidden":"visible"}else{highlightAttr.visibility=HIDDEN_STR}textAttr={fontSize:attrs.labelFontSize||attrs.baseFontSize,fontFamily:attrs.labelFont||attrs.baseFont,fill:(0,_lib.convertColor)(meta&&meta.fontcolor&&normalizeColorCode(meta.fontcolor)||attrs.labelFontColor||attrs.baseFontColor),fontWeight:attrs.labelFontBold&&"bold",fontStyle:attrs.labelFontItalic&&"italic",visibility:visibility};return{conf:conf,attr:textAttr,highlight:highlightAttr}}}function isInRange(dsConf,nodeColorValue){var range=dsConf.range;if(!range){return true}else if(range.min<=nodeColorValue&&nodeColorValue<=range.max){return true}return false}function mapColorManager(attrs,colorRange,isNavigationBar){var defaultParentBGColor=normalizeColorCode(isNavigationBar?attrs.defaultNavigationBarBGColor:attrs.defaultParentBGColor);return function(node,isNavigationBar,dsConf){var colorProp={},cssConf=node.cssConf,meta=node.meta,overriddenColor=meta.fillcolor?normalizeColorCode(meta.fillcolor):UNDEF,parentColor,parentStyle,parentNode=node.getParent(),thisNodeColor,nodeColorValue=node.getColorValue();attrs.isLegendEnabled=true;if(attrs.isLegendEnabled&&(nodeColorValue===0||nodeColorValue)){if(colorRange&&colorRange.getColorByValue(nodeColorValue)){if(isInRange(dsConf,nodeColorValue)){node.presentColor="#"+colorRange.getColorByValue(nodeColorValue)}else{node.presentColor=normalizeColorCode(dsConf.rangeOutBgColor)}}else{node.presentColor=normalizeColorCode(colorRange&&colorRange.rangeOutsideColor)}}else{node.presentColor=UNDEF}if(overriddenColor){node.presentColor=overriddenColor}thisNodeColor=attrs.isLegendEnabled&&(nodeColorValue===0||nodeColorValue)?colorRange&&colorRange.getColorByValue(nodeColorValue)&&"#"+colorRange.getColorByValue(nodeColorValue)||normalizeColorCode(colorRange&&colorRange.rangeOutsideColor):UNDEF;if(node.isLeaf(maxDepth)){colorProp.fill=overriddenColor||thisNodeColor||defaultParentBGColor}else{parentStyle=(parentNode||node).cssConf;parentColor=parentStyle&&parentStyle.fill;thisNodeColor=thisNodeColor||parentColor;colorProp.fill=overriddenColor||thisNodeColor}colorProp.stroke=isNavigationBar?attrs.navigationBarBorderColor:attrs.plotBorderColor;colorProp.strokeWidth=isNavigationBar?attrs.navigationBarBorderThickness:attrs.plotBorderThickness;colorProp["stroke-dasharray"]=NONE;if(!isNavigationBar){if(cssConf&&cssConf["stroke-dasharray"]==="--"){colorProp["stroke-dasharray"]=cssConf["stroke-dasharray"];colorProp.strokeWidth=cssConf.strokeWidth}}return colorProp}}context=function(){var objContainer={},pointer;function C_(){this.con={}}C_.prototype.constructor=C_;C_.prototype.get=function(key){return this.con[key]};C_.prototype.set=function(key,value){this.con[key]=value};C_.prototype["delete"]=function(key){return delete this.con[key]};return{getInstance:function getInstance(id){var _con;if(objContainer[id]){_con=objContainer[id];pointer=_con;return pointer}pointer=_con=objContainer[id]=new C_;return pointer}}}();function setVisibleRoot(node){visibleRoot=node}function getVisibleRoot(){return visibleRoot}function abstractEventRegisterer(algorithmAPI,dsStore,canvasMeasurement,rendererAPI){var chart=dsStore.getFromEnv("chart"),btns=dsStore.getFromEnv("toolbarBtns"),attrs=dsStore.conf,drawTreeFn=algorithmAPI.drawTree,removeFn=rendererAPI.disposeChild,_backToParent,context=afAPI.context,args=arguments,stateContextId=CLICKEDSTATE,visibleState=VISIBLEROOT,plotClickEvt=DATAPLOTCLICK,plotRollOverEvt=DATAPLOTROLLOVER,plotRollOutEvt=DATAPLOTROLLOUT,stateContext,_resetTree,dataUprootMap={colorValue:"svalue",label:"name",value:"value",rect:"metrics"};stateContext=context.getInstance(stateContextId);chart._intSR={};function extractEventData(node){var res={},key,resKey;for(key in dataUprootMap){resKey=dataUprootMap[key];res[resKey]=node[key]}res.fillColor=node.meta.fillcolor||node.cssConf.fill;res.fontColor=node.meta.fontcolor||node.cssConf.stroke;return res}chart._intSR.backToParent=_backToParent=function backToParent(raiseEventFlag){var target=this,_t=target,_p=_t&&target.getParent(),context=afAPI.context,stateContextId=CLICKEDSTATE,visibleState=VISIBLEROOT,stateContext=context.getInstance(stateContextId),clickedState=stateContext.get(visibleState)||{};chart.config.trackerConfig.length=0;chart.triggerKDTreePartioning();if(raiseEventFlag){chart.fireChartInstanceEvent("beforedrillup",{node:target,withoutHead:!attrs.showParent},UNDEF,(function(){if(_p){clickedState.state=DRILLUP;clickedState.node=[{virginNode:afAPI.getVisibleRoot()},_p];removeFn(_t);drawTreeFn.apply(_p,args)}chart.fireChartInstanceEvent(DRILLUP,{node:target,withoutHead:!attrs.showParent,drillUp:_backToParent,drillUpToTop:_resetTree});target=target&&target.getParent()}),(function(){chart.fireChartInstanceEvent("drillupcancelled",{node:target,withoutHead:!attrs.showParent})}))}else{if(_p){clickedState.state=DRILLUP;clickedState.node=[{virginNode:afAPI.getVisibleRoot()},_p];removeFn(_t);drawTreeFn.apply(_p,[algorithmAPI,dsStore,canvasMeasurement,rendererAPI])}target=target&&target.getParent()}};chart._intSR.resetTree=_resetTree=function resetTree(raiseEventFlag){var target=this,_p=target&&target.getParent(),_t,context=afAPI.context,stateContextId=CLICKEDSTATE,visibleState=VISIBLEROOT,stateContext=context.getInstance(stateContextId),clickedState=stateContext.get(visibleState)||{};chart.config.trackerConfig.length=0;chart.triggerKDTreePartioning();while(_p){_t=_p;_p=_p.getParent()}if(raiseEventFlag){chart.fireChartInstanceEvent("beforedrillup",{node:target,withoutHead:!attrs.showParent},UNDEF,(function(){if(_t){clickedState.state=DRILLUP;clickedState.node=[{virginNode:afAPI.getVisibleRoot()},_t];removeFn(_t);drawTreeFn.apply(_t,args);chart.fireChartInstanceEvent(DRILLUP,{node:target,sender:chart.fusionCharts,withoutHead:!attrs.showParent,drillUp:_backToParent,drillUpToTop:_resetTree})}}),(function(){chart.fireChartInstanceEvent("drillupcancelled",{node:target,withoutHead:!attrs.showParent})}))}else{if(_t){clickedState.state=DRILLUP;clickedState.node=[{virginNode:afAPI.getVisibleRoot()},_t];removeFn(_t);drawTreeFn.apply(_t,args)}}};return{click:function click(node,baseNode){var thisVNode=node.virginNode,eventName,parent,animationManager=chart.getFromEnv("animationManager"),target;chart.state=CLICK_STR;chart.fireChartInstanceEvent(plotClickEvt,extractEventData(node.virginNode));parent=thisVNode.getParent();if(!parent){return}if(thisVNode===baseNode){target=parent;chart.flushKDTree();eventName=DRILLUP}else{if(thisVNode.next){target=thisVNode;chart.flushKDTree();eventName=DRILLDOWN}else{target=parent;if(baseNode===target){eventName=UNDEF;return}eventName=DRILLDOWN}}eventName&&chart.fireChartInstanceEvent("before"+eventName,{node:target,withoutHead:!attrs.showParent},UNDEF,(function(){chart.config.trackerConfig.length=0;stateContext.set(visibleState,{node:node,state:eventName});removeFn.call(rendererAPI,target);setVisibleRoot(target);animationManager.setAnimationState("drill");chart.setState("drill",true);containerManager.draw();animationManager.onAnimationComplete((function(){chart.setState("drill",false)}));chart.fireChartInstanceEvent(eventName,{node:target,withoutHead:!attrs.showParent,drillUp:_backToParent,drillUpToTop:_resetTree})}),(function(){chart.fireChartInstanceEvent(eventName+"cancelled",{node:target,withoutHead:!attrs.showParent})}));chart.addJob("attachEventToBtns",(function(){chart._lastAttached.backToParent&&btns.back&&btns.back.removeEventListener("fc-click",chart._lastAttached.backToParent);chart._lastAttached.resetTree&&btns.home&&btns.home.removeEventListener("fc-click",chart._lastAttached.resetTree);chart._lastAttached.backToParent=_backToParent.bind(target);chart._lastAttached.resetTree=_resetTree.bind(target);btns.back&&btns.back.addEventListener("fc-click",chart._lastAttached.backToParent);btns.home&&btns.home.addEventListener("fc-click",chart._lastAttached.resetTree)}),_schedular.priorityList.kdTree);chart.resetSingleTracker()},mouseover:function mouseover(node){var evtData=extractEventData(node.virginNode);chart.fireChartInstanceEvent(plotRollOverEvt,evtData,UNDEF,UNDEF,(function(){chart.fireChartInstanceEvent(plotRollOverEvt+"cancelled",evtData)}))},mouseout:function mouseout(node){var evtData=extractEventData(node.virginNode);chart.fireChartInstanceEvent(plotRollOutEvt,extractEventData(node.virginNode),UNDEF,UNDEF,(function(){chart.fireChartInstanceEvent(plotRollOutEvt+"cancelled",evtData)}))}}}visibilityController=function(){var restOfTheTreeArr=[],nextVisibileTreeRoot,inProgress=false,attrVisible={visibility:"visible",opacity:1};return{controlPreAnimVisibility:function controlPreAnimVisibility(node,superNode){var rootNode,tempNode,itr,dfItr,nextNode,overAttr;if(!node){return}tempNode=node;while(true){tempNode=tempNode.getParent();if(!tempNode){break}rootNode=tempNode}itr=iterator(rootNode,{exception:node});dfItr=itr.df;while(true){nextNode=dfItr.next();if(!nextNode){break}overAttr=nextNode.overAttr||(nextNode.overAttr={});overAttr.visibility=HIDDEN_STR;restOfTheTreeArr.push(nextNode)}nextVisibileTreeRoot=superNode||node.getParent();inProgress=false;return restOfTheTreeArr},displayAll:function displayAll(node){var itr,overAttr,dfItr,nextNode;if(!node){return}itr=iterator(node.getParent()||node);dfItr=itr.df;while(true){nextNode=dfItr.next();if(!nextNode){break}overAttr=nextNode.overAttr||(nextNode.overAttr={});overAttr.visibility=VISIBLE_STR}nextVisibileTreeRoot=UNDEF;restOfTheTreeArr.length=0;inProgress=false},controlPostAnimVisibility:function controlPostAnimVisibility(){var textItem,dirtyNode,itr,dfItr,nextNode;if(inProgress){return}inProgress=true;if(!nextVisibileTreeRoot){return}itr=iterator(nextVisibileTreeRoot);dfItr=itr.df;while(true){nextNode=dfItr.next(maxDepth);if(!nextNode){break}if(nextNode.dirtyNode){dirtyNode=nextNode.dirtyNode;dirtyNode&&dirtyNode.plotItem.attr(attrVisible);textItem=dirtyNode&&dirtyNode.textItem;textItem&&textItem.label&&textItem.label.attr(attrVisible);textItem&&textItem.label&&textItem.highlightMask.attr(attrVisible)}}nextVisibileTreeRoot=UNDEF;restOfTheTreeArr.length=0}}}();afAPI.AbstractTreeMaker=AbstractTreeMaker;afAPI.iterator=iterator;afAPI.initConfigurationForlabel=initConfigurationForlabel;afAPI.context=context;afAPI.mapColorManager=mapColorManager;afAPI.abstractEventRegisterer=abstractEventRegisterer;afAPI.setMaxDepth=setMaxDepth;afAPI.getVisibleRoot=getVisibleRoot;afAPI.setVisibleRoot=setVisibleRoot;afAPI.visibilityController=visibilityController;return afAPI},algorithmFactoryCreator=function algorithmFactoryCreator(afAPI,algorithmFactory){var algo,AbstractTreeMaker=afAPI.AbstractTreeMaker,algorithm,treeMaker,tree,bucketIterationMode,depthIncrement,maxDepth;function postOrderTraversal(node){var children=node.getChildren(),childNode,sumOfvalues=0;for(var i=0;i<(children&&children.length);i++){childNode=children[i];postOrderTraversal(childNode);sumOfvalues+=childNode.getValue()||0}if(isNaN(node.value)){node.value=sumOfvalues}}algo={sliceanddice:{areaBaseCalculator:function areaBaseCalculator(horizontalPadding,verticalPadding){var sx=horizontalPadding,sy=verticalPadding;return function(node,posOffsetApplyFn,options){var parent,leftSibling,denominator,meta={},eHeight,eWidth,parentRect,textMargin=0,negSpacesY=0;if(!node){return}if(options){textMargin=options.textMargin||textMargin}negSpacesY=textMargin;parent=node.getParent();leftSibling=node.getSibling("left");if(parent){denominator=parent.getValue();parentRect=parent.rect;eHeight=parentRect.height-2*sy-negSpacesY;eWidth=parentRect.width-2*sx;meta.effectiveRect={height:eHeight,width:eWidth,x:parentRect.x+sx,y:parentRect.y+sy+negSpacesY};meta.effectiveArea=eHeight*eWidth;meta.ratio=node.getValue()/denominator;if(leftSibling){return posOffsetApplyFn.call(node,meta,leftSibling,parent)}meta.lastIsParent=true;return posOffsetApplyFn.call(node,meta,parent)}return null}},applyShadeFiltering:function applyShadeFiltering(bucketInstance,overrideEffect,rangeOutFn){bucketInstance.setRangeOutEffect(overrideEffect,rangeOutFn);this.applyShadeFiltering.reset=function(){bucketInstance.resetPointers()};return function(limits){bucketInstance.moveLowerShadePointer(limits.start);bucketInstance.moveHigherShadePointer(limits.end)}},alternateModeManager:function alternateModeManager(){return function(meta,lastPoint){var height,width,isDirectionVertical,dx,dy,cNode=this,baseArea=meta.effectiveArea,ratio=meta.ratio,childArea=baseArea*ratio,effectiveRect=meta.effectiveRect,lastRect=lastPoint.rect,lastIsParent=meta.lastIsParent;if(lastIsParent){dx=effectiveRect.x;dy=effectiveRect.y;height=effectiveRect.height;width=effectiveRect.width;isDirectionVertical=cNode.isDirectionVertical=true}else{height=effectiveRect.height+effectiveRect.y-(lastRect.height+lastRect.y);width=effectiveRect.width+effectiveRect.x-(lastRect.width+lastRect.x);isDirectionVertical=cNode.isDirectionVertical=!lastPoint.isDirectionVertical}if(isDirectionVertical){width=childArea/height;dx=dx!==UNDEF?dx:lastRect.x;dy=dy!==UNDEF?dy:lastRect.y+lastRect.height}else{height=childArea/width;dx=dx!==UNDEF?dx:lastRect.x+lastRect.width;dy=dy!==UNDEF?dy:lastRect.y}return{height:height,width:width,x:dx,y:dy}}},horizontalVerticalManager:function horizontalVerticalManager(slicingMode){var isVerticalSlicing=Boolean(slicingMode==="vertical");return function(meta,lastPoint){var height,width,isDirectionVertical,dx,dy,cNode=this,baseArea=meta.effectiveArea,ratio=meta.ratio,childArea=baseArea*ratio,effectiveRect=meta.effectiveRect,lastRect=lastPoint.rect,lastIsParent=meta.lastIsParent;if(lastIsParent){dx=effectiveRect.x;dy=effectiveRect.y;height=effectiveRect.height;width=effectiveRect.width;isDirectionVertical=cNode.isDirectionVertical=!lastPoint.isDirectionVertical}else{height=effectiveRect.height+effectiveRect.y-(lastRect.height+lastRect.y);width=effectiveRect.width+effectiveRect.x-(lastRect.width+lastRect.x);isDirectionVertical=cNode.isDirectionVertical=!arguments[2].isDirectionVertical}isDirectionVertical=isVerticalSlicing?isDirectionVertical:!isDirectionVertical;if(isDirectionVertical){if(height===0){height=effectiveRect.height;dx=dx!==UNDEF?dx:lastRect.x+lastRect.width;dy=dy!==UNDEF?dy:lastRect.y}width=childArea/height;dx=dx!==UNDEF?dx:lastRect.x;dy=dy!==UNDEF?dy:lastRect.y+lastRect.height}else{if(width===0){width=effectiveRect.width;dx=dx!==UNDEF?dx:lastRect.x;dy=dy!==UNDEF?dy:lastRect.y+lastRect.height}height=childArea/width;dx=dx!==UNDEF?dx:lastRect.x+lastRect.width;dy=dy!==UNDEF?dy:lastRect.y}return{height:height,width:width,x:dx,y:dy}}},drawTree:function drawTree(algorithmAPI,dsStore,canvasMeasurement,rendererAPI){var treeRoot=this,chart=dsStore.getFromEnv("chart"),config=chart.config||(chart.config={}),trackerConfig=config.trackerConfig||(config.trackerConfig=[]),numberFormatter=dsStore.getFromEnv("number-formatter"),btns=dsStore.getFromEnv("toolbarBtns"),drawRectFn=rendererAPI.drawRect,drawTextFn=rendererAPI.drawText,drawHotFn=rendererAPI.drawHot,xShift=canvasMeasurement.horizontalPadding,yShift=canvasMeasurement.verticalPadding,smartLabel=dsStore.getFromEnv("smartLabel"),lineHeight,labelPadding={x:5,y:5},iterator=afAPI.iterator,itr=iterator(treeRoot),dfItr=itr.df,baseNode,getNextAreaBase=algorithmAPI.areaBaseCalculator(xShift,yShift),attrs=dsStore.conf,highlightParentsOnHover=attrs.highlightParentsOnHover,getTextConf,context=afAPI.context,visController=afAPI.visibilityController,colorRange=dsStore.conf.colorRange,localColorProvider=afAPI.mapColorManager(attrs,colorRange),abstractEvtReg=afAPI.abstractEventRegisterer(algorithmAPI,dsStore,canvasMeasurement,rendererAPI),clickEvtImpl=abstractEvtReg.click,mouseoverEvtImpl=abstractEvtReg.mouseover,mouseoutEvtImpl=abstractEvtReg.mouseout,slicingMode=attrs.slicingMode,temp=slicingMode==="alternate"?"alternateModeManager":"horizontalVerticalManager",postNodeFetcher=algorithmAPI[temp](slicingMode),_baseNode,_intSR=chart._intSR,resetTree,backToParent,stateContextId=CLICKEDSTATE,visibleState=VISIBLEROOT,stateContext,clickedState,csNode;stateContext=context.getInstance(stateContextId);clickedState=stateContext.get(visibleState)||{};csNode=clickedState.node;if(clickedState.node&&clickedState.state){if(clickedState.state.toLowerCase()===DRILLUP){if(csNode instanceof Array){visController.controlPreAnimVisibility(csNode[0].virginNode,csNode[1])}else{visController.controlPreAnimVisibility(csNode.virginNode)}}else{visController.displayAll(clickedState.node.virginNode)}}lineHeight=attrs.parentLabelLineHeight;getTextConf=afAPI.initConfigurationForlabel(labelPadding,lineHeight,attrs);baseNode=dfItr.next(maxDepth=afAPI.setMaxDepth(treeRoot.getDepth()+depthIncrement));_baseNode=baseNode;while(_baseNode.getParent()){_baseNode=_baseNode.getParent()}!config.valuesset&&postOrderTraversal(_baseNode);config.valuesset=true;if(!attrs.showNavigationBar){if(_baseNode!==baseNode){btns.home.show();btns.back.show()}else{btns.home.hide();btns.back.hide()}}else{btns.home.hide();btns.back.hide()}smartLabel.useEllipsesOnOverflow(chart.config.useEllipsesWhenOverflow);smartLabel.setStyle(attrs._setStyle={fontSize:(attrs.labelFontSize||attrs.baseFontSize)+"px",fontFamily:attrs.labelFont||attrs.baseFont,lineHeight:1.2*(attrs.labelFontSize||attrs.baseFontSize)+"px"});backToParent=_intSR.backToParent;resetTree=_intSR.resetTree;chart.addJob("attachEventToBtns",(function(){chart._lastAttached.backToParent&&btns.back&&btns.back.removeEventListener("fc-click",chart._lastAttached.backToParent);chart._lastAttached.resetTree&&btns.home&&btns.home.removeEventListener("fc-click",chart._lastAttached.resetTree);chart._lastAttached.backToParent=backToParent.bind(baseNode);chart._lastAttached.resetTree=resetTree.bind(baseNode);btns.back&&btns.back.addEventListener("fc-click",chart._lastAttached.backToParent);btns.home&&btns.home.addEventListener("fc-click",chart._lastAttached.resetTree)}),_schedular.priorityList.kdTree);(function rec(node,drawingArea){var nextNode,_rect,_textRect,hotItem,labelItem,highlightItem,textItem,nodeDrawingArea,rect,textRect,textConfObj,textConf,options={},label,plotItem,plotDetails={},evtFns={},hoverContextPointerName=HOVER,cssConf={},colorDimension=_lib.BLANKSTRING,formattedValue,formattedsValue;if(!node||isNaN(node.value)||typeof node.value==="undefined"){return}formattedValue=numberFormatter.yAxis(node.getValue());formattedsValue=numberFormatter.sYAxis(node.getColorValue());node.setPath();_rect=node.rect||{};_textRect=node.textRect||{};rect=node.rect={};textRect=node.textRect={};rect.width=drawingArea.width;rect.height=drawingArea.height;rect.x=drawingArea.x;rect.y=drawingArea.y;cssConf=localColorProvider(node,UNDEF,dsStore.conf);plotItem=node.plotItem;if(plotItem){rendererAPI.graphicPool(true,"plotItem",plotItem,_rect)}node.__props||(node.__props={});node.__props.curr=Object.assign({},rect);node.__props.node=Object.assign({},node);plotItem=node.plotItem=drawRectFn(rect,Object.assign({},cssConf,(node.getColorValue()||node.getColorValue()===0)&&{fill:node.presentColor}||{}),_rect,node.overAttr,node);node.__props.prev=Object.assign({},rect);node.cssConf=cssConf;textConfObj=getTextConf(node,rect);textConf=textConfObj.conf;options.textMargin=textConf.rectShiftY;textRect=node.textRect=textConf.textRect;label=smartLabel.getSmartText(textConf.label,textRect.width,textRect.height).text;node.plotItem=plotItem;labelItem=node.labelItem;if(labelItem){highlightItem=node.highlightItem;rendererAPI.graphicPool(true,"labelItem",labelItem,_rect);rendererAPI.graphicPool(true,"highlightItem",highlightItem,_rect)}else{_textRect=_textRect||{}}textItem=drawTextFn(label,textRect,{textAttrs:textConfObj.attr,highlightAttrs:textConfObj.highlight},_textRect,node.overAttr,node);node.labelItem=textItem.label;node.highlightItem=textItem.highlightMask;plotDetails.virginNode=node;plotDetails.plotItem=plotItem;plotDetails.textItem=textItem;plotDetails.virginNode.dirtyNode=plotDetails;if(node.getColorValue()){colorDimension=attrs.tooltipSeparationCharacter+formattedsValue}if(attrs.showTooltip){plotDetails.toolText=(0,_lib.parseTooltext)(attrs.plotToolText,[1,2,3,119,122],{label:node.getLabel(),formattedValue:formattedValue,formattedsValue:formattedsValue},{value:node.getValue(),svalue:node.getColorValue()})||node.getLabel()+attrs.tooltipSeparationCharacter+formattedValue+colorDimension}else{plotDetails.toolText=_lib.BLANKSTRING}plotDetails.rect=rect;evtFns.hover=[function(forcedTracker){var elem=this,parentElem,targetElement,virginNode,hoverContext,css,maskRgba,hoverMaskAlpha=60;hoverContext=context.getInstance(hoverContextPointerName);virginNode=elem.virginNode;if(highlightParentsOnHover&&!virginNode.next){parentElem=virginNode.getParent();targetElement=parentElem||virginNode}else{targetElement=elem.virginNode}hoverContext.set("element",targetElement);css=targetElement.cssConf;maskRgba=(0,_lib.convertColor)((0,_lib.getLightColor)(css.fill,80),hoverMaskAlpha);forcedTracker.attr({fill:maskRgba});mouseoverEvtImpl(this)}.bind(plotDetails),function(tracker){var hoverContext,targetElement,fill,unmaskRgba,hoverMaskAlpha=0;hoverContext=context.getInstance(hoverContextPointerName);targetElement=hoverContext.get("element")||{};fill=targetElement.cssConf&&targetElement.cssConf.fill;unmaskRgba=(0,_lib.convertColor)(fill||"#fff",hoverMaskAlpha);tracker.attr({fill:unmaskRgba});mouseoutEvtImpl(this)}.bind(plotDetails)];evtFns.tooltip=[plotDetails.toolText];evtFns.click=[function(){clickEvtImpl(this,baseNode)}.bind(plotDetails)];hotItem=node.hotItem;if(hotItem){rendererAPI.graphicPool(true,"hotItem",hotItem,_rect)}trackerConfig.push({node:node,key:"hotItem",plotDetails:plotDetails,evtFns:evtFns,callback:drawHotFn});nextNode=dfItr.next(maxDepth);nodeDrawingArea=getNextAreaBase(nextNode,postNodeFetcher,options);rec(nextNode,nodeDrawingArea)})(baseNode,canvasMeasurement)}},squarified:{orderNodes:function orderNodes(){return this.sort((function(m,n){return parseFloat(m.value,10)<parseFloat(n.value,10)?1:-1}))},areaBaseCalculator:function areaBaseCalculator(horizontalPadding,verticalPadding){var sx=horizontalPadding,sy=verticalPadding;return function(nodes,posOffsetApplyFn,options){var parent,meta={},eHeight,eWidth,textMargin=0,negSpacesY=0,anyNode,parentRect;if(!nodes||nodes.length===0){return}if(options){textMargin=options.textMargin||textMargin}negSpacesY=textMargin;anyNode=nodes[0];parent=anyNode.getParent();if(parent){parentRect=parent.rect;eHeight=parentRect.height-2*sy-negSpacesY;eWidth=parentRect.width-2*sx;meta.effectiveRect={height:eHeight,width:eWidth,x:parentRect.x+sx,y:parentRect.y+sy+negSpacesY};meta.effectiveArea=eHeight*eWidth;return posOffsetApplyFn.call(anyNode,meta,parent)}return null}},layoutManager:function(){var RowLayout=function(){function RowLayout(root,totalValue){this.totalValue=totalValue;this._rHeight=root.height;this._rWidth=root.width;this._rx=root.x;this._ry=root.y;this._rTotalArea=root.height*root.width;this.nodes=[];this._prevAR=UNDEF;if(this._rHeight<this._rWidth){this._hSegmented=true}}var _proto3=RowLayout.prototype;_proto3.addNode=function addNode(nodeObj){var node=nodeObj,totalArea=this._rTotalArea,area,ratio,width,height,i,len,length,snVal,snArea,snHeight,snWidth,rect,_hSegmented=this._hSegmented,_x=this._rx,_y=this._ry,_nextX,_nextY,_rect,remainingHeight,remainingWidth,maxSide,minSide,aspectRatio,valueSoFar=0,cRect;this.nodes.push(node);for(i=0,length=this.nodes.length;i<length;i++){valueSoFar+=parseFloat(this.nodes[i].getValue(),10)}ratio=valueSoFar/this.totalValue;area=totalArea*ratio;if(_hSegmented){height=this._rHeight;width=area/height;_nextX=_x+width;_nextY=_y;remainingHeight=this._rHeight;remainingWidth=this._rWidth-width}else{width=this._rWidth;height=area/width;_nextX=_x;_nextY=_y+height;remainingHeight=this._rHeight-height;remainingWidth=this._rWidth}for(i=0,len=this.nodes.length;i<len;i++){node=this.nodes[i];snVal=node.getValue();snArea=snVal/valueSoFar*area;node.hRect=node.rect||{};node._hRect=node._rect||{};rect=node.rect={};if(_hSegmented){rect.width=snWidth=width;rect.height=snHeight=snArea/snWidth;rect.x=_x;rect.y=_y;_y+=snHeight}else{rect.height=snHeight=height;rect.width=snWidth=snArea/snHeight;rect.x=_x;rect.y=_y;_x+=snWidth}maxSide=Math.max(rect.height,rect.width);minSide=Math.min(rect.height,rect.width);aspectRatio=maxSide/minSide;!isFinite(aspectRatio)&&(aspectRatio=0);node.aspectRatio=aspectRatio}if(this.nodes.length>1){if(this.prevAR<node.aspectRatio){this.nodes.pop().rect={};for(i=0,length=this.nodes.length;i<length;i++){if(length===1&&this.nodes[i].firstPassed){this.nodes[i].rect=this.nodes[i]._hRect}else{this.nodes[i].rect=this.nodes[i].hRect}_rect=this.nodes[i]._rect={};cRect=this.nodes[i].rect;_rect.width=cRect.width;_rect.height=cRect.height;_rect.x=cRect.x;_rect.y=cRect.y}return false}}else{if(node){_rect=node._rect={};cRect=node.rect;_rect.width=cRect.width;_rect.height=cRect.height;_rect.x=cRect.x;_rect.y=cRect.y;node.firstPassed=true}}this.prevAR=node.aspectRatio;this.height=height;this.width=width;this.getNextLogicalDivision=function(){return{height:remainingHeight,width:remainingWidth,x:_nextX,y:_nextY}};return node};return RowLayout}();return{RowLayout:RowLayout}}(),applyShadeFiltering:function applyShadeFiltering(bucketInstance,overrideEffect,rangeOutFn){bucketInstance.setRangeOutEffect(overrideEffect,rangeOutFn);this.applyShadeFiltering.reset=function(){bucketInstance.resetPointers()};return function(limits){bucketInstance.moveLowerShadePointer(limits.start);bucketInstance.moveHigherShadePointer(limits.end)}},drawTree:function drawTree(algorithmAPI,dsStore,canvasMeasurement,rendererAPI){var treeRoot=this,chart=dsStore.getFromEnv("chart"),config=dsStore.getFromEnv("chartConfig"),trackerConfig=config.trackerConfig||(config.trackerConfig=[]),numberFormatter=dsStore.getFromEnv("number-formatter"),btns=dsStore.getFromEnv("toolbarBtns"),labelPadding={x:5,y:5},lineHeight,xShift=canvasMeasurement.horizontalPadding,yShift=canvasMeasurement.verticalPadding,getNextAreaBase=algorithmAPI.areaBaseCalculator(xShift,yShift),RowLayout=algorithmAPI.layoutManager.RowLayout,smartLabel=dsStore.getFromEnv("smartLabel"),drawRectFn=rendererAPI.drawRect,drawTextFn=rendererAPI.drawText,drawHotFn=rendererAPI.drawHot,iterator=afAPI.iterator,itr=iterator(treeRoot),bfItr=itr.bf,baseNode,attrs=dsStore.conf,highlightParentsOnHover=attrs.highlightParentsOnHover,getTextConf,context=afAPI.context,colorRange=dsStore.conf.colorRange,localColorProvider=afAPI.mapColorManager(attrs,colorRange),abstractEvtReg=afAPI.abstractEventRegisterer(algorithmAPI,dsStore,canvasMeasurement,rendererAPI),clickEvtImpl=abstractEvtReg.click,mouseoverEvtImpl=abstractEvtReg.mouseover,mouseoutEvtImpl=abstractEvtReg.mouseout,_baseNode,_intSR=chart._intSR,backToParent,resetTree,visController=afAPI.visibilityController,stateContextId=CLICKEDSTATE,visibleState=VISIBLEROOT,stateContext,clickedState,csNode;stateContext=context.getInstance(stateContextId);clickedState=stateContext.get(visibleState)||{};csNode=clickedState.node;if(clickedState.node&&clickedState.state){if(clickedState.state.toLowerCase()===DRILLUP){if(csNode instanceof Array){visController.controlPreAnimVisibility(csNode[0].virginNode,csNode[1])}else{visController.controlPreAnimVisibility(csNode.virginNode)}}else{visController.displayAll(clickedState.node.virginNode)}}lineHeight=attrs.parentLabelLineHeight;getTextConf=afAPI.initConfigurationForlabel(labelPadding,lineHeight,attrs);baseNode=bfItr.next(maxDepth=afAPI.setMaxDepth(treeRoot.getDepth()+depthIncrement));_baseNode=baseNode;while(_baseNode.getParent()){_baseNode=_baseNode.getParent()}!config.valuesset&&postOrderTraversal(_baseNode);config.valuesset=true;if(!attrs.showNavigationBar){if(_baseNode!==baseNode){btns.home.show();btns.back.show()}else{btns.home.hide();btns.back.hide()}}else{btns.home.hide();btns.back.hide()}smartLabel.useEllipsesOnOverflow(chart.config.useEllipsesWhenOverflow);smartLabel.setStyle(attrs._setStyle={fontSize:(attrs.labelFontSize||attrs.baseFontSize)+"px",fontFamily:attrs.labelFont||attrs.baseFont,lineHeight:1.2*(attrs.labelFontSize||attrs.baseFontSize)+"px"});backToParent=_intSR.backToParent;resetTree=_intSR.resetTree;chart.addJob("attachEventToBtns",(function(){chart._lastAttached.backToParent&&btns.back&&btns.back.removeEventListener("fc-click",chart._lastAttached.backToParent);chart._lastAttached.resetTree&&btns.home&&btns.home.removeEventListener("fc-click",chart._lastAttached.resetTree);chart._lastAttached.backToParent=backToParent.bind(baseNode);chart._lastAttached.resetTree=resetTree.bind(baseNode);btns.back&&btns.back.addEventListener("fc-click",chart._lastAttached.backToParent);btns.home&&btns.home.addEventListener("fc-click",chart._lastAttached.resetTree)}),_schedular.priorityList.kdTree);(function rec(node,drawingArea){var rect,_rect={},highlightItem,hotItem,labelItem,_textRect,textRect,nextNodes,textItem,index,length,totalValPlotted=0,bfsQueue,bfsNode,plotItem,textConf,label,options={},textConfObj,plotDetails={},evtFns={},hoverContextPointerName=HOVER,cssConf={},colorDimension=_lib.BLANKSTRING,formattedValue,formattedsValue;if(!node||!node.value){return}formattedValue=numberFormatter.yAxis(node.getValue());formattedsValue=numberFormatter.sYAxis(node.getColorValue());node.setPath();rect=node.__initRect;if(rect){_rect.x=rect.x;_rect.y=rect.y;_rect.width=rect.width;_rect.height=rect.height}_textRect=node.textRect||{};rect=node.rect=node.__initRect={};textRect=node.textRect={};rect.width=drawingArea.width;rect.height=drawingArea.height;rect.x=drawingArea.x;rect.y=drawingArea.y;cssConf=localColorProvider(node,UNDEF,dsStore.conf);plotItem=node.plotItem;if(plotItem){rendererAPI.graphicPool(true,"plotItem",plotItem,_rect)}node.__props||(node.__props={});node.__props.curr=Object.assign({},rect);node.__props.node=Object.assign({},node);plotItem=node.plotItem=drawRectFn(rect,Object.assign({},cssConf,(node.getColorValue()||node.getColorValue()===0)&&{fill:node.presentColor}||{}),_rect,node.overAttr,node);node.__props.prev=Object.assign({},rect);node.cssConf=cssConf;textConfObj=getTextConf(node,rect);textConf=textConfObj.conf;options.textMargin=textConf.rectShiftY;textRect=node.textRect=textConf.textRect;label=smartLabel.getSmartText(textConf.label,textRect.width,textRect.height).text;labelItem=node.labelItem;if(labelItem){highlightItem=node.highlightItem;rendererAPI.graphicPool(true,"labelItem",labelItem,_rect);rendererAPI.graphicPool(true,"highlightItem",highlightItem,_rect)}else{_textRect=_textRect||{}}textItem=drawTextFn(label,textRect,{textAttrs:textConfObj.attr,highlightAttrs:textConfObj.highlight},_textRect,node.overAttr,node);node.labelItem=textItem.label;node.highlightItem=textItem.highlightMask;node.plotItem=plotItem;plotDetails.virginNode=node;plotDetails.plotItem=plotItem;plotDetails.textItem=textItem;plotDetails.virginNode.dirtyNode=plotDetails;if(node.getColorValue()){colorDimension=attrs.tooltipSeparationCharacter+formattedsValue}if(attrs.showTooltip){plotDetails.toolText=(0,_lib.parseTooltext)(attrs.plotToolText,[1,2,3,119,122],{label:node.getLabel(),formattedValue:formattedValue,formattedsValue:formattedsValue},{value:node.getValue(),svalue:node.getColorValue()})||node.getLabel()+attrs.tooltipSeparationCharacter+formattedValue+colorDimension}else{plotDetails.toolText=_lib.BLANKSTRING}plotDetails.rect=rect;evtFns.hover=[function(targetElementNew){var elem=this,parentElem,targetElement,virginNode,hoverContext,css,maskRgba,hoverMaskAlpha=60;hoverContext=context.getInstance(hoverContextPointerName);virginNode=elem.virginNode;if(highlightParentsOnHover&&!virginNode.next){parentElem=virginNode.getParent();targetElement=parentElem||virginNode}else{targetElement=elem.virginNode}hoverContext.set("element",targetElement);css=targetElement.cssConf;maskRgba=(0,_lib.convertColor)(css.fill&&(0,_lib.getLightColor)(css.fill,80),hoverMaskAlpha);targetElementNew.attr({fill:maskRgba});mouseoverEvtImpl(this)}.bind(plotDetails),function(targetElementNew){var hoverContext,targetElement,fill,unmaskRgba,hoverMaskAlpha=0;hoverContext=context.getInstance(hoverContextPointerName);targetElement=hoverContext.get("element")||{};fill=targetElement.cssConf&&targetElement.cssConf.fill;unmaskRgba=(0,_lib.convertColor)(fill||"#fff",hoverMaskAlpha);targetElementNew.attr({fill:unmaskRgba});mouseoutEvtImpl(this)}.bind(plotDetails)];evtFns.tooltip=[plotDetails.toolText];evtFns.click=[function(){clickEvtImpl(this,baseNode)}.bind(plotDetails)];hotItem=node.hotItem;if(hotItem){rendererAPI.graphicPool(true,"hotItem",hotItem,_rect)}trackerConfig.push({node:node,key:"hotItem",plotDetails:plotDetails,evtFns:evtFns,callback:drawHotFn});nextNodes=maxDepth!==UNDEF?node.getDepth()>=maxDepth?UNDEF:node.getChildren():node.getChildren();if(!nextNodes){return}bfsQueue=getNextAreaBase(nextNodes,(function(meta,parent){var row,nodeLimit,nodeIndex=0,node,layout,nextDiv,queue=[];row=new RowLayout({width:meta.effectiveRect.width,height:meta.effectiveRect.height,x:meta.effectiveRect.x,y:meta.effectiveRect.y},parent.getValue());nodeLimit=nextNodes.length;while(true){if(nodeIndex++===nodeLimit){break}node=nextNodes[nodeIndex-1];layout=row.addNode(node);if(layout===false){nextDiv=row.getNextLogicalDivision();row=new RowLayout(nextDiv,parent.getValue()-totalValPlotted);nodeIndex--}else{totalValPlotted+=parseFloat(node.getValue(),10);queue.push(node)}}return queue}),options);for(index=0,length=bfsQueue.length;index<length;index++){bfsNode=bfsQueue[index];rec(bfsNode,bfsNode.rect)}})(baseNode,canvasMeasurement)}}};var TreeMaker=function(_AbstractTreeMaker){(0,_inheritsLoose2.default)(TreeMaker,_AbstractTreeMaker);function TreeMaker(){return _AbstractTreeMaker.apply(this,arguments)||this}TreeMaker.getName=function getName(){return"TreeMaker"};var _proto4=TreeMaker.prototype;_proto4.order=function order(children){var algorithmAPI=algo[algorithm],orderNodeFn=algorithmAPI.orderNodes;if(orderNodeFn){return orderNodeFn.apply(children,[algorithmAPI])}return children};return TreeMaker}(AbstractTreeMaker);function init(algoName,flag,permitterDepth){algorithm=algoName;bucketIterationMode=flag;depthIncrement=afAPI.setMaxDepth(permitterDepth);return algo[algorithm]}function applyShadeFiltering(css,shadeOutFN){var algorithmAPI=algo[algorithm],args,shadeFilter;shadeFilter=algorithmAPI.applyShadeFiltering(treeMaker.getBucket(),css,shadeOutFN);return function(limits){args=Array.prototype.slice.call(arguments,0);args.unshift(limits);shadeFilter.apply(treeMaker.getBucket(),args)}}function makeTree(nodes,cleansingFn,update){var tempTree;treeMaker=new TreeMaker(nodes,bucketIterationMode,cleansingFn);tempTree=treeMaker.get();if(update!==false){tree=tempTree}afAPI.setVisibleRoot(tempTree);return tempTree}function plotTree(){var algorithmAPI=algo[algorithm],args;algorithmFactory.realTimeUpdate=realTimeUpdate.apply(this,arguments);args=Array.prototype.slice.call(arguments,0);args.unshift(algorithmAPI);algorithmAPI.drawTree.apply(afAPI.getVisibleRoot(),args)}function realTimeUpdate(){var rendererAPI,args,algorithmAPI=algo[algorithm];args=Array.prototype.slice.call(arguments,0);args.unshift(algorithmAPI);rendererAPI=args.slice(-1)[0];return function(){var _args=Array.prototype.slice.call(arguments,0),_getCleanValue=_args.shift(),modifier=_args.shift(),api=treeOpt(tree,(function(visibleRoot){algorithmAPI.drawTree.apply(visibleRoot||tree,args)}),rendererAPI,_getCleanValue);api[modifier].apply(this,_args)}}function setTreeBase(base){return base&&(tree=base)}function plotOnCanvas(nodes,cleansingFn){tree=makeTree(nodes,cleansingFn);return plotTree}algorithmFactory.init=init;algorithmFactory.plotOnCanvas=plotOnCanvas;algorithmFactory.applyShadeFiltering=applyShadeFiltering;algorithmFactory.setTreeBase=setTreeBase;algorithmFactory.realTimeUpdate=realTimeUpdate;algorithmFactory.makeTree=makeTree;return algorithmFactory},treeOpt=function treeOpt(baseNode,drawTreeFn,rendererAPI,_getCleanValue){var change;function getNode(path){var childNode,index=0,parentNode=baseNode;if(!path.length){return baseNode}while(parentNode){childNode=searchSibling.call(parentNode,path[index]);if(index===path.length-1&&childNode){change=childNode.getValue();return childNode}parentNode=childNode;index+=1}}function searchSibling(label){var index,node,sibling,parentNode=this,childrenArr=parentNode.getChildren()||[],len=childrenArr.length,sanitized=function sanitized(str){return str.toLowerCase().trim()};for(index=0;index<len;index+=1){sibling=childrenArr[index];if(sanitized(sibling.label)===sanitized(label)){node=sibling;break}}return node}return{deleteData:function deleteData(path,draw){var afAPI,targetNode=getNode(path),itr=afAPI.iterator(targetNode),dfItr=itr.df,parentNode=targetNode&&targetNode.getParent(),leftSiblingCount=targetNode&&targetNode.getSiblingCount("left"),childrenArr=parentNode&&parentNode.getChildren(),visibleRoot=afAPI.getVisibleRoot();if(!targetNode||!parentNode){return}childrenArr.splice(leftSiblingCount,1);if(targetNode===visibleRoot){visibleRoot=targetNode.getParent()||visibleRoot}while(targetNode){rendererAPI.disposeItems(targetNode);targetNode=dfItr.next()}while(parentNode){parentNode.setValue(-change,true);parentNode=parentNode.getParent()}if(draw){drawTreeFn(visibleRoot)}},addData:function addData(nodes,path,draw,index){var afAPI,algorithmFactory,newNode,tree,parentNode,oldValue,change=0,incremental=true,visibleRoot=afAPI.getVisibleRoot();while(nodes.length){newNode=nodes.pop();tree=algorithmFactory.makeTree(newNode,_getCleanValue,false);change=tree.getValue();parentNode=getNode(path||[]);if(!parentNode){continue}if(!parentNode.getChildren()){oldValue=parentNode.getValue();incremental=false}parentNode.addChildren(tree,index);while(parentNode){parentNode.setValue(change,incremental);if(oldValue){change-=oldValue;oldValue=UNDEF;incremental=true}parentNode=parentNode.getParent()}}if(draw){drawTreeFn(visibleRoot)}}}},containerManagerCreator=function containerManagerCreator(afAPI,containerManager){var datasetDefStore,drawTreeFn,metaInf,dsConf,rendererAPI,updateContainers,forceCSS=false,drawNavigation=function drawNavigation(drawingAreaMeasurement,isStacked){var navigationPath,len,colorRange=dsConf.colorRange,localColorProvider=afAPI.mapColorManager(dsConf,colorRange,true),setNavigationPath=function setNavigationPath(isStacked){var visibleRoot=getVisibleRoot();if(!isStacked){navigationPath=dsConf.navigationBarNodes=visibleRoot.getPath()||[].concat(visibleRoot)}else{navigationPath=visibleRoot.getChildren()}navigationPath.pop();len=navigationPath.length},segmentRectangle=function(){var allocatedWidth;return{get:function get(drawingAreaMeasurement,pos,isStacked){var segmentRect={y:drawingAreaMeasurement.startY,height:drawingAreaMeasurement.effectiveHeight},node=navigationPath[pos],parentNode=node.getParent();if(allocatedWidth){segmentRect._x=drawingAreaMeasurement.startX+drawingAreaMeasurement.effectiveWidth;segmentRect._width=0}else{segmentRect._x=drawingAreaMeasurement.startX;segmentRect._width=drawingAreaMeasurement.effectiveWidth}segmentRect.x=allocatedWidth||(allocatedWidth=drawingAreaMeasurement.startX);if(!isStacked){allocatedWidth+=segmentRect.width=drawingAreaMeasurement.effectiveWidth/len}else{allocatedWidth+=segmentRect.width=drawingAreaMeasurement.effectiveWidth*(node.getValue()/parentNode.getValue())}return segmentRect},resetAllocation:function resetAllocation(){allocatedWidth=UNDEF}}}(),fetchFlatnessPosition=function fetchFlatnessPosition(startIndex,endIndex){var shape;if(endIndex===1){shape=BOTH}else if(startIndex===0){shape=LEFT}else if(startIndex<endIndex-1){shape=NO}else{shape=RIGHT}return shape},labelPadding={x:5,y:5},lineHeight=dsConf.parentLabelLineHeight,getTextConf=afAPI.initConfigurationForlabel(labelPadding,lineHeight,dsConf),drawPathFn=rendererAPI.drawPolyPath,drawTextFn=rendererAPI.drawText,drawHotFn=rendererAPI.drawHot,navigationMapper={navigationHistory:{path:"polyPathItem",label:"pathlabelItem",highlightItem:"pathhighlightItem",hotItem:"pathhotItem"}},chart=datasetDefStore.getFromEnv("chart"),trackerConfig=chart.config.trackerConfig,smartLabel=datasetDefStore.getFromEnv("smartLabel"),clickFn=function clickFn(node){return function(){var context=afAPI.context,stateContextId=CLICKEDSTATE,visibleState=VISIBLEROOT,animationManager=chart.getFromEnv("animationManager"),stateContext=context.getInstance(stateContextId),clickedState=stateContext.get(visibleState)||{};trackerConfig.length=0;clickedState.state=DRILLUP;clickedState.node=[{virginNode:afAPI.getVisibleRoot()},node];rendererAPI.disposeChild(node);animationManager.setAnimationState("drill");chart.setState("drill",true);containerManager.draw([node,node,node]);animationManager.onAnimationComplete((function(){chart.setState("drill",false)}));chart.resetSingleTracker()}},hoverInFn=function hoverInFn(){return function(){}},hoverOutFn=function hoverOutFn(){return function(){}},toolTipFn=function toolTipFn(node){return dsConf.showTooltip?node.getLabel():_lib.BLANKSTRING},i,offset,pathObj,node,segmentRect,textConfObj,label,textConf,pathText,_setStyle=dsConf._setStyle,textRect,navigationRatio=_heightProportion.get().navigationBar,verticalPadding=2*_getVerticalPadding("navigationBar"),navigationHeight=navigationRatio*metaInf.effectiveHeight,logicalFontSize=Math.min(navigationHeight-(verticalPadding+6),_setStyle.fontSize.replace(/\D+/g,"")),fontSizeStr=logicalFontSize+"px";navigationMapper.stacked={path:STACKED_STR+navigationMapper.navigationHistory.path,label:STACKED_STR+navigationMapper.navigationHistory.label,highlightItem:STACKED_STR+navigationMapper.navigationHistory.highlightItem,hotItem:STACKED_STR+navigationMapper.navigationHistory.hotItem};segmentRectangle.resetAllocation();setNavigationPath(isStacked);smartLabel.setStyle({fontSize:fontSizeStr,lineHeight:fontSizeStr});for(i=0;i<len;i+=1){node=navigationPath[i];segmentRect=segmentRectangle.get(drawingAreaMeasurement,i,isStacked);offset=(pathObj=createNavigationPath(segmentRect,isStacked?"both":fetchFlatnessPosition(i,len),UNDEF,node)).offset;node[navigationMapper[isStacked?"stacked":"navigationHistory"].path]=drawPathFn(pathObj,localColorProvider(node,true,dsConf),node);textConfObj=getTextConf(node,segmentRect,true);textConf=textConfObj.conf;textRect=textConf.textRect;textRect.width-=2*offset;textRect.y=segmentRect.y+segmentRect.height/2;label=smartLabel.getSmartText(textConf.label,textRect.width,Math.max(logicalFontSize,textRect.height)).text;pathText=drawTextFn(label,textRect,{textAttrs:textConfObj.attr,highlightAttrs:textConfObj.highlight},{y:segmentRect.height/10,"font-size":dsConf._setStyle.fontSize,"font-family":dsConf._setStyle.fontFamily},(isStacked?"stacked":"")+"path",node);node[navigationMapper[isStacked?"stacked":"navigationHistory"].label]=pathText.label;node[navigationMapper[isStacked?"stacked":"navigationHistory"].highlightItem]=pathText.highlightMask;trackerConfig.push({node:node,key:navigationMapper[isStacked?"stacked":"navigationHistory"].hotItem,plotDetails:{rect:segmentRect},evtFns:{click:[clickFn(node,isStacked)],hover:[hoverInFn(node),hoverOutFn()],tooltip:[toolTipFn(node)]},callback:drawHotFn})}},getDrawFn=function getDrawFn(type){var drawFn={treeMap:drawTree,navigationBar:drawNavigation,stackedNavigation:drawStackedNavigation};return drawFn[type]},_heightProportion=function(){var heightProportion={treeMap:1,navigationBar:0,stackedNavigation:0};return{set:function set(hasNavigationBar){var singleLineRatio,navigationRatio=(0,_lib.pluckNumber)(dsConf.navigationBarHeightRatio,dsConf.navigationBarHeight/metaInf.effectiveHeight,.15),maxFontSize=dsConf.labelFontSize?Math.max(dsConf.labelFontSize,dsConf.baseFontSize):dsConf.baseFontSize,verticalPadding=2*_getVerticalPadding("navigationBar");singleLineRatio=(6+maxFontSize+verticalPadding)/metaInf.effectiveHeight;navigationRatio=Math.max(singleLineRatio,navigationRatio);if(navigationRatio<.05){navigationRatio=.05}else if(navigationRatio>.4){navigationRatio=.4}dsConf.navigationBarHeightRatio=navigationRatio;if(hasNavigationBar){heightProportion={treeMap:1-navigationRatio,navigationBar:navigationRatio,stackedNavigation:0}}else{heightProportion={treeMap:1,navigationBar:0,stackedNavigation:0}}},get:function get(){return heightProportion}}}(),allocatedHeightProp=0,_getVerticalPadding=function _getVerticalPadding(type){var verticalPadding=dsConf.verticalPadding,plotBorderThickness=dsConf.plotBorderThickness,navigationBarBorderThickness=dsConf.navigationBarBorderThickness;return verticalPadding+(type==="navigationBar"?navigationBarBorderThickness:plotBorderThickness)},getDrawingArea=function getDrawingArea(type){var width=metaInf.effectiveWidth,height=metaInf.effectiveHeight,verticalPadding=_getVerticalPadding(type),heightProportion=_heightProportion.get(),requiredHeightProp=heightProportion[type];if(allocatedHeightProp>=1){allocatedHeightProp=0}allocatedHeightProp+=requiredHeightProp;return{effectiveHeight:Math.round(requiredHeightProp*height*100)/100-verticalPadding,effectiveWidth:width,startX:metaInf.startX,startY:metaInf.startY+verticalPadding+Math.round((allocatedHeightProp-requiredHeightProp)*height*100)/100}};var Container=function(){function Container(){}var _proto5=Container.prototype;_proto5.init=function init(configuration,drawFn){var container=this,containerConf=container.conf||(container.conf={});containerConf.name=configuration.name;container.setDrawingArea(configuration.drawingAreaMeasurement);container.draw=container.draw(drawFn)};_proto5.setDrawingArea=function setDrawingArea(drawingAreaMeasurement){var containerConf=this.conf;containerConf.drawingAreaMeasurement=drawingAreaMeasurement};_proto5.draw=function draw(drawFn){return function(){var containerConf=this.conf,drawingAreaMeasurement=containerConf.drawingAreaMeasurement;if(drawingAreaMeasurement.effectiveHeight>0){drawFn(containerConf.drawingAreaMeasurement)}}};_proto5.eventCallback=function eventCallback(){};return Container}();function init(){var type,containersArr=["navigationBar","treeMap","stackedNavigation"],args=Array.prototype.slice.call(arguments,0);datasetDefStore=args[0];metaInf=args[1];dsConf=datasetDefStore.conf;rendererAPI=args[2];drawTreeFn=args[4];if(updateContainers.get().length>=containersArr.length){updateContainers.set()}while(containersArr.length){type=containersArr.shift();updateContainers.set({type:type,drawFn:getDrawFn(type),drawingArea:getDrawingArea(type)})}}function getVisibleRoot(){return afAPI.getVisibleRoot()}function drawTree(drawingAreaMeasurement){var _temp=dsConf.plotBorderThickness;if(forceCSS){dsConf.plotBorderThickness=0}drawTreeFn.apply(afAPI.getVisibleRoot(),[datasetDefStore,{width:drawingAreaMeasurement.effectiveWidth,height:drawingAreaMeasurement.effectiveHeight,x:drawingAreaMeasurement.startX,y:drawingAreaMeasurement.startY,horizontalPadding:dsConf.horizontalPadding,verticalPadding:dsConf.verticalPadding},rendererAPI]);dsConf.plotBorderThickness=_temp}function createNavigationPath(rect,shape,_offset){var x=rect.x,y=rect.y,width=rect.width,height=rect.height,centerHalfAngle=dsConf.seperatorAngle/2,init=["M",x,y],offset=(0,_lib.pluckNumber)(centerHalfAngle?height/2*(1-Math.tan(centerHalfAngle)):_offset,15),_init=["M",rect._x,y],pathFetcher=function pathFetcher(width){return{both:["h",width,"v",height/2,"v",height/2,"h",-width,"v",-height/2,"v",-height/2],right:["h",width,"v",height/2,"v",height/2,"h",-width,"l",offset,-height/2,"l",-offset,-height/2],no:["h",width,"l",offset,height/2,"l",-offset,height/2,"h",-width,"l",offset,-height/2,"l",-offset,-height/2],left:["h",width,"l",offset,height/2,"l",-offset,height/2,"h",-width,"v",-height/2,"v",-height/2]}};return{path:init.concat(pathFetcher(width)[shape]),_path:_init.concat(pathFetcher(rect._width).both),offset:offset}}function drawStackedNavigation(){var args=Array.prototype.splice.call(arguments,0);args.push(true);getDrawFn("navigationBar").apply(this,args)}updateContainers=function(){var containers=[];return{get:function get(){return containers},set:function set(config){var container;if(config){container=new Container;container.init({name:config.type,drawingAreaMeasurement:config.drawingArea},config.drawFn);containers.push(container)}else{containers.length=0}return containers}}}();function remove(){var visibleRoot=afAPI.getVisibleRoot();visibleRoot&&rendererAPI.disposeChild(visibleRoot)}function draw(visibleRootArr){var i,containersArr,containerElement,visibleRoot=afAPI.getVisibleRoot();rendererAPI.disposeSelectedChildren(visibleRoot,visibleRootArr?visibleRootArr[1]:visibleRoot);visibleRootArr&&(visibleRoot=visibleRootArr[1]);if(!visibleRoot.getParent()){containerManager.heightProportion.set(false)}else if(dsConf.showNavigationBar){containerManager.heightProportion.set(true)}containersArr=updateContainers.get();for(i=0;i<containersArr.length;i+=1){containerElement=containersArr[i];containerElement.setDrawingArea(getDrawingArea(containerElement.conf.name));visibleRootArr&&afAPI.setVisibleRoot(visibleRootArr[i]);containerElement.draw()}rendererAPI.hideNodes()}containerManager.init=init;containerManager.draw=draw;containerManager.heightProportion=_heightProportion;containerManager.remove=remove;return containerManager},normalizeColorCode=function normalizeColorCode(hex){if(!hex){return"#"+MOTHER_OF_ALL_COLOR}return hex.replace(/^#*/,"#")},MOTHER_OF_ALL_COLOR="E5E5E5",ref=function ref(){var afAPI={},algorithmFactory={},containerManager={};return{afAPI:afAPICreator(afAPI,containerManager),algorithmFactory:algorithmFactoryCreator(afAPI,algorithmFactory,containerManager),containerManager:containerManagerCreator(afAPI,containerManager),treeOpt:treeOpt}};var Bucket=function(){function Bucket(){this._b=[];this._css=UNDEF;this.rangeOurEffectApplyFn=_lib.stubFN;this.statePointerLow={value:UNDEF,index:UNDEF};this.statePointerHigh={value:UNDEF,index:UNDEF}}var _proto6=Bucket.prototype;_proto6.resetPointers=function resetPointers(){this.statePointerLow={value:UNDEF,index:UNDEF};this.statePointerHigh={value:UNDEF,index:UNDEF}};_proto6.setRangeOutEffect=function setRangeOutEffect(css,rangeOurEffectApplyFn){this._css=css;this.rangeOurEffectApplyFn=rangeOurEffectApplyFn};_proto6.addInBucket=function addInBucket(node){var arr=this._b,val=node.getColorValue(),minIndex=0,maxIndex=arr.length-1,targetIndex;if(!val&&val!==0){return}targetIndex=function(){var _i,_elem,_elemVal;while(minIndex<=maxIndex){targetIndex=_i=(minIndex+maxIndex)/2|0;_elem=arr[_i];_elemVal=_elem.getColorValue();if(_elemVal<val){minIndex=_i+1}else if(_elemVal>val){maxIndex=_i-1}else{return _i}}return~maxIndex}();arr.splice(Math.abs(targetIndex),0,node)};_proto6.moveLowerShadePointer=function moveLowerShadePointer(value){var arr=this._b,index,bucketElem,_val,statePtr=this.statePointerLow,stateIndex=statePtr.index,stateVal=statePtr.value,pointerAheadFlag=false;index=stateIndex=stateIndex!==UNDEF?stateIndex:0;stateVal=stateVal!==UNDEF?stateVal:Number.NEGATIVE_INFINITY;if(value===stateVal){return}if(stateVal<=value){while(true){bucketElem=arr[index++];_val=bucketElem?bucketElem.getColorValue():0;if(value<=_val||!bucketElem){break}pointerAheadFlag=true;bucketElem.rangeOutEffect=this._css;this.rangeOurEffectApplyFn.call(bucketElem,this._css)}index=pointerAheadFlag?index-2:index-1}else{while(true){bucketElem=arr[index--];_val=bucketElem?bucketElem.getColorValue():0;if(value>_val||!bucketElem){break}bucketElem.cssConf=bucketElem.cssConf||{};pointerAheadFlag=true;delete bucketElem.rangeOutEffect;bucketElem.cssConf.opacity=1;this.rangeOurEffectApplyFn.call(bucketElem,bucketElem.cssConf)}index=pointerAheadFlag?index+2:index+1}statePtr.index=index;statePtr.value=value};_proto6.moveHigherShadePointer=function moveHigherShadePointer(value){var arr=this._b,length=arr.length,index,bucketElem,_val,statePtr=this.statePointerHigh,stateIndex=statePtr.index,stateVal=statePtr.value,pointerAheadFlag=false;index=stateIndex=stateIndex!==UNDEF?stateIndex:length-1;stateVal=stateVal!==UNDEF?stateVal:Number.POSITIVE_INFINITY;if(value===stateVal){return}if(stateVal>value){while(true){bucketElem=arr[index--];_val=bucketElem?bucketElem.getColorValue():0;if(value>=_val||!bucketElem){break}pointerAheadFlag=true;bucketElem.rangeOutEffect=this._css;this.rangeOurEffectApplyFn.call(bucketElem,this._css)}index=pointerAheadFlag?index+2:index+1}else{while(true){bucketElem=arr[index++];_val=bucketElem?bucketElem.getColorValue():0;if(value<_val||!bucketElem){break}bucketElem.cssConf=bucketElem.cssConf||{};pointerAheadFlag=true;delete bucketElem.rangeOutEffect;bucketElem.cssConf.opacity=1;this.rangeOurEffectApplyFn.call(bucketElem,bucketElem.cssConf)}index=pointerAheadFlag?index-2:index-1}statePtr.index=index;statePtr.value=value};return Bucket}();var TreeNode=function(){function TreeNode(label,value,colorValue){this.label=label;this.id=id++;this.value=parseFloat(value,10);this.colorValue=parseFloat(colorValue,10);this.next=UNDEF;this.prev=UNDEF;this.meta={}}var _proto7=TreeNode.prototype;_proto7.getCSSconf=function getCSSconf(){return this.cssConf};_proto7.getPath=function getPath(){return this.path};_proto7.setPath=function setPath(){var node=this,parentNode=node.getParent();node.path=(parentNode?parentNode.getPath():[]).concat(node)};_proto7.addChild=function addChild(ref){if(ref instanceof TreeNode){this.next=this.next||[];[].push.call(this.next,ref);ref.setParent(this)}return this.next};_proto7.getChildren=function getChildren(){return this.next};_proto7.addChildren=function addChildren(newNode,indexVal){var parentNode=this,index=indexVal,childrenArr=parentNode.getChildren()||(parentNode.next=[]),len=childrenArr.length;if(!index){index=len-1}index=index>len-1?len-1:index<0?0:index;childrenArr.splice(index,0,newNode);newNode.setParent(this)};_proto7.getDepth=function getDepth(){return this.meta.depth};_proto7.isLeaf=function isLeaf(maxDepth){var node=this;return(maxDepth?node.getDepth()<maxDepth:true)&&node.next};_proto7.setParent=function setParent(ref){if(ref instanceof TreeNode){this.prev=ref}return this};_proto7.getSiblingCount=function getSiblingCount(side){var parent,counter=0,node=this,currentSibling=node;if(!(this instanceof TreeNode)){return}parent=node.getParent();if(side){while(currentSibling){currentSibling=currentSibling.getSibling(side);if(currentSibling){counter+=1}}return counter}if(parent){return parent.getChildren().length}};_proto7.getParent=function getParent(){return this.prev};_proto7.getLabel=function getLabel(){return this.label};_proto7.getValue=function getValue(){return this.value};_proto7.setValue=function setValue(value,incremental){var node=this;if(incremental){node.value+=value}else{node.value=value}};_proto7.getColorValue=function getColorValue(){return this.colorValue};_proto7.getSibling=function getSibling(side){var nSideStr=side.toLowerCase(),parent=this.getParent(),label=this.getLabel(),children,index,tLabel,child;if(!parent){return}children=parent.getChildren();for(index=0;index<children.length;index++){child=children[index];tLabel=child.getLabel();if(tLabel===label){switch(nSideStr){case"left":return children[index-1];case"right":return children[index+1]}}}};_proto7.setMeta=function setMeta(key,value){this.meta[key]=value};_proto7.setDepth=function setDepth(depth){this.meta.depth=depth};_proto7.getMeta=function getMeta(key){if(!key){return this.meta}return this.meta[key]};return TreeNode}();var _default=ref;exports.default=_default;