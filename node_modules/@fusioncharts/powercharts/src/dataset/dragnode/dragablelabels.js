"use strict";var _interopRequireDefault=require("@babel/runtime/helpers/interopRequireDefault");exports.__esModule=true;exports.default=void 0;var _inheritsLoose2=_interopRequireDefault(require("@babel/runtime/helpers/inheritsLoose"));var _dragnode=_interopRequireDefault(require("./dragnode"));var _lib=require("@fusioncharts/core/src/lib");var _dependencyManager=require("@fusioncharts/core/src/dependency-manager");var _draggablelabelAnimation=_interopRequireDefault(require("./draggablelabel-animation"));var PX=_lib.preDefStr.PX,EVENTARGS="eventArgs",LABELDRAGEND="labeldragend",TRACKER_FILL="rgba(192,192,192,"+(_lib.isIE?.002:1e-6)+")";var DragNodeLabels=function(_DragNodeDataset){(0,_inheritsLoose2.default)(DragNodeLabels,_DragNodeDataset);function DragNodeLabels(){var _this;_this=_DragNodeDataset.call(this)||this;(0,_dependencyManager.addDep)({name:"draggablelabelAnimation",type:"animationRule",extension:_draggablelabelAnimation.default});return _this}var _proto=DragNodeLabels.prototype;_proto.getType=function getType(){return"dataset"};_proto.getName=function getName(){return"dragNodeLabels"};_proto.configure=function configure(datasetJSON){if(datasetJSON){this.trimData(datasetJSON);this.config.JSONData=datasetJSON.label}else if(!datasetJSON&&!this.config.JSONData){return false}var dataset=this,chartAttr=dataset.getFromEnv("chart-attrib"),conf=dataset.config,setDataArr=dataset.config.JSONData||[],len=setDataArr.length,dataStore=dataset.components.data,i;conf.viewMode=(0,_lib.pluckNumber)(chartAttr.viewmode,0);if(!dataStore){dataStore=dataset.components.data=[]}for(i=0;i<len;i++){dataset._setConfigure(i)}};_proto._setConfigure=function _setConfigure(index,updateObj){var dataset=this,setDataArr=dataset.config.JSONData,setData=updateObj||setDataArr[index],dataStore=dataset.components.data,dataObj,text,inCanvasStyle=dataset.getFromEnv("style").inCanvasStyle,inCanFontSize=inCanvasStyle.fontSize,config,labelFontSize;dataObj=dataStore[index];!dataObj&&(dataObj=dataStore[index]={});!dataObj.graphics&&(dataObj.graphics={});config=dataObj.config=dataObj.config||(dataObj.config={});text=(0,_lib.parseUnsafeString)((0,_lib.pluck)(setData.text,setData.label));config._options=setData;config.add=setData.add;if(text){config.text=text;config.x=setData.x||0;config.y=setData.y||0;config.labelFontSize=labelFontSize=(0,_lib.pluckNumber)(setData.fontsize,inCanFontSize);config.labelColor=(0,_lib.hashify)((0,_lib.pluck)(setData.color,inCanvasStyle.color));config.alpha=(0,_lib.pluckNumber)(setData.alpha,100)/100;config.allowDrag=(0,_lib.pluckNumber)(setData.allowdrag,1);config.padding=(0,_lib.pluckNumber)(setData.padding,5);if(setData.fontsize){config.labelCSS={fontSize:labelFontSize+PX}}else{config.labelCSS={}}config.labelBGColor=(0,_lib.pluck)(setData.bgcolor&&setData.bgcolor.replace(_lib.dropHash,_lib.HASHSTRING));config.labelBDColor=(0,_lib.pluck)(setData.bordercolor&&setData.bordercolor.replace(_lib.dropHash,_lib.HASHSTRING));config.link=setData.link;config.borderThickness=setData.borderthickness;config.dashLen=setData.dashlen;config.dashGap=setData.dashgap;config.dashed=setData.dashed;config.radius=setData.radius}};_proto.getJSONData=function getJSONData(){var dataset=this,dataStore=dataset.components.data,len=dataStore.length,jsonData=[],dataObj,i;for(i=0;i<len;i++){dataObj=dataStore[i];if(!dataObj.removed){if(dataObj.config._options){jsonData.push(dataObj.config._options)}}}return jsonData};_proto.createContainer=function createContainer(){var dataset=this,animationManager=dataset.getFromEnv("animationManager"),parentContainer=dataset.getLinkedParent().getChildContainer();!dataset.getContainer("dragLabelGroup")&&dataset.addContainer("dragLabelGroup",animationManager.setAnimation({el:"group",attr:{name:"dragLabelGroup"},label:"group",component:dataset,container:parentContainer.defaultVcanvasGroup}))};_proto.allocatePosition=function allocatePosition(){this.parsePlotAttributes()};_proto.parsePlotAttributes=function parsePlotAttributes(){var dataset=this,dataStore=dataset.components.data,yAxis=dataset.getFromEnv("yAxis"),xAxis=dataset.getFromEnv("xAxis"),SmartLabel=dataset.getFromEnv("smartLabel"),style=dataset.getFromEnv("dataLabelStyle"),dashLen,dashGap,dashed,x,y,color,text,bgColor,borderColor,padding,config,attr,dataObj,allowDrag,fontSize,radius,dim,borderThickness,len=dataStore&&dataStore.length,lStyle,chartConfig=dataset.getFromEnv("chartConfig"),i,labelCSS;for(i=0;i<len;i++){dataObj=dataStore[i];if(dataObj.removed){continue}config=dataObj.config;!dataObj.graphics&&(dataObj.graphics={});config.index=i;x=xAxis.getPixel(config.x);y=yAxis.getPixel(config.y);text=config.text;bgColor=config.labelBGColor;borderColor=config.labelBDColor;padding=config.padding;allowDrag=config.allowDrag;fontSize=config.labelFontSize;color=config.labelColor;radius=config.radius;dashed=config.dashed;borderThickness=config.borderThickness;dashLen=config.dashLen;dashGap=config.dashGap;borderThickness=config.borderThickness;labelCSS=config.labelCSS;attr={x:x,y:y,text:text,align:_lib.POSITION_CENTER,fill:color,"text-bound":[bgColor||_lib.BLANKSTRING,borderColor||_lib.BLANKSTRING,(0,_lib.pluckNumber)(borderThickness,1),padding,(0,_lib.pluckNumber)(radius,0),(0,_lib.pluckNumber)(dashed,0)?(0,_lib.getDashStyle)((0,_lib.pluckNumber)(dashLen,5),(0,_lib.pluckNumber)(dashGap,4)):_lib.DASH_DEF],visibility:_lib.visibleStr};lStyle={backgroundColor:bgColor,borderColor:borderColor,borderPadding:padding,fontSize:fontSize+_lib.PXSTRING,fontStyle:style.fontStyle,fontWeight:style.fontWeight,borderRadius:0,borderDash:_lib.DASH_DEF,fontFamily:style.fontFamily};(0,_lib.setLineHeight)(lStyle);SmartLabel.useEllipsesOnOverflow(chartConfig.useEllipsesWhenOverflow);SmartLabel.setStyle(lStyle);labelCSS["line-height"]=lStyle.lineHeight;config.eventArgs={link:config.link,text:text,x:x,y:y,allowdrag:allowDrag,sourceType:"labelnode"};config.props={element:{attr:attr}};config.labelCSSApplied=labelCSS;dim=SmartLabel.getOriSize(text);config.width=dim.width;config.height=dim.height;config.xPos=x;config.yPos=y}};_proto.draw=function draw(){var dataset=this,dataStore=dataset.components.data,animationManager=dataset.getFromEnv("animationManager"),style=dataset.getFromEnv("dataLabelStyle"),config,dataObj,element,elementCheck,len=dataStore&&dataStore.length,removeDataArr=dataset.components.removeDataArr||[],removeDataArrLen=removeDataArr.length,i,dataLabelContainer,labelCSS;dataset.createContainer();dataLabelContainer=dataset.getContainer("dragLabelGroup");dataLabelContainer.css({"font-weight":style.fontWeight,"font-style":style.fontStyle,"font-size":style.fontSize,"font-family":style.fontFamily});for(i=0;i<len;i++){dataObj=dataStore[i];if(dataObj.removed){continue}config=dataObj.config;elementCheck=dataObj.graphics.element;element=animationManager.setAnimation({el:elementCheck||"text",container:dataLabelContainer,css:config.labelCSS,attr:config.props.element.attr,component:dataset});if(!elementCheck){dataObj.graphics.element=element}else{if(config.labelCSSApplied&&!labelCSS){element.removeCSS()}element.show().css(config.labelCSS)}element.data("eventArgs",config.eventArgs)}dataset.drawTracker();for(i=0;i<removeDataArrLen;i++){dataset._removeDataVisuals(removeDataArr.shift())}};_proto.drawTracker=function drawTracker(){var dataset=this,dataStore=dataset.components.data,animationManager=dataset.getFromEnv("animationManager"),chart=dataset.getFromEnv("chart"),manager=dataset.getLinkedParent(),conf=dataset.config,trackerGroup=dataset.getContainer("dragLabelGroup"),len=dataStore&&dataStore.length,dataObj,config,padding,elemMouseDownFN=function elemMouseDownFN(){var ele=this,data=ele.data("drag-options"),dataSet=data.dataset,index=data.index,labelObj=dataSet.components.data[index];ele.data("fire_click_event",1);manager.clearLongPress();manager.triggerLabelUI(ele,labelObj)},elemMouseMoveFN=function elemMouseMoveFN(){var ele=this;if(ele.data("fire_click_event")){ele.data("fire_click_event",0);manager.clearLongPress()}},elemMouseUPFN=function elemMouseUPFN(data){var ele=this,fireClick=ele.data("fire_click_event");manager.clearLongPress();if(fireClick){chart.plotEventHandler(ele,data,"LabelClick")}},elemHoverFN=function elemHoverFN(data){var ele=this;chart.plotEventHandler(ele,data,"LabelRollover")},elemOutFN=function elemOutFN(data){var ele=this;chart.plotEventHandler(ele,data,"LabelRollout")},eventArgs,attr,allowDrag,text,trackerElement,trackerElementCheck,x,y,width,height,dragMove=function dragMove(event,data){var ele=this;dataset._labelDragMove.call(ele,event,data,chart)},dragStart=function dragStart(event){var ele=this;dataset._labelDragStart.call(ele,event,chart)},dragUp=function dragUp(event){var ele=this;dataset._labelDragUp.call(ele,event)},i;for(i=0;i<len;i++){dataObj=dataStore[i];if(dataObj.removed){continue}config=dataObj.config;padding=config.padding||0;width=config.width;height=config.height;x=config.xPos-width/2;y=config.yPos-height/2;allowDrag=config.allowDrag;text=config.text;trackerElementCheck=dataObj.graphics.trackerElement;attr={x:x-padding,y:y-padding,width:width+padding*2,height:height+padding*2,cursor:config.allowDrag?"move":_lib.BLANKSTRING,fill:TRACKER_FILL,stroke:TRACKER_FILL};eventArgs={link:config.link,text:text,x:x,y:y,allowdrag:allowDrag,sourceType:"labelnode"};trackerElement=animationManager.setAnimation({el:trackerElementCheck||"rect",container:trackerGroup,attr:attr,component:dataset});if(!trackerElementCheck){dataObj.graphics.trackerElement=trackerElement;trackerElement.on("fc-mousedown",elemMouseDownFN).on("fc-mousemove",elemMouseMoveFN).on("fc-mouseup",elemMouseUPFN).data("viewMode",conf.viewMode).data(_lib.preDefStr.EVENTARGS,eventArgs).hover(elemHoverFN,elemOutFN);config.allowDrag&&trackerElement.drag(dragMove,dragStart,dragUp)}trackerElement.data("drag-options",{index:i,dataset:dataset})}};_proto._labelDragStart=function _labelDragStart(){var ele=this,bBox=ele.getBBox(),data=ele.data("drag-options"),dataset=data.dataset,manager=dataset.getLinkedParent(),index=data.index,labelObj=dataset.components.data[index],labelElement=labelObj.graphics.element,dragStart=labelObj.dragStart=labelObj.dragStart||(labelObj.dragStart={});data.ox=labelElement.attr("x");data.oy=labelElement.attr("y");data.bBox=bBox;dragStart.xPos=labelObj.config.xPos;dragStart.yPos=labelObj.config.yPos;dragStart.bBox=bBox;ele.data("fire_click_event",1);ele.data("fire_dragend",0);manager.clearLongPress();manager.triggerLabelUI(ele,labelObj)};_proto._labelDragMove=function _labelDragMove(event,positionData){var ele=this,data=ele.data("drag-options"),index=data.index,dataset=data.dataset,chart=dataset.getFromEnv("chart"),chartConfig=dataset.getFromEnv("chartConfig"),canvasLeft=chartConfig.canvasLeft,canvasRight=chartConfig.canvasRight,canvasBottom=chartConfig.canvasBottom,canvasTop=chartConfig.canvasTop,manager=dataset.getLinkedParent(),labelObj=dataset.components.data[index],labelElement=labelObj.graphics.element,dragStart=labelObj.dragStart,bBox=dragStart.bBox,dx=positionData[0],dy=positionData[1],startX=dragStart.bBox.x+dx,endX=dragStart.bBox.x2+dx,startY=dragStart.bBox.y+dy,endY=dragStart.bBox.y2+dy,yAxis=dataset.getFromEnv("yAxis"),xAxis=dataset.getFromEnv("xAxis"),xPos,yPos;if(startX<canvasLeft){dx+=canvasLeft-startX}if(endX>canvasRight){dx-=endX-canvasRight}if(startY<canvasTop){dy+=canvasTop-startY}if(endY>canvasBottom){dy-=endY-canvasBottom}dragStart.draged=true;ele.attr({x:bBox.x+dx,y:bBox.y+dy});xPos=data.ox+dx;yPos=data.oy+dy;labelElement.attr({x:data.ox+dx,y:data.oy+dy});labelObj.config.x=xAxis.getValue(xPos);labelObj.config.y=yAxis.getValue(yPos);if(!ele.data("fire_dragend")){chart.plotEventHandler(ele,event,"LabelDragStart");ele.data("fire_dragend",1)}if(ele.data("fire_click_event")){ele.data("fire_click_event",0);manager.clearLongPress()}};_proto._labelDragUp=function _labelDragUp(event){var ele=this,data=ele.data("drag-options"),index=data.index,dataset=data.dataset,chart=dataset.getFromEnv("chart"),xAxis=chart.getChildren("xAxis")[0],yAxis=chart.getChildren("yAxis")[0],manager=dataset.getLinkedParent(),sourceEvent=LABELDRAGEND,labelObj=dataset.components.data[index],dragStart=labelObj.dragStart,eventArgs=ele.data(EVENTARGS);eventArgs.x=xAxis.getValue(ele.attr("x"));eventArgs.y=yAxis.getValue(ele.attr("y"));dragStart.draged=false;if(ele.data("fire_dragend")){chart.fireChartInstanceEvent("chartupdated",(0,_lib.extend2)({sourceEvent:sourceEvent},eventArgs),event);chart.fireChartInstanceEvent("chartupdated",eventArgs,event);chart.plotEventHandler(ele,event,sourceEvent)}manager.clearLongPress()};_proto.removeData=function removeData(index,stretch){var dataset=this,components=dataset.components,dataStore=components.data;components.removeDataArr=dataStore.splice(index,stretch)};_proto.trimData=function trimData(datasetJSON){if(!this.config.JSONData){return}var dataSet=this,prevData=dataSet.config.JSONData,prevDataLength=prevData&&prevData.length,currDataLength=datasetJSON.label&&datasetJSON.label.length||0,dataDiff=prevDataLength-currDataLength;if(dataDiff>0){dataSet.removeData(currDataLength,dataDiff)}};return DragNodeLabels}(_dragnode.default);var _default=DragNodeLabels;exports.default=_default;