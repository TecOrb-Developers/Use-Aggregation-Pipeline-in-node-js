"use strict";var _interopRequireDefault=require("@babel/runtime/helpers/interopRequireDefault");exports.__esModule=true;exports.default=void 0;var _inheritsLoose2=_interopRequireDefault(require("@babel/runtime/helpers/inheritsLoose"));var _dragnode=_interopRequireDefault(require("./dragnode"));var _lib=require("@fusioncharts/core/src/lib");var _dependencyManager=require("@fusioncharts/core/src/dependency-manager");var _connectorAnimation=_interopRequireDefault(require("./connector-animation"));var EVENTARGS=_lib.preDefStr.EVENTARGS,L="L",M="M",configStr=_lib.preDefStr.configStr,_getlinePath=function _getlinePath(connector){var config=connector.config,fromPointObj=config.fromPointObj,toPointObj=config.toPointObj,fromX=config.fromX,fromY=config.fromY,toX=config.toX,toY=config.toY,path=[M,fromX,fromY],pointConfig;if(config.arrowAtStart){pointConfig=fromPointObj.config;if(pointConfig.shapeType===_lib.SHAPE_RECT){path=path.concat(DragNodeConnector._drawArrow(fromX,fromY,toX,toY,pointConfig.shapeArg.width,pointConfig.shapeArg.height))}else{path=path.concat(DragNodeConnector._drawArrow(fromX,fromY,toX,toY,pointConfig.shapeArg.radius))}}if(config.arrowAtEnd){pointConfig=toPointObj.config;if(pointConfig.shapeType===_lib.SHAPE_RECT){path=path.concat(DragNodeConnector._drawArrow(toX,toY,fromX,fromY,pointConfig.shapeArg.width,pointConfig.shapeArg.height))}else{path=path.concat(DragNodeConnector._drawArrow(toX,toY,fromX,fromY,pointConfig.shapeArg.radius))}}path.push(L,toX,toY);return path},createGroup=function createGroup(groupName,parentContainer,dataset){var animationManager=dataset.getFromEnv("animationManager");return animationManager.setAnimation({el:"group",attr:{name:groupName},container:parentContainer,component:dataset,label:"group"})};(0,_dependencyManager.addDep)({name:"connectorAnimation",type:"animationRule",extension:_connectorAnimation.default});var DragNodeConnector=function(_DragNodeDataset){(0,_inheritsLoose2.default)(DragNodeConnector,_DragNodeDataset);function DragNodeConnector(){return _DragNodeDataset.apply(this,arguments)||this}var _proto=DragNodeConnector.prototype;_proto.getType=function getType(){return"dataset"};_proto.getName=function getName(){return"dragNodeConnector"};_proto._setDatasetIndex=function _setDatasetIndex(){var dataset=this,chidrenArr=dataset.getLinkedParent().getChildren("connector");dataset.config.datasetIndex=chidrenArr.indexOf(dataset)};_proto.configureAttributes=function configureAttributes(datasetJSON){if(datasetJSON){this.trimData(datasetJSON);this.config.JSONData=datasetJSON}else if(!datasetJSON&&!this.config.JSONData){return false}var connectors=this,chartAttr=connectors.getFromEnv("chart-attrib"),conf=connectors.config,connectorsObj=connectors.config.JSONData,connectorsArr=connectorsObj.connector,length=connectorsArr&&connectorsArr.length,index,HUNDRED=_lib.HUNDREDSTRING;conf.connectorsTooltext=(0,_lib.getValidValue)((0,_lib.parseUnsafeString)((0,_lib.pluck)(connectorsObj.connectortooltext,chartAttr.connectortooltext),false));conf.stdThickness=(0,_lib.pluckNumber)(connectorsObj.stdthickness,1);conf.conColor=(0,_lib.getFirstColor)((0,_lib.pluck)(connectorsObj.color,"FF5904"));conf.conAlpha=(0,_lib.pluck)(connectorsObj.alpha,HUNDRED);conf.conDashGap=(0,_lib.pluckNumber)(connectorsObj.dashgap,5);conf.conDashLen=(0,_lib.pluckNumber)(connectorsObj.dashlen,5);conf.conDashed=Boolean((0,_lib.pluckNumber)(connectorsObj.dashed,0));conf.arrowAtStart=Boolean((0,_lib.pluckNumber)(connectorsObj.arrowatstart,1));conf.arrowAtEnd=Boolean((0,_lib.pluckNumber)(connectorsObj.arrowatend,1));conf.conStrength=(0,_lib.pluckNumber)(connectorsObj.strength,1);conf.toolTipSepChar=(0,_lib.pluck)(chartAttr.tooltipsepchar," - ");conf.showTooltip=(0,_lib.pluckNumber)(chartAttr.showtooltip,1);conf.showTextOutline=(0,_lib.pluckNumber)(chartAttr.textoutline,0);conf.viewMode=(0,_lib.pluckNumber)(chartAttr.viewmode,1);conf._refreshData=true;connectors._setDatasetIndex("connector");for(index=0;index<length;index+=1){this._setConfigure(index,connectorsArr[index])}conf._refreshData=true};_proto._setConfigure=function _setConfigure(index,connectorObj){var connector=this,connectorStore=connector.components.data||(connector.components.data=[]),connObj=connectorStore[index]||(connectorStore[index]=connectorStore[index]={}),conf=connector.config,connectorLabel=(0,_lib.parseUnsafeString)((0,_lib.pluck)(connectorObj.label,connectorObj.name)),setConAlpha=(0,_lib.pluck)(connectorObj.alpha,conf.conAlpha),smartLabel=connector.getFromEnv("smartLabel"),tooltipSepChar=conf.toolTipSepChar,defToolTextMacro="$fromLabel"+tooltipSepChar+"$toLabel",setConColor={FCcolor:{color:(0,_lib.getFirstColor)((0,_lib.pluck)(connectorObj.color,conf.conColor)),alpha:setConAlpha}},toolText,config,labelTextObj,connectorsTooltext=conf.connectorsTooltext,connectorToolText=(0,_lib.getValidValue)((0,_lib.parseUnsafeString)((0,_lib.pluck)(connectorObj.tooltext,connectorsTooltext),false)),boolCondition=Boolean((0,_lib.pluckNumber)(connectorObj.dashed,conf.conDashed));smartLabel.setStyle(connector.getFromEnv("dataLabelStyle"));smartLabel.useEllipsesOnOverflow(connector.getFromEnv("chartConfig").useEllipsesWhenOverflow);labelTextObj=smartLabel.getOriSize(connectorLabel);config=connObj.config=connObj.config||(connObj.config={});!connObj.graphics&&(connObj.graphics={});if(!conf.showTooltip){toolText=false}else{toolText=(0,_lib.pluck)(connectorToolText,connectorLabel?"$label":defToolTextMacro)}config=connObj.config={_options:connectorObj,id:(0,_lib.pluck)(connectorObj.id,index).toString(),from:(0,_lib.pluck)(connectorObj.from,_lib.BLANK),to:(0,_lib.pluck)(connectorObj.to,_lib.BLANK),label:connectorLabel,toolText:toolText,customToolText:connectorToolText,color:setConColor,index:index,dashStyle:boolCondition?(0,_lib.getDashStyle)((0,_lib.pluckNumber)(connectorObj.dashlen,conf.conDashLen),(0,_lib.pluckNumber)(connectorObj.dashgap,conf.conDashGap)):_lib.DASH_DEF,dashed:connectorObj.dashed,dashlen:connectorObj.dashlen,dashgap:connectorObj.dashgap,arrowAtStart:Boolean((0,_lib.pluckNumber)(connectorObj.arrowatstart,conf.arrowAtStart)),arrowAtEnd:Boolean((0,_lib.pluckNumber)(connectorObj.arrowatend,conf.arrowAtEnd)),conStrength:(0,_lib.pluckNumber)(connectorObj.strength,conf.conStrength),link:connectorObj.link,stdThickness:conf.stdThickness,labelWidth:labelTextObj.widht,labelHeight:labelTextObj.height};config.datasetIndex=connector.config.datasetIndex;config.add=connectorObj.add;config.update=connectorObj.update;config.dataLabelStyle=connector._configureDataLabelStyle(connectorObj);if(conf._refreshData){delete connObj.removed}};_proto.createContainer=function createContainer(){var dataset=this,parentContainer=dataset.getLinkedParent().getChildContainer();!dataset.getContainer("connectorGroup")&&dataset.addContainer("connectorGroup",createGroup("connectorGroup",parentContainer.connectorGroup,dataset));!dataset.getContainer("connectorDataLabelGroup")&&dataset.addContainer("connectorDataLabelGroup",createGroup("connectorDataLabelGroup",parentContainer.connectorGroup,dataset))};_proto.draw=function draw(){var connectors=this,manager=connectors.getLinkedParent(),conf=connectors.config,connectorStore=connectors.components.data,connector,fromId,toId,fromPointObj,toPointObj,style=connectors.getFromEnv("dataLabelStyle"),i,length=connectorStore.length,removeDataArr=connectors.components.removeDataArr||[],removeDataArrLen=removeDataArr.length,config;connectors.createContainer();conf.cleared=false;connectors.getContainer("connectorDataLabelGroup").css(style);for(i=0;i<length;i++){connector=connectorStore[i];config=connector.config;fromId=config.from;toId=config.to;fromPointObj=manager.getNode(fromId);toPointObj=manager.getNode(toId);if(fromPointObj&&toPointObj&&config.deleted!==true){connectors.drawConnector(connector,fromPointObj,toPointObj,i)}}connectors.config.drawn=true;for(i=0;i<removeDataArrLen;i++){connectors._removeDataVisuals(removeDataArr.shift())}};_proto.parsePlotAttributes=function parsePlotAttributes(connector,fromPointObj,toPointObj){var dataset=this,fromX,toX,fromY,toY,strokeWidth,NumberFormatter=dataset.getFromEnv("number-formatter"),pathArr,startConnectors,endConnectors,config=connector.config,fromConf,toConf,eventArgs=config.eventArgs||(config.eventArgs={}),color,id;config.fromPointObj=fromPointObj;config.toPointObj=toPointObj;fromConf=fromPointObj.config;toConf=toPointObj.config;config.fromX=fromX=fromConf._xPos;config.fromY=fromY=fromConf._yPos;config.toX=toX=toConf._xPos;config.toY=toY=toConf._yPos;config._labelX=(fromX+toX)/2;config._labelY=(fromY+toY)/2;config.strokeWidth=strokeWidth=config.conStrength*config.stdThickness;color=config.color;config.textBgColor=color&&color.FCcolor&&color.FCcolor.color;eventArgs.label=config.label;eventArgs.arrowAtStart=config.arrowAtStart;eventArgs.arrowAtEnd=config.arrowAtEnd;eventArgs.link=config.link;eventArgs.id=config.id;eventArgs.fromNodeId=fromConf.id;eventArgs.toNodeId=toConf.id;config.toolText=(0,_lib.parseTooltext)(config.toolText,[3,83,84,85,86,87,88,89,90,91,92],{label:config.label,fromXValue:NumberFormatter.dataLabels(fromPointObj.config.x),fromYValue:NumberFormatter.dataLabels(fromPointObj.config.y),fromXDataValue:fromPointObj.config.x,fromYDataValue:fromPointObj.config.y,fromLabel:(0,_lib.pluck)(fromPointObj.config.displayValue,fromPointObj.config.id),toXValue:NumberFormatter.dataLabels(toPointObj.config.x),toYValue:NumberFormatter.dataLabels(toPointObj.config.y),toXDataValue:toPointObj.config.x,toYDataValue:toPointObj.config.y,toLabel:(0,_lib.pluck)(toPointObj.config.displayValue,toPointObj.config.id)});fromConf=fromPointObj.config;toConf=toPointObj.config;startConnectors=fromConf.startConnectors||(fromConf.startConnectors={});endConnectors=toConf.endConnectors||(toConf.endConnectors={});id=connector.config.id+"-"+fromConf.id+"-"+toConf.id;startConnectors[id]=connector;endConnectors[id]=connector;pathArr=_getlinePath(connector);config.props={element:{attr:{path:pathArr,"stroke-width":strokeWidth,"stroke-dasharray":config.dashStyle,cursor:config.link?_lib.POINTER:_lib.BLANKSTRING,stroke:(0,_lib.toRaphaelColor)(color)}}}};_proto.allocatePosition=function allocatePosition(){var connectors=this,i,connector,config,fromId,toId,fromPointObj,toPointObj,manager=connectors.getLinkedParent(),connectorStore=connectors.components.data,len=connectorStore.length;for(i=0;i<len;i++){connector=connectorStore[i];config=connector.config;fromId=config.from;toId=config.to;fromPointObj=manager.getNode(fromId);toPointObj=manager.getNode(toId);if(fromPointObj&&toPointObj&&config.deleted!==true){connectors.parsePlotAttributes(connector,fromPointObj,toPointObj,i)}}};_proto.drawConnector=function drawConnector(connector){var dataset=this,toolTipController=dataset.getFromEnv("toolTipController"),animationManager=dataset.getFromEnv("animationManager"),graphics=connector.graphics,element,elementCheck,connectorsGroup=dataset.getContainer("connectorGroup"),config=connector.config,tooltext=config.toolText,eventArgs=config.eventArgs||(config.eventArgs={}),conf=dataset.config,pool=dataset.components.pool||{};if(connector.removed){return}element=elementCheck=graphics.graphic;if(!graphics.graphic){if(pool.graphic&&pool.graphic.path&&pool.graphic.path.length){elementCheck=graphics.graphic=pool.graphic.path.shift()}}element=animationManager.setAnimation({el:elementCheck||"path",container:connectorsGroup,attr:config.props.element.attr,label:"path",component:dataset});if(!elementCheck){graphics.graphic=element;element.on("fc-mousedown",dataset.mouseDown).on("fc-mousemove",dataset.mousemove).on("fc-mouseup",dataset.mouseup).hover(dataset.hoverIn,dataset.hoverOut)}element.show().data(EVENTARGS,eventArgs).data("viewMode",conf.viewMode).data(configStr,config).data("dataset",dataset);conf.showTooltip?toolTipController.enableToolTip(element,tooltext):toolTipController.disableToolTip(element);dataset.drawLabel(connector)};_proto.drawLabel=function drawLabel(connector){var dataset=this,toolTipController=dataset.getFromEnv("toolTipController"),conf=dataset.config,animationManager=dataset.getFromEnv("animationManager"),connectorsGroup=dataset.getContainer("connectorDataLabelGroup"),config,label,tooltext,labelAttrs,style=dataset.getFromEnv("dataLabelStyle"),labelStyle,labelElement,labelElementCheck,graphics,connectorObj,i,labelX,labelY,textBgColor,dataStore=dataset.components.data,pool=dataset.components.pool||{},len=dataStore.length,drawIndividualLabel=function drawIndividualLabel(labelConnector){config=labelConnector.config;tooltext=config.toolText;graphics=labelConnector.graphics;label=config.label;labelX=config._labelX;labelY=config._labelY;labelStyle=config.dataLabelStyle||style;textBgColor=config.textBgColor;if(label){labelElementCheck=graphics.text=graphics.text||pool.element&&pool.element.text&&pool.element.text.shift();labelAttrs={text:label,fill:labelStyle.color,direction:_lib.BLANKSTRING,cursor:config.link?_lib.POINTER:_lib.BLANKSTRING,"text-bound":[(0,_lib.pluck)(labelStyle.backgroundColor,textBgColor),(0,_lib.pluck)(labelStyle.borderColor,textBgColor),1,"2"],x:labelX,y:labelY};labelElement=animationManager.setAnimation({el:labelElementCheck||"text",attr:labelAttrs,container:connectorsGroup,label:"text",component:dataset});labelElement.show();labelElement.outlineText(conf.showTextOutline,labelAttrs.fill);if(!labelElementCheck){graphics.text=labelElement;labelElement.on("fc-mousedown",dataset.mouseDown).on("fc-mousemove",dataset.mousemove).on("fc-mouseup",dataset.mouseup).hover(dataset.hoverIn,dataset.hoverOut)}labelElement.data(EVENTARGS,config.eventArgs).data("viewMode",conf.viewMode).data(configStr,config).data("dataset",dataset);conf.showTooltip?toolTipController.enableToolTip(labelElement,tooltext):toolTipController.disableToolTip(labelElement)}else{graphics.text&&graphics.text.hide()}};if(connector){drawIndividualLabel(connector)}else{for(i=0;i<len;i++){connectorObj=dataStore[i];drawIndividualLabel(connectorObj)}}};_proto.mouseDown=function mouseDown(){var ele=this,dataset=ele.data("dataset"),manager=dataset.getLinkedParent();manager.clearLongPress();ele.data("fire_click_event",1);manager.triggerConnectorUI(ele)};_proto.mousemove=function mousemove(){var ele=this,dataset=ele.data("dataset"),manager=dataset.getLinkedParent();ele.data("fire_click_event",0);manager.clearLongPress()};_proto.mouseup=function mouseup(){var ele=this,dataset=ele.data("dataset"),manager=dataset.getLinkedParent();manager.clearLongPress()};_proto.hoverIn=function hoverIn(e){var ele=this,dataset=ele.data("dataset"),chart=dataset.getFromEnv("chart");chart.plotEventHandler(ele,e,"ConnectorRollover")};_proto.hoverOut=function hoverOut(e){var ele=this,dataset=ele.data("dataset"),chart=dataset.getFromEnv("chart");chart.plotEventHandler(ele,e,"ConnectorRollout")};DragNodeConnector._drawArrow=function _drawArrow(X1,Y1,X2,Y2,R,H){var tanganent=(Y1-Y2)/(X1-X2),angle=Math.atan(tanganent),PX,PY,RHlf,HHlf,arr=[];if(angle<0){angle=2*Math.PI+angle}if(Y2>Y1){if(X2>=X1&&angle>Math.PI||X2<X1&&angle>Math.PI){angle=angle-Math.PI}}else{if(X2>=X1&&angle<Math.PI&&angle!==0||X2<X1&&angle<Math.PI){angle=angle+Math.PI}}if(typeof H==="undefined"){PX=X1+R*Math.cos(angle);PY=Y1+R*Math.sin(angle)}else{RHlf=Math.abs(R)/2;HHlf=Math.abs(H)/2;PX=X1+(RHlf=X1<X2?RHlf:-RHlf);PY=Y1+RHlf*Math.tan(angle);if(Math.abs(Y1-PY)>Math.abs(HHlf)){PY=Y1+(HHlf=Y1<Y2?HHlf:-HHlf);PX=X1+HHlf/Math.tan(angle)}}arr.push(L,PX,PY,PX+10*Math.cos(angle+.79),PY+10*Math.sin(angle+.79),M,PX+10*Math.cos(angle-.79),PY+10*Math.sin(angle-.79),L,PX,PY);return arr};_proto.removeData=function removeData(indexVal,stretch){var dataset=this,index=indexVal,components=dataset.components,dataStore=components.data;if(index<0){index=0}components.removeDataArr=dataStore.splice(index,stretch)};_proto.trimData=function trimData(datasetJSON){if(!this.config.JSONData){return}var dataSet=this,prevData=dataSet.components,prevDataLength=prevData.data&&prevData.data.length,currDataLength=datasetJSON.connector&&datasetJSON.connector.length||0,dataDiff=prevDataLength-currDataLength;if(dataDiff>0){dataSet.removeData(currDataLength,dataDiff)}};return DragNodeConnector}(_dragnode.default);var _default=DragNodeConnector;exports.default=_default;