"use strict";var _interopRequireDefault=require("@babel/runtime/helpers/interopRequireDefault");exports.__esModule=true;exports.default=void 0;var _inheritsLoose2=_interopRequireDefault(require("@babel/runtime/helpers/inheritsLoose"));var _componentInterface=require("@fusioncharts/core/src/component-interface");var _polarUtil=require("@fusioncharts/utils/src/scale-utils/polar-util.js");var _lib=require("@fusioncharts/core/src/lib");var _utils=require("../../chart/chord/utils");var normalizeAngles=function normalizeAngles(radians){return radians-_utils.HALF_PI},ribbonGenerator=function ribbonGenerator(points,radius,startAngle){var corners=points.map((function(p,i){var angle=(0,_polarUtil.deg2Rad)(p),_polarToCartesian=(0,_polarUtil.polarToCartesian)(radius,normalizeAngles((0,_polarUtil.deg2Rad)(startAngle))+angle),x=_polarToCartesian.x,y=_polarToCartesian.y,curveFactor=.6,distance=Math.abs((0,_polarUtil.deg2Rad)(points[3-i])-angle),nextPointDist=Math.abs((0,_polarUtil.deg2Rad)(points[(i+1)%4])-angle);if(distance>_utils.PI){distance=_utils.PI2-distance}if(distance*radius<radius){curveFactor*=distance}x=(0,_lib.toPrecision)(x,4);y=(0,_lib.toPrecision)(y,4);return{x:x,y:y,cpX:(1-curveFactor)*x,cpY:(1-curveFactor)*y,arc:nextPointDist}}));return[_utils.M,corners[0].x,corners[0].y,_utils.A,radius,radius,0,corners[0].arc>_utils.PI?1:0,1,corners[1].x,corners[1].y,_utils.C,corners[1].cpX,corners[1].cpY,corners[2].cpX,corners[2].cpY,corners[2].x,corners[2].y,_utils.A,radius,radius,0,corners[2].arc>_utils.PI?1:0,1,corners[3].x,corners[3].y,_utils.C,corners[3].cpX,corners[3].cpY,corners[0].cpX,corners[0].cpY,corners[0].x,corners[0].y].join(" ")},mouseOverFn=function mouseOverFn(){var node=this,chart=node.getFromEnv("chart");this.getLinkedParent().linkHoverIn(this.config.key);var eventArgs={};setEventArgs(eventArgs,node);chart.fireChartInstanceEvent("linkRollOver",eventArgs)},mouseOutFn=function mouseOutFn(){var node=this,chart=node.getFromEnv("chart");this.getLinkedParent().linkHoverOut(this.config.key);var eventArgs={};setEventArgs(eventArgs,node);chart.fireChartInstanceEvent("linkRollOut",eventArgs)},mouseClickFn=function mouseClickFn(){var node=this,chart=node.getFromEnv("chart");var eventArgs={};setEventArgs(eventArgs,node);chart.fireChartInstanceEvent("linkClick",eventArgs)},setEventArgs=function setEventArgs(eventArgs,node){eventArgs.dominantFlowValue=node.config[node.config.dominantNode[0]];var i;for(i=0;i<node.config.linkedNodes.length;i++){if(node.config.linkedNodes[i]!==node.config.dominantNode[0]){break}}eventArgs.subservientFlowValue=node.config[node.config.linkedNodes[i]];eventArgs.linkedNodes=node.config.linkedNodes;if(eventArgs.dominantFlowValue===eventArgs.subservientFlowValue){eventArgs.color=node.config.rawColor||(0,_lib.rgbaToHex)(node.config.normalState.fill)}else{eventArgs.color=(0,_lib.rgbaToHex)(node.config.normalState.fill)}eventArgs.alpha=node.config.alpha},getUniqueNodes=function getUniqueNodes(nodeArr){var resultingNodes=[];if(nodeArr.length===0){return[]}else if(nodeArr.length===1){return[nodeArr[0]]}resultingNodes=nodeArr.filter((function(c,index){return nodeArr.indexOf(c)===index}));return resultingNodes},getDominantFlowValue=function getDominantFlowValue(_config,_nodeArr){var i,config=_config,nodeArr=_nodeArr,resultValues=[];if(!nodeArr.length){return[]}if(nodeArr.length===1){return config[nodeArr[0]]}for(i=0;i<nodeArr.length;i++){resultValues.push(config[nodeArr[i]])}return resultValues},getPlotIdentifier=function getPlotIdentifier(colorArr,uniChar,legendItem,finalPath){var body=_lib.BLANKSTRING,graphicalElement,symbolBBox,i;if(finalPath!==""&&legendItem&&legendItem.length){if(legendItem.length===1){graphicalElement=legendItem[0].getGraphicalElement();symbolBBox=graphicalElement.legendItemSymbol.node.getBBox();return"<svg height= "+symbolBBox.height+" width = "+symbolBBox.width+" overflow='visible' xmlns=\"http://www.w3.org/2000/svg\">\n        <path d= "+finalPath+" fill = "+graphicalElement.legendItemSymbol.node.getAttribute("fill")+" stroke = "+graphicalElement.legendItemSymbol.node.getAttribute("stroke")+"\n        stroke-opacity = "+graphicalElement.legendItemSymbol.node.getAttribute("stroke-opacity")+" fill-opacity = "+graphicalElement.legendItemSymbol.node.getAttribute("fill-opacity")+" \n        stroke-width = "+graphicalElement.legendItemSymbol.node.getAttribute("stroke-width")+" stroke-linecap = "+graphicalElement.legendItemSymbol.node.getAttribute("stroke-linecap")+"></path>\n      </svg>"}for(i=0;i<legendItem.length;i++){graphicalElement=legendItem[i].getGraphicalElement();symbolBBox=graphicalElement.legendItemSymbol.node.getBBox();body+="<svg height= "+symbolBBox.height+" width = "+symbolBBox.width+" overflow='visible' xmlns=\"http://www.w3.org/2000/svg\">\n          <path d= "+finalPath+" fill = "+graphicalElement.legendItemSymbol.node.getAttribute("fill")+" stroke = "+graphicalElement.legendItemSymbol.node.getAttribute("stroke")+"\n          stroke-opacity = "+graphicalElement.legendItemSymbol.node.getAttribute("stroke-opacity")+" fill-opacity = "+graphicalElement.legendItemSymbol.node.getAttribute("fill-opacity")+" \n          stroke-width = "+graphicalElement.legendItemSymbol.node.getAttribute("stroke-width")+" stroke-linecap = "+graphicalElement.legendItemSymbol.node.getAttribute("stroke-linecap")+"></path>\n        </svg>"}}else if(colorArr.length){for(i=0;i<colorArr.length;i++){body+="\n            <span style='color: "+colorArr[i]+";'>\n              "+uniChar+"\n            </span>"}}return body},getLegendItems=function getLegendItems(legend,manager,dominantNodes){var legendItems=[],i;if(dominantNodes&&dominantNodes.length){if(dominantNodes.length===1){return[legend.getItem(manager.config.legendItemMap[dominantNodes[0]])]}for(i=0;i<dominantNodes.length;i++){legendItems.push(legend.getItem(manager.config.legendItemMap[dominantNodes[i]]))}}return legendItems},getTooltext=function getTooltext(config,chartConfig,basefontsize,ribbon){var uniChar=_lib.isIpad?_utils.SMALLSQUARE:_utils.MEDIUMSQUARE,key,body=_lib.BLANKSTRING,drawCustomLegendIcon=chartConfig&&chartConfig.drawcustomlegendicon,macroIndices=[135,136,137,138,139,140,146,147],manager=ribbon.getLinkedParent(),legend=ribbon.getFromEnv("legend"),pathArr,newPathArr=[],graphicalElement,legendItemSymbol,i,j,symbolBBox,pathStart=[],finalPath,dominantLegendItem=drawCustomLegendIcon&&legend&&legend.config&&legend.config.isActive?getLegendItems(legend,manager,getUniqueNodes(config.dominantNode)):null,subservientLegendItem=drawCustomLegendIcon&&legend&&legend.config&&legend.config.isActive?getLegendItems(legend,manager,getUniqueNodes(config.subservientNode)):null,parserConfig,linkToolText;finalPath=_lib.BLANKSTRING;if(dominantLegendItem&&dominantLegendItem.length){graphicalElement=dominantLegendItem&&dominantLegendItem[0]&&dominantLegendItem[0].getGraphicalElement();legendItemSymbol=graphicalElement&&graphicalElement.legendItemSymbol;pathArr=legendItemSymbol&&legendItemSymbol.attrs.path.split(/(?=[LMCA])/);symbolBBox=legendItemSymbol&&legendItemSymbol.node.getBBox();if(pathArr&&pathArr.length){for(i=0;i<pathArr.length;i++){pathStart.push(pathArr[i][0]);pathArr[i]=pathArr[i].substring(1,pathArr[i].length);if(i===pathArr.length-1){pathArr[i]=pathArr[i].substring(0,pathArr[i].length-1)}newPathArr[i]=pathArr[i].split(",")}}if(newPathArr&&newPathArr.length){for(i=0;i<newPathArr.length;i++){if(newPathArr[i].length){for(j=0;j<newPathArr[i].length;j++){newPathArr[i][j]=Number(newPathArr[i][j]);if(pathStart[i]!=="A"){if(j===0){newPathArr[i][j]=newPathArr[i][j]-symbolBBox.x}else if(j===1){newPathArr[i][j]=newPathArr[i][j]-symbolBBox.y}}else if(pathStart[i]==="A"){if(j===5){newPathArr[i][j]=newPathArr[i][j]-symbolBBox.x}else if(j===6){newPathArr[i][j]=newPathArr[i][j]-symbolBBox.y}}}}finalPath+=pathStart[i]+newPathArr[i].toString()}}finalPath=finalPath+"Z"}parserConfig={toolText:config.tooltext,dominantNode:getUniqueNodes(config.dominantNode),subservientNode:getUniqueNodes(config.subservientNode),dominantFlowDataValue:getUniqueNodes(config.dominantFlowDataValue),subservientFlowDataValue:getUniqueNodes(config.subservientFlowDataValue)};parserConfig.dominantFlowValue=getDominantFlowValue(config,parserConfig.dominantNode);parserConfig.subservientFlowValue=getDominantFlowValue(config,parserConfig.subservientNode);parserConfig.dominantPlotIdentifier=getPlotIdentifier(getUniqueNodes(config.dominantNodeColor),uniChar,dominantLegendItem,finalPath);parserConfig.subservientPlotIdentifier=getPlotIdentifier(getUniqueNodes(config.subservientNodeColor),uniChar,subservientLegendItem,finalPath);linkToolText=(0,_lib.parseTooltext)(config.tooltext,macroIndices,parserConfig,config);config.setLinkToolText=linkToolText;for(key in config.tooltip){if(config.tooltip.hasOwnProperty(key)){body+="\n          <span style='color: "+config.tooltip[key].color+";'>\n            "+uniChar+"\n          </span>\n          "+(key+config.toolTipSepChar)+"\n          "+(config.showLinkValueOnHover?" &nbsp;":"")+"\n          "+(config.showLinkValueOnHover?config.tooltip[key].value:"")+"\n        <br>"}}if(!config.tooltext){return"<div style='padding: 2px; vertical-align: middle; font-size: "+basefontsize+"px;'>\n          "+body+"\n        </div>"}return"<div style='padding: 2px; vertical-align: middle; font-size: "+basefontsize+"px;'>\n        "+config.setLinkToolText+"\n      </div>"};var Ribbon=function(_SmartRenderer){(0,_inheritsLoose2.default)(Ribbon,_SmartRenderer);function Ribbon(id){var _this;_this=_SmartRenderer.call(this,id)||this;_this.addEventListener("fc-mouseover",mouseOverFn);_this.addEventListener("fc-mouseout",mouseOutFn);_this.addEventListener("fc-click",mouseClickFn);return _this}var _proto=Ribbon.prototype;_proto.configureAttributes=function configureAttributes(dataObj){_SmartRenderer.prototype.configureAttributes.call(this,dataObj);Object.assign(this.config,dataObj)};_proto.setDimension=function setDimension(dim){this.config.radius=dim.radius};_proto.allocatePosition=function allocatePosition(){var config=this.config;config.path=ribbonGenerator(config.points,config.radius,0);config.ribbonAttrs=config.hovered?config.focussedState:config.unfocussed?config.unfocussedState:config.normalState;config.ribbonAttrs.path=config.path;config.ribbonAttrs["stroke-width"]=(config.showBorder?config.borderThickness:0)||0};_proto.draw=function draw(){var ribbon=this,chartConfig=ribbon.getFromEnv("chart").config,height=chartConfig.canvasHeight,width=chartConfig.canvasWidth,cx=chartConfig.canvasLeft+width/2,cy=chartConfig.canvasTop+height/2,chartWidth=chartConfig.width,chartHeight=chartConfig.height,ribbonRadius=chartConfig.ribbonRadius,config=ribbon.config,angles=config.angles,tooltext=config.showToolTip?getTooltext(config,chartConfig,chartConfig.style.baseFontSize,ribbon):_lib.BLANKSTRING,_polarToCartesian2=(0,_polarUtil.polarToCartesian)(ribbonRadius,normalizeAngles((0,_polarUtil.deg2Rad)(angles[0]))),x1=_polarToCartesian2.x,y1=_polarToCartesian2.y,_polarToCartesian3=(0,_polarUtil.polarToCartesian)(ribbonRadius,normalizeAngles((0,_polarUtil.deg2Rad)(angles[3]))),x2=_polarToCartesian3.x,y2=_polarToCartesian3.y;if(config.dominantNode.length>1&&config.rawColor){config.ribbonAttrs.fill=(0,_lib.toRaphaelColor)({color:config.rawColor[0]+","+config.rawColor[1],alpha:config.hovered?config.hoverAlpha:config.unfocussed?config.unfocussedAlpha:config.alpha,x1:(x1+cx)/chartWidth,y1:(y1+cy)/chartHeight,x2:(x2+cx)/chartWidth,y2:(y2+cy)/chartHeight});config.ribbonAttrs.stroke=(0,_lib.toRaphaelColor)({color:config.rawColor[0]+","+config.rawColor[1],alpha:config.hovered?config.hoveredAlpha:config.unfocussed?config.unfocussedAlpha:config.borderAlpha,x1:(x1+cx)/chartWidth,y1:(y1+cy)/chartHeight,x2:(x2+cx)/chartWidth,y2:(y2+cy)/chartHeight})}ribbon.addGraphicalElement({el:"path",label:"ribbon",tooltext:tooltext,attr:config.ribbonAttrs,container:{id:"link-container",isParent:true},component:ribbon})};_proto.getName=function getName(){return"ribbon"};_proto.getType=function getType(){return"dataset"};return Ribbon}(_componentInterface.SmartRenderer);var _default=Ribbon;exports.default=_default;