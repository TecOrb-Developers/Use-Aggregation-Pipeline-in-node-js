"use strict";var _interopRequireDefault=require("@babel/runtime/helpers/interopRequireDefault");exports.__esModule=true;exports.default=void 0;var _inheritsLoose2=_interopRequireDefault(require("@babel/runtime/helpers/inheritsLoose"));var _componentInterface=require("@fusioncharts/core/src/component-interface");var _polarUtil=require("@fusioncharts/utils/src/scale-utils/polar-util");var _utils=require("../../chart/chord/utils");var _lib=require("@fusioncharts/core/src/lib");var _pieLabelUtils=require("@fusioncharts/charts/src/dataset/pie2d/pie-label-utils");var nodeGenerator=function nodeGenerator(_startAngle,_endAngle,arc,outerRadius,innerRadius){var startAngle=(0,_utils.normaliseAngle)(_startAngle),endAngle=(0,_utils.normaliseAngle)(_endAngle),_polarToCartesian=(0,_polarUtil.polarToCartesian)(outerRadius,startAngle,false),x1=_polarToCartesian.x,y1=_polarToCartesian.y,_polarToCartesian2=(0,_polarUtil.polarToCartesian)(outerRadius,endAngle,false),x2=_polarToCartesian2.x,y2=_polarToCartesian2.y,_polarToCartesian3=(0,_polarUtil.polarToCartesian)(innerRadius,startAngle,false),x3=_polarToCartesian3.x,y3=_polarToCartesian3.y,_polarToCartesian4=(0,_polarUtil.polarToCartesian)(innerRadius,endAngle,false),x4=_polarToCartesian4.x,y4=_polarToCartesian4.y;x1=(0,_lib.toPrecision)(x1,4);y1=(0,_lib.toPrecision)(y1,4);x2=(0,_lib.toPrecision)(x2,4);y2=(0,_lib.toPrecision)(y2,4);x3=(0,_lib.toPrecision)(x3,4);y3=(0,_lib.toPrecision)(y3,4);x4=(0,_lib.toPrecision)(x4,4);y4=(0,_lib.toPrecision)(y4,4);return[_utils.M,x1,y1,_utils.A,outerRadius,outerRadius,0,arc>180?1:0,1,x2,y2,_utils.L,x4,y4,_utils.A,innerRadius,innerRadius,0,arc>180?1:0,0,x3,y3,_utils.Z]},labelPathGenerator=function labelPathGenerator(_startAngle,_endAngle,arc,radius){var _polarToCartesian5=(0,_polarUtil.polarToCartesian)(radius,(0,_utils.normaliseAngle)(_startAngle),false),x1=_polarToCartesian5.x,y1=_polarToCartesian5.y,_polarToCartesian6=(0,_polarUtil.polarToCartesian)(radius,(0,_utils.normaliseAngle)(_endAngle),false),x2=_polarToCartesian6.x,y2=_polarToCartesian6.y;return"M "+x1+" "+y1+" A "+radius+" "+radius+" "+0+" "+(arc>180?1:0)+" "+(_startAngle>_endAngle?0:1)+" "+x2+" "+y2},RED="#ff0000",LABEL_POSITION_TANGENTIAL="tangential",LABEL_POSITION_OUTSIDE="outside",LABEL_POSITION_INSIDE="inside",START="start",PADDING=4,clickFn=function clickFn(e){var node=this,manager=node.getLinkedParent(),legend=node.getFromEnv("legend"),chart=node.getFromEnv("chart"),legendItem=legend?legend.getItem(manager.config.legendItemMap[node.config.label]):null;var eventArgs={};setEventArgs(eventArgs,node);manager.nodeClicked(node.config.label,legendItem);chart.plotEventHandler(null,e,"dataplotclick",eventArgs)},END="end",mouseOverFn=function mouseOverFn(e){var node=this,chart=node.getFromEnv("chart");this.getLinkedParent().nodeHoverIn(this.config.label);var eventArgs={};setEventArgs(eventArgs,node);chart.plotEventHandler(null,e,"DataPlotRollOver",eventArgs)},mouseOutFn=function mouseOutFn(e){var node=this,chart=node.getFromEnv("chart");this.getLinkedParent().nodeHoverOut(this.config.label);var eventArgs={};setEventArgs(eventArgs,node);chart.plotEventHandler(null,e,"DataPlotRollOut",eventArgs)},setEventArgs=function setEventArgs(eventArgs,node){var manager=node.getLinkedParent();eventArgs.label=node.config.label;eventArgs.color=node.config.color;eventArgs.alpha=node.config.alpha;eventArgs.links={};eventArgs.value=node.config.total;eventArgs.displayValue=node.config.formattedValue;eventArgs.nodeValue=node.config.nodevalue;eventArgs.nodeDataValue=node.config.nodedatavalue;eventArgs.plotFillColor=node.config.plotfillcolor;eventArgs.toolText=node.config.tooltext;var i;for(i=0;i<node.config.linkedLinks.length;i++){var j=node.config.linkedLinks[i],obj=manager.config.links[j],arrValues=[],currentnodelabel=eventArgs.label,currentnodevalue={},linkednodelabel=void 0,linkednodevalue={};currentnodevalue[currentnodelabel]=obj[currentnodelabel];linkednodelabel=j.replace(currentnodelabel,"").replace(",","");linkednodevalue[linkednodelabel]=obj[linkednodelabel];arrValues.push(currentnodevalue);if(linkednodelabel!==currentnodelabel&&!(obj[linkednodelabel]===_lib.UNDEF)){arrValues.push(linkednodevalue)}eventArgs.links[j]=arrValues}},getTooltext=function getTooltext(config,node,chartConfig){var uniChar=_lib.isIpad?_utils.SMALLSQUARE:_utils.MEDIUMSQUARE,macroIndices=[3,133,134,143,144,145],basefontsize=node.computeFontSize(chartConfig.style.inCanfontSizeWithUnit),manager=node.getLinkedParent(),drawCustomLegendIcon=chartConfig&&chartConfig.drawcustomlegendicon,legend=node.getFromEnv("legend"),pathArr,newPathArr=[],i,j,symbolBBox,legendItemSymbol,plotToolText,pathStart=[],finalPath,legendItem=drawCustomLegendIcon&&legend&&legend.config&&legend.config.isActive?legend.getItem(manager.config.legendItemMap[node.config.label]):null,graphicalElement=legendItem&&legendItem.getGraphicalElement(),parserConfig,toolText;finalPath=_lib.BLANKSTRING;if(legendItem){legendItemSymbol=graphicalElement&&graphicalElement.legendItemSymbol;pathArr=legendItemSymbol&&legendItemSymbol.attrs.path.split(/(?=[LMCA])/);symbolBBox=legendItemSymbol&&legendItemSymbol.node.getBBox();if(pathArr&&pathArr.length){for(i=0;i<pathArr.length;i++){pathStart.push(pathArr[i][0]);pathArr[i]=pathArr[i].substring(1,pathArr[i].length);if(i===pathArr.length-1){pathArr[i]=pathArr[i].substring(0,pathArr[i].length-1)}newPathArr[i]=pathArr[i].split(",")}}if(newPathArr&&newPathArr.length){for(i=0;i<newPathArr.length;i++){if(newPathArr[i].length){for(j=0;j<newPathArr[i].length;j++){newPathArr[i][j]=Number(newPathArr[i][j]);if(pathStart[i]!=="A"){if(j===0){newPathArr[i][j]=newPathArr[i][j]-symbolBBox.x}else if(j===1){newPathArr[i][j]=newPathArr[i][j]-symbolBBox.y}}else if(pathStart[i]==="A"){if(j===5){newPathArr[i][j]=newPathArr[i][j]-symbolBBox.x}else if(j===6){newPathArr[i][j]=newPathArr[i][j]-symbolBBox.y}}}}finalPath+=pathStart[i]+newPathArr[i].toString()}}finalPath=finalPath+"Z"}parserConfig={label:config.label,value:config.total,nodeValue:config.total,nodeDataValue:config.formattedValue,plotFillColor:config.color,plotFillAlpha:config.alpha,plotIdentifier:legendItem?"<svg height= "+symbolBBox.height+" width = "+symbolBBox.width+" overflow='visible' xmlns=\"http://www.w3.org/2000/svg\">\n      <path d= "+finalPath+" fill = "+graphicalElement.legendItemSymbol.node.getAttribute("fill")+" stroke = "+graphicalElement.legendItemSymbol.node.getAttribute("stroke")+"\n      stroke-opacity = "+graphicalElement.legendItemSymbol.node.getAttribute("stroke-opacity")+" fill-opacity = "+graphicalElement.legendItemSymbol.node.getAttribute("fill-opacity")+" \n      stroke-width = "+graphicalElement.legendItemSymbol.node.getAttribute("stroke-width")+" stroke-linecap = "+graphicalElement.legendItemSymbol.node.getAttribute("stroke-linecap")+"></path>\n    </svg>":"<span style='color: "+config.color+";'>"+uniChar+"&nbsp;</span>"};toolText=(0,_lib.parseTooltext)(config.tooltext,macroIndices,parserConfig,{label:config.label,value:config.formattedValue,nodeValue:config.total,nodeDataValue:config.formattedValue,plotFillColor:config.color,plotFillAlpha:config.alpha,plotIdentifier:legendItem?"<svg height= "+symbolBBox.height+" width = "+symbolBBox.width+" overflow='visible' xmlns=\"http://www.w3.org/2000/svg\">\n        <path d= "+finalPath+" fill = "+graphicalElement.legendItemSymbol.node.getAttribute("fill")+" stroke = "+graphicalElement.legendItemSymbol.node.getAttribute("stroke")+"\n        stroke-opacity = "+graphicalElement.legendItemSymbol.node.getAttribute("stroke-opacity")+" fill-opacity = "+graphicalElement.legendItemSymbol.node.getAttribute("fill-opacity")+" \n        stroke-width = "+graphicalElement.legendItemSymbol.node.getAttribute("stroke-width")+" stroke-linecap = "+graphicalElement.legendItemSymbol.node.getAttribute("stroke-linecap")+"></path>\n      </svg>":"<span style='color: "+config.color+";'>"+uniChar+"&nbsp;</span>"});plotToolText=(0,_lib.parseTooltext)(config.tooltext,macroIndices,parserConfig,{label:config.label,value:config.formattedValue,nodeValue:config.total,nodeDataValue:config.formattedValue,plotFillColor:config.color,plotFillAlpha:config.alpha,plotIdentifier:legendItem?"<svg height= "+symbolBBox.height+" width = "+symbolBBox.width+" overflow='visible' xmlns=\"http://www.w3.org/2000/svg\">\n        <path d= "+finalPath+" fill = "+graphicalElement.legendItemSymbol.node.getAttribute("fill")+" stroke = "+graphicalElement.legendItemSymbol.node.getAttribute("stroke")+"\n        stroke-opacity = "+graphicalElement.legendItemSymbol.node.getAttribute("stroke-opacity")+" fill-opacity = "+graphicalElement.legendItemSymbol.node.getAttribute("fill-opacity")+" \n        stroke-width = "+graphicalElement.legendItemSymbol.node.getAttribute("stroke-width")+" stroke-linecap = "+graphicalElement.legendItemSymbol.node.getAttribute("stroke-linecap")+"></path>\n      </svg>":"<span style='color: "+config.color+";'>"+uniChar+"&nbsp;</span>"});config.setToolText=toolText;config.setPlotTooltext=config.setToolText?config.setToolText:plotToolText;if(!config.tooltext){return"<div style='padding: 2px; vertical-align: middle; font-size: "+basefontsize+"px;'>\n          <span style='color: "+config.color+";'>\n              "+uniChar+"\n          </span>\n          "+(config.label+config.toolTipSepChar)+"\n          &nbsp;\n          "+config.formattedValue+"\n        </div>"}return"<div style='padding: 2px; vertical-align: middle; font-size: "+basefontsize+"px;'>\n        <span style='color: "+config.color+";'>\n            "+uniChar+"\n        </span>\n        "+config.setPlotTooltext+"\n      </div>"};var Node=function(_SmartRenderer){(0,_inheritsLoose2.default)(Node,_SmartRenderer);function Node(id){var _this;_this=_SmartRenderer.call(this,id)||this;_this.addEventListener("fc-click",clickFn);_this.addEventListener("fc-mouseover",mouseOverFn);_this.addEventListener("fc-mouseout",mouseOutFn);return _this}var _proto=Node.prototype;_proto.__setDefaultConfig=function __setDefaultConfig(){_SmartRenderer.prototype.__setDefaultConfig.call(this);var config=this.config;config.styles={fill:RED,stroke:RED,"fill-alpha":.7}};_proto.configureAttributes=function configureAttributes(dataObj){_SmartRenderer.prototype.configureAttributes.call(this,dataObj);Object.assign(this.config,dataObj);var node=this;node.config.formattedValue=node.getFromEnv("number-formatter").dataLabels(node.config.total);node.config.formattedNodeDataValue=node.getFromEnv("number-formatter").dataLabels(node.config.nodedatavalue)};_proto.setDimension=function setDimension(dim){Object.assign(this.config,dim)};_proto.allocatePosition=function allocatePosition(){var node=this,config=node.config,label=config.label,_node$getFromEnv=node.getFromEnv("chartConfig"),canvasHeight=_node$getFromEnv.canvasHeight,canvasWidth=_node$getFromEnv.canvasWidth,cx=_node$getFromEnv.cx,cy=_node$getFromEnv.cy,style=_node$getFromEnv.style,slope,labelOrientation=config.labelPosition,applicableRadius=config.outerRadius+config.nodeLabelGap,smartLabel=node.getFromEnv("smartLabel"),startingAngle=(0,_utils.normaliseAngle)(config.startingAngle),endingAngle=(0,_utils.normaliseAngle)(config.endingAngle),labelAttrs={},smartLabelOutput,fontSize,lineHeight,labelCatersianPosition;config.style["font-size"]=fontSize=this.computeFontSize(style.inCanfontSizeWithUnit);lineHeight=(0,_lib.setLineHeight)({fontSize:fontSize}).replace(/px/gi,_lib.BLANKSTRING);smartLabel.setStyle(config.style);smartLabel.useEllipsesOnOverflow(node.getFromEnv("chartConfig").useEllipsesOnOverflow);switch(labelOrientation){case LABEL_POSITION_TANGENTIAL:{var labelAngleCenter=(startingAngle+endingAngle)/2%360,x2,y2,spaceRemaining=0;labelCatersianPosition=(0,_polarUtil.polarToCartesian)(applicableRadius,labelAngleCenter,false);var quadrant=(0,_pieLabelUtils.getQuadrant)((0,_polarUtil.deg2Rad)(labelAngleCenter));switch(quadrant){case 0:x2=canvasWidth/2;y2=canvasHeight/2;slope=Math.tan((0,_polarUtil.deg2Rad)(360-labelAngleCenter));if(Math.abs(x2*slope)<=y2){spaceRemaining=(0,_utils.getCartesianDistance)(labelCatersianPosition.x+cx,labelCatersianPosition.y+cy,cx+x2,cy-x2*slope)}else{spaceRemaining=(0,_utils.getCartesianDistance)(labelCatersianPosition.x+cx,labelCatersianPosition.y+cy,cx-y2/slope,cy+y2)}break;case 1:x2=-1*canvasWidth/2;y2=canvasHeight/2;slope=Math.tan((0,_polarUtil.deg2Rad)(180+labelAngleCenter));if(Math.abs(x2*slope)<=Math.abs(y2)){spaceRemaining=(0,_utils.getCartesianDistance)(labelCatersianPosition.x+cx,labelCatersianPosition.y+cy,cx+x2,cy+x2*slope)}else{spaceRemaining=(0,_utils.getCartesianDistance)(labelCatersianPosition.x+cx,labelCatersianPosition.y+cy,cx+y2/slope,cy+y2)}break;case 2:x2=-1*canvasWidth/2;y2=-1*(canvasHeight/2);slope=Math.tan((0,_polarUtil.deg2Rad)(360-labelAngleCenter));if(Math.abs(x2*slope)<=Math.abs(y2)){spaceRemaining=(0,_utils.getCartesianDistance)(labelCatersianPosition.x+cx,labelCatersianPosition.y+cy,cx+x2,cy-x2*slope)}else{spaceRemaining=(0,_utils.getCartesianDistance)(labelCatersianPosition.x+cx,labelCatersianPosition.y+cy,cx-y2/slope,cy+y2)}break;case 3:x2=canvasWidth/2;y2=-1*(canvasHeight/2);slope=Math.tan((0,_polarUtil.deg2Rad)(-1*labelAngleCenter));if(Math.abs(x2*slope)<=Math.abs(y2)){spaceRemaining=(0,_utils.getCartesianDistance)(labelCatersianPosition.x+cx,labelCatersianPosition.y+cy,cx+x2,cy-x2*slope)}else{spaceRemaining=(0,_utils.getCartesianDistance)(labelCatersianPosition.x+cx,labelCatersianPosition.y+cy,cx-y2/slope,cy+y2)}break;default:;}smartLabelOutput=smartLabel.getSmartText(label,spaceRemaining,lineHeight);labelAttrs.transform=(0,_lib.getSuggestiveRotation)((0,_utils.getTextRotationByQuadrant)(labelAngleCenter),labelCatersianPosition.x,labelCatersianPosition.y);if((0,_utils.isAngleInLeftHemisphere)(labelAngleCenter)){labelAttrs["text-anchor"]=END}labelAttrs.x=labelCatersianPosition.x;labelAttrs.y=labelCatersianPosition.y;break}case LABEL_POSITION_OUTSIDE:{var labelAngleCenterDeg=(startingAngle+endingAngle)/2%360,labelAngleCenterRad=(0,_polarUtil.deg2Rad)(labelAngleCenterDeg),labelAngleCenterCleanRad=(0,_pieLabelUtils.getCleanAngle)(labelAngleCenterRad),labelAngleCenterCleanDeg=(0,_polarUtil.rad2Deg)(labelAngleCenterCleanRad),isLabelCenterInTopHemisphere=(0,_utils.isAngleInTopHemisphere)(labelAngleCenterCleanDeg),arcLength=(0,_utils.getArcLength)(applicableRadius,startingAngle,endingAngle),textPathStartAngle=isLabelCenterInTopHemisphere?config.startingAngle:config.endingAngle,textPathEndAngle=isLabelCenterInTopHemisphere?config.endingAngle:config.startingAngle;smartLabelOutput=smartLabel.getSmartText(label,arcLength-PADDING,lineHeight);if(_lib.isIE11){if(!isLabelCenterInTopHemisphere){applicableRadius+=smartLabelOutput.height*.7}}labelAttrs.textpath={path:labelPathGenerator(textPathStartAngle,textPathEndAngle,config.arcAngle,applicableRadius),startOffset:"50%"};labelAttrs[_lib.TEXTANCHOR]=_lib.MIDDLESTR;labelAttrs["vertical-align"]=isLabelCenterInTopHemisphere?"top":"bottom";labelAttrs.transform=null;labelAttrs.x=0;labelAttrs.y=0;break}case LABEL_POSITION_INSIDE:default:{var _labelAngleCenterDeg=(startingAngle+endingAngle)/2%360,_labelAngleCenterRad=(0,_polarUtil.deg2Rad)(_labelAngleCenterDeg),_labelAngleCenterCleanRad=(0,_pieLabelUtils.getCleanAngle)(_labelAngleCenterRad),_labelAngleCenterCleanDeg=(0,_polarUtil.rad2Deg)(_labelAngleCenterCleanRad),_isLabelCenterInTopHemisphere=(0,_utils.isAngleInTopHemisphere)(_labelAngleCenterCleanDeg),middleRadius=(config.outerRadius+config.innerRadius)/2,_arcLength=(0,_utils.getArcLength)(middleRadius,startingAngle,endingAngle),_textPathStartAngle=_isLabelCenterInTopHemisphere?config.startingAngle:config.endingAngle,_textPathEndAngle=_isLabelCenterInTopHemisphere?config.endingAngle:config.startingAngle;smartLabelOutput=smartLabel.getSmartText(label,_arcLength-PADDING,lineHeight);if(_lib.isIE11){if(_isLabelCenterInTopHemisphere){middleRadius-=smartLabelOutput.height*.3}else{middleRadius+=smartLabelOutput.height*.3}}labelAttrs.textpath={path:labelPathGenerator(_textPathStartAngle,_textPathEndAngle,config.arcAngle,middleRadius),startOffset:"50%"};labelAttrs[_lib.TEXTANCHOR]=_lib.MIDDLESTR;labelAttrs["vertical-align"]=_lib.MIDDLESTR;labelAttrs.transform=null;labelAttrs.x=0;labelAttrs.y=0;break}}labelAttrs.fill=(0,_lib.convertColor)(config.labelColor,100);labelAttrs.text=smartLabelOutput.text;labelAttrs.cursor=_lib.POINTER;labelAttrs["text-anchor"]=labelAttrs["text-anchor"]||START;node.config.labelAttrs=labelAttrs;node.config.path=nodeGenerator(config.startingAngle,config.endingAngle,config.arcAngle,config.outerRadius,config.innerRadius);node.config.focussedState.path=node.config.path;node.config.normalState.path=node.config.path;node.config.unfocussedState.path=node.config.path;node.config.deactiveState.path=node.config.path};_proto.draw=function draw(){var node=this,config=node.config,chartConfig=node.getFromEnv("chartConfig"),tooltext=config.showToolTip?getTooltext(config,this,chartConfig):_lib.BLANKSTRING;var nodeAttr;if(node.config.active){nodeAttr=config.hovered?config.focussedState:config.unfocussed?config.unfocussedState:config.normalState}else{nodeAttr=config.deactiveState}nodeAttr.cursor=_lib.POINTER;node.addGraphicalElement({el:"group",container:{id:"node-container",isParent:true},tooltext:tooltext,component:node,label:"text-path-container",id:"text-path-container",attr:{name:"text-path-container"}});node.addGraphicalElement({el:"path",label:"node",tooltext:tooltext,container:{id:"text-path-container"},attr:nodeAttr,component:node},true);if(config.showLabel){node.addGraphicalElement({el:"text",label:"node-label",container:{id:"text-path-container"},attr:config.labelAttrs,outlineText:!!chartConfig.textOutline,css:{},tooltext:tooltext,component:node},true)}};_proto._manageSpace=function _manageSpace(spaceArguments){var node=this,config=node.config,smartLabel=node.getFromEnv("smartLabel");var oriSize,smartText,spaceRequired;smartLabel.setStyle(config.style);oriSize=smartLabel.getOriSize(config.label);if(!config.showLabel){return 0}if(config.labelPosition===LABEL_POSITION_TANGENTIAL){if(oriSize.width>spaceArguments.maxSpace){smartText=smartLabel.getSmartText(config.label,spaceArguments.maxSpace,oriSize.height);spaceRequired=smartText.width}else{spaceRequired=oriSize.width}}else if(config.labelPosition===LABEL_POSITION_OUTSIDE){spaceRequired=oriSize.height}else{spaceRequired=0}return spaceRequired};_proto.getName=function getName(){return"node"};_proto.getType=function getType(){return"dataset"};return Node}(_componentInterface.SmartRenderer);var _default=Node;exports.default=_default;