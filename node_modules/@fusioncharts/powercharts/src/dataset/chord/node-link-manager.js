"use strict";var _interopRequireDefault=require("@babel/runtime/helpers/interopRequireDefault");exports.__esModule=true;exports.default=void 0;var _defineProperty2=_interopRequireDefault(require("@babel/runtime/helpers/defineProperty"));var _inheritsLoose2=_interopRequireDefault(require("@babel/runtime/helpers/inheritsLoose"));var _componentInterface=require("@fusioncharts/core/src/component-interface");var _chordNodeFactory=_interopRequireDefault(require("../../factories/chord-node-factory"));var _chordLinkFactory=_interopRequireDefault(require("../../factories/chord-link-factory"));var _lib=require("@fusioncharts/core/src/lib");function ownKeys(object,enumerableOnly){var keys=Object.keys(object);if(Object.getOwnPropertySymbols){var symbols=Object.getOwnPropertySymbols(object);if(enumerableOnly){symbols=symbols.filter((function(sym){return Object.getOwnPropertyDescriptor(object,sym).enumerable}))}keys.push.apply(keys,symbols)}return keys}function _objectSpread(target){for(var i=1;i<arguments.length;i++){var source=arguments[i]!=null?arguments[i]:{};if(i%2){ownKeys(Object(source),true).forEach((function(key){(0,_defineProperty2.default)(target,key,source[key])}))}else if(Object.getOwnPropertyDescriptors){Object.defineProperties(target,Object.getOwnPropertyDescriptors(source))}else{ownKeys(Object(source)).forEach((function(key){Object.defineProperty(target,key,Object.getOwnPropertyDescriptor(source,key))}))}}return target}var comparator=function comparator(a,b){return a-b};var NodeLinkManager=function(_SmartRenderer){(0,_inheritsLoose2.default)(NodeLinkManager,_SmartRenderer);function NodeLinkManager(id){var _this;_this=_SmartRenderer.call(this,id)||this;_this.registerFactory("chord-node-factory",_chordNodeFactory.default);_this.registerFactory("chord-link-factory",_chordLinkFactory.default);return _this}var _proto=NodeLinkManager.prototype;_proto.__setDefaultConfig=function __setDefaultConfig(){_SmartRenderer.prototype.__setDefaultConfig.call(this);var config=this.config;config.total=0;config.adjustedTotal=0};_proto.configureAttributes=function configureAttributes(dataObj){_SmartRenderer.prototype.configureAttributes.call(this,dataObj);Object.assign(this.config,dataObj);var manager=this,config=manager.config,total,totalAngle=config.totalAngle,startingAngle=config.startingAngle,nodesOrder=config.nodesOrder,nodes=config.nodes,linksOrder=config.linksOrder,links=config.links;totalAngle-=config.nodeSpacing*nodesOrder.length;total=config.total=nodesOrder.reduce((function(acc,label){return acc+nodes[label].total}),0);config.adjustedTotal=nodesOrder.reduce((function(acc,label){var node=nodes[label];if(node.total/(total||1)<config.minNodeSize){node.adjustedTotal=(total||1)*config.minNodeSize}else{node.adjustedTotal=node.total}return acc+node.adjustedTotal}),0);config.interactiveLegend=(0,_lib.pluckNumber)(manager.getFromEnv("chart-attrib").interactivelegend,1);var angleRatio=totalAngle/config.adjustedTotal;nodesOrder.forEach((function(label){var node=nodes[label];node.startingAngle=startingAngle;node.arcAngle=node.adjustedTotal*angleRatio;node.endingAngle=startingAngle+node.arcAngle;node.scale.setRange([node.startingAngle,node.endingAngle]).setDomain([0,node.adjustedTotal]);startingAngle=node.endingAngle+config.nodeSpacing}));linksOrder.forEach((function(key){if(links[key].visible){var link=links[key],from=config.isPost?link.linkedNodes[1]:link.linkedNodes[0],to=config.isPost?link.linkedNodes[0]:link.linkedNodes[1],firstNode=nodes[from],secondNode=nodes[to],firstScale=firstNode.scale,secondScale=secondNode.scale,p1=firstScale.getRangeValue(firstNode.nodeCovered),p2=firstScale.getRangeValue(firstNode.nodeCovered+=link[from]||0),p3,p4;if(link.points.length){link.points.length=0}if(from===to){p3=p1;p4=p2}else{p3=secondScale.getRangeValue(secondNode.nodeCovered);p4=secondScale.getRangeValue(secondNode.nodeCovered+=link[to]||0)}link.points.push(p1,p2,p3,p4)}}));linksOrder.forEach((function(key){var link=links[key],dominantNode=link.dominantNode;link.angles=link.points.slice(0).sort(comparator);if(dominantNode.length>1&&nodes[dominantNode[0]].rawColor!==nodes[dominantNode[1]].rawColor){var linkArray=nodes[dominantNode[0]].index>nodes[dominantNode[1]].index?[nodes[dominantNode[1]],nodes[dominantNode[0]]]:[nodes[dominantNode[0]],nodes[dominantNode[1]]];link.rawColor=[linkArray[0].rawColor,linkArray[1].rawColor]}else{link.normalState.fill=(0,_lib.convertColor)(nodes[dominantNode[0]].rawColor,link.alpha);link.normalState.stroke=(0,_lib.convertColor)(nodes[dominantNode[0]].rawColor,link.borderAlpha);link.focussedState.fill=(0,_lib.convertColor)(nodes[dominantNode[0]].rawColor,link.hoverAlpha);link.focussedState.stroke=link.focussedState.fill;link.unfocussedState.fill=(0,_lib.convertColor)(nodes[dominantNode[0]].rawColor,link.unfocussedAlpha);link.unfocussedState.stroke=link.unfocussedState.fill}}))};_proto.setDimension=function setDimension(dim){var manager=this,config=manager.config;Object.assign(config,dim);manager.getChildren("node")&&manager.getChildren("node").forEach((function(node){return!node.getState("removed")&&node.setDimension({outerRadius:config.nodeOuterRadius,innerRadius:config.nodeInnerRadius})}));manager.getChildren("ribbon")&&manager.getChildren("ribbon").forEach((function(link){return!link.getState("removed")&&link.setDimension({radius:config.ribbonRadius})}))};_proto._manageSpace=function _manageSpace(spaceArguments){var manager=this,widths=manager.getChildren("node").map((function(node){return node._manageSpace(spaceArguments)})),maxWidth=Math.max.apply(Math,widths);return{width:maxWidth,height:maxWidth}};_proto._createContainer=function _createContainer(){var manager=this,config=manager.config;manager.addGraphicalElement({el:"group",container:{id:"plotGroup",isParent:true},component:manager,label:"link-container",id:"link-container",attr:{name:"link-container",transform:config.translate}});manager.addGraphicalElement({el:"group",container:{id:"plotGroup",isParent:true},component:manager,label:"node-container",id:"node-container",attr:_objectSpread({name:"node-container",transform:config.translate},config.datalabelStyle)})};_proto.draw=function draw(){this._createContainer()};_proto.getName=function getName(){return"node-link-manager"};_proto.getType=function getType(){return"node-link-manager"};_proto._addLegend=function _addLegend(){var manager=this,config=manager.config,nodes=config.nodes,nodesOrder=config.nodesOrder,legend=manager.getFromEnv("legend"),legendItem,legendItemId,legendItemMap=config.legendItemMap||(config.legendItemMap={}),curLegendItems=new Set;Object.keys(legendItemMap).forEach((function(key){return curLegendItems.add(legendItemMap[key])}));nodesOrder.forEach((function(label){var node=nodes[label];legendItemId=legendItemMap[label];legendItem=legend.getItem(legendItemId);if(!legendItem){legendItemId=legend.createItem();legendItem=legend.getItem(legendItemId);legendItemMap[label]=legendItemId;manager.addExtEventListener("fc-click",(function(){if(manager.config.interactiveLegend){var clickedNode=manager.config.nodes[label],item=legend.getItem(legendItemMap[label]);manager.nodeClicked(clickedNode.label,item)}}),legendItem);manager.addExtEventListener("fc-mouseover",(function(){if(manager.config.interactiveLegend){manager.nodeHoverIn(label)}}),legendItem);manager.addExtEventListener("fc-mouseout",(function(){if(manager.config.interactiveLegend){manager.nodeHoverOut(label)}}),legendItem)}else{legendItem.removeLegendState("hidden");curLegendItems["delete"](legendItemId)}legendItem.configure({enabled:true,label:label});legendItem.setStateCosmetics("default",{symbol:{rawFillColor:node.color,rawStrokeColor:node.color,fill:node.color,stroke:node.color}})}));curLegendItems.forEach((function(item){legend.disposeItem(item)}))};_proto.nodeClicked=function nodeClicked(clickedNodeLabel,legendItem){if(this.config.enableToggle){var config=this.config,nodes=config.nodes,nodesOrder=config.nodesOrder,links=config.links,clickedNode=nodes[clickedNodeLabel],linkedLinks=clickedNode.linkedLinks,isActive=clickedNode.active;if(clickedNode.active){legendItem&&legendItem.setLegendState("hidden")}else{legendItem&&legendItem.removeLegendState("hidden")}clickedNode.active=!isActive;linkedLinks.forEach((function(key){var link=links[key],from=config.isPost?link.linkedNodes[1]:link.linkedNodes[0],to=config.isPost?link.linkedNodes[0]:link.linkedNodes[1],fromNode=nodes[from],toNode=nodes[to],isVisisble=link.visible;link.visible=fromNode.active&&toNode.active;if(link.visible!==isVisisble){if(link.visible){fromNode.total=(0,_lib.toPrecision)(fromNode.total+(link[from]||0),4);if(to!==from){toNode.total=(0,_lib.toPrecision)(toNode.total+(link[to]||0),4)}}else{fromNode.total=(0,_lib.toPrecision)(fromNode.total-(link[from]||0),4);if(to!==from){toNode.total=(0,_lib.toPrecision)(toNode.total-(link[to]||0),4)}}}}));nodesOrder.forEach((function(label){return nodes[label].nodeCovered=0}));if(isActive){this.nodeHoverOut(clickedNodeLabel,false)}else{this.nodeHoverIn(clickedNodeLabel,false)}this.setData({},true);this.setDimension()}};_proto.linkHoverIn=function linkHoverIn(linkKey,registerDraw){if(registerDraw===void 0){registerDraw=true}if(this.config.highlightEffect){var manager=this,config=manager.config,links=config.links,nodes=config.nodes,nodesOrder=config.nodesOrder,linksOrder=config.linksOrder,hoveredLink=links[linkKey],hoveredNodes=hoveredLink.linkedNodes;nodesOrder.forEach((function(label){var node=nodes[label],child=manager.getChild(label);if(!child||child.getState("removed")){return}if(hoveredNodes.includes(label)){node.hovered=true;node.unfocussed=false}else{node.hovered=false;node.unfocussed=true}registerDraw&&child.setData({hovered:node.hovered,unfocussed:node.unfocussed},true)}));linksOrder.forEach((function(key){var link=links[key],child=manager.getChild(key);if(!child||child.getState("removed")){return}if(key===linkKey){link.hovered=true;link.unfocussed=false}else{link.hovered=false;link.unfocussed=true}registerDraw&&child.setData({hovered:link.hovered,unfocussed:link.unfocussed},true)}));registerDraw&&this.setDimension()}};_proto.resetEffect=function resetEffect(registerDraw){if(registerDraw===void 0){registerDraw=true}var manager=this,config=manager.config,links=config.links,nodes=config.nodes,nodesOrder=config.nodesOrder,linksOrder=config.linksOrder;nodesOrder.forEach((function(label){var node=nodes[label],child=manager.getChild(label);if(!child||child.getState("removed")){return}node.hovered=false;node.unfocussed=false;registerDraw&&child.setData({hovered:node.hovered,unfocussed:node.unfocussed},true)}));linksOrder.forEach((function(key){var link=links[key],child=manager.getChild(key);if(!child||child.getState("removed")){return}link.hovered=false;link.unfocussed=false;registerDraw&&child.setData({hovered:link.hovered,unfocussed:link.unfocussed},true)}));this.setDimension()};_proto.linkHoverOut=function linkHoverOut(linkKey,registerDraw){if(registerDraw===void 0){registerDraw=true}if(this.config.highlightEffect){this.resetEffect(registerDraw)}};_proto.nodeHoverIn=function nodeHoverIn(labelKey,registerDraw){if(registerDraw===void 0){registerDraw=true}if(this.config.highlightEffect){var manager=this,config=manager.config,links=config.links,nodes=config.nodes,nodesOrder=config.nodesOrder,linksOrder=config.linksOrder,hoveredNode=nodes[labelKey],hoveredLinks=hoveredNode.linkedLinks,affectedNodes=hoveredLinks.map((function(key){return links[key].linkedNodes[0]===labelKey?links[key].linkedNodes[1]:links[key].linkedNodes[0]}));affectedNodes.push(labelKey);nodesOrder.forEach((function(label){var node=nodes[label],child=manager.getChild(label);if(!child||child.getState("removed")){return}if(affectedNodes.includes(label)){node.hovered=true;node.unfocussed=false}else{node.hovered=false;node.unfocussed=true}registerDraw&&hoveredNode.active&&child.setData({hovered:node.hovered,unfocussed:node.unfocussed},true)}));linksOrder.forEach((function(key){var link=links[key],child=manager.getChild(key);if(!child||child.getState("removed")){return}if(hoveredLinks.includes(key)){link.hovered=true;link.unfocussed=false}else{link.hovered=false;link.unfocussed=true}registerDraw&&hoveredNode.active&&child.setData({hovered:link.hovered,unfocussed:link.unfocussed},true)}));registerDraw&&hoveredNode.active&&this.setDimension()}};_proto.nodeHoverOut=function nodeHoverOut(labelKey,registerDraw){if(registerDraw===void 0){registerDraw=true}if(this.config.highlightEffect){this.resetEffect(registerDraw)}};return NodeLinkManager}(_componentInterface.SmartRenderer);var _default=NodeLinkManager;exports.default=_default;