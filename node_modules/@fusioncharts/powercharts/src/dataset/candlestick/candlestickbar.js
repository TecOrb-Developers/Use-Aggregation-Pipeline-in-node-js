"use strict";var _interopRequireDefault=require("@babel/runtime/helpers/interopRequireDefault");exports.__esModule=true;exports.default=void 0;var _inheritsLoose2=_interopRequireDefault(require("@babel/runtime/helpers/inheritsLoose"));var _lib=require("@fusioncharts/core/src/lib");var _column=_interopRequireDefault(require("@fusioncharts/charts/src/dataset/column"));var _errorbar2d=require("../../dataset/errorbar2d");var _candlestick=require("./candlestick");var _dependencyManager=require("@fusioncharts/core/src/dependency-manager");var _candlestickbar=_interopRequireDefault(require("./candlestickbar.animation"));var colorStrings=_lib.preDefStr.colors,COLOR_B90000=colorStrings.B90000,COLOR_FFFFFF=colorStrings.FFFFFF,SHOWSHADOW="showShadow",ROUND=_lib.preDefStr.ROUND,visibleStr=_lib.preDefStr.visibleStr,DASH_DEF="none",POINTER="pointer",BLANKSTRING="",M="M",L="L",applyShadow=function applyShadow(shadow){return function(){this.shadow(shadow)}};(0,_dependencyManager.addDep)({name:"candlestickbarAnimation",type:"animationRule",extension:_candlestickbar.default});var CandleStickBar=function(_Column){(0,_inheritsLoose2.default)(CandleStickBar,_Column);function CandleStickBar(){return _Column.apply(this,arguments)||this}var _proto=CandleStickBar.prototype;_proto.trimData=function trimData(datasetJSON){if(!this.components&&this.components.data&&this.components.data.length){return}var comps=this.components,prevData=comps&&comps.data,prevDataLength=prevData&&prevData.length,data=datasetJSON.data,currDataLength=Array.isArray(data)&&data.filter((function(v){return v.high||v.open||v.close||v.low})).length||0,dataDiff=prevDataLength-currDataLength;if(dataDiff>0){this.removeData(currDataLength,dataDiff,false)}};_proto.addDatasetSpecificEvtArgs=function addDatasetSpecificEvtArgs(_dataObj){var dataObj=_dataObj,config=dataObj.config,trackerConfig=dataObj.trackerConfig,eventArgs=trackerConfig.eventArgs;Object.assign(eventArgs,{open:config.open,close:config.close,high:config.high,low:config.low,volume:config.volume,alpha:config.alpha,x:config.x,displayValue:config.displayValue,color:config.color,borderColor:config.borderColor,dashed:config.dashed})};_proto.configureAttributes=function configureAttributes(datasetJSON){if(!datasetJSON){return false}this.trimData(datasetJSON);this.config.JSONData=datasetJSON;var dataset=this,conf=dataset.config,chart=dataset.getFromEnv("chart"),rawDataObj=chart.getFromEnv("dataSource"),JSONData=dataset.config.JSONData,dataArr=JSONData.data||[],chartAttr=rawDataObj.chart,dataLength=dataArr.length,numberFormatter=dataset.getFromEnv("number-formatter"),colorM=dataset.getFromEnv("color-manager"),setColor,setBorderColor,setAlpha,bearBorderColor=conf.bearBorderColor=(0,_lib.getFirstColor)((0,_lib.pluck)(chartAttr.bearbordercolor,COLOR_B90000)),bearFillColor=conf.bearFillColor=(0,_lib.getFirstColor)((0,_lib.pluck)(chartAttr.bearfillcolor,COLOR_B90000)),bullBorderColor=conf.bullBorderColor=(0,_lib.getFirstColor)((0,_lib.pluck)(chartAttr.bullbordercolor,colorM.getColor("canvasBorderColor"))),bullFillColor=conf.bullFillColor=(0,_lib.getFirstColor)((0,_lib.pluck)(chartAttr.bullfillcolor,COLOR_FFFFFF)),index,dataObj,open,close,high,low,minValue,maxValue,x,dataStore,setData,config,isCandleStick=false,yMax=-Infinity,yMin=+Infinity,xMax=-Infinity,xMin=+Infinity,userMaxColWidth;dataset.setState("visible",(0,_lib.pluckNumber)(JSONData.visible,1)===1);dataset._conatinerHidden=!!dataset.getState("visible");conf.defaultPadding={left:.5,right:.5};conf.minAbsNonZeroValue=Infinity;conf.minAbsNonZeroData={};conf.linethickness=(0,_lib.pluckNumber)(chartAttr.plotlinethickness,2);conf.toolText=(0,_lib.getValidValue)((0,_lib.parseUnsafeString)((0,_lib.pluck)(JSONData.tooltext,chartAttr.plottooltext),false));conf.name=(0,_lib.getValidValue)(JSONData.seriesname);conf.showTooltip=(0,_lib.pluckNumber)(chartAttr.showtooltip,1);conf.showErrorValue=true;conf.errorBarWidthPercent=0;isCandleStick=true;userMaxColWidth=(0,_lib.pluck)(chartAttr.maxcolwidth);conf.maxColWidth=Math.abs((0,_lib.pluckNumber)(userMaxColWidth,50))||1;conf.enableAnimation=(0,_lib.pluckNumber)(chartAttr.animation,chartAttr.defaultanimation,1);conf.animation=!conf.enableAnimation?false:{duration:(0,_lib.pluckNumber)(chartAttr.animationduration,1)*1e3};conf.plotLineDashLen=(0,_lib.pluckNumber)(chartAttr.plotlinedashlen,5);conf.plotLineDashGap=(0,_lib.pluckNumber)(chartAttr.plotlinedashgap,4);dataStore=dataset.components.data=dataset.components.data||(dataset.components.data=[]);conf.valuePadding=(0,_lib.pluckNumber)(JSONData.valuepadding,chartAttr.valuepadding,2);conf.showShadow=(0,_lib.pluckNumber)(chartAttr.showshadow,colorM.getColor(SHOWSHADOW));for(index=0;index<dataLength;index++){setData=dataArr[index];dataObj=dataStore[index];if(!dataObj){dataObj=dataStore[index]={}}!dataObj.config&&(dataObj.config={});!dataObj.graphics&&(dataObj.graphics={});config=dataObj.config;if(setData&&!setData.vline){config.setLink=(0,_lib.pluck)(setData.link);open=config.open=numberFormatter.getCleanValue(setData.open);close=config.close=numberFormatter.getCleanValue(setData.close);high=numberFormatter.getCleanValue(setData.high);low=numberFormatter.getCleanValue(setData.low);config.volume=numberFormatter.getCleanValue(setData.volume,true);x=config.x=numberFormatter.getCleanValue(setData.x);config.high=Math.max(open,close,high,low);config.low=Math.min(open,close,high,low);config.yVal=Math.max(open,close);minValue=Math.min(open,close,high,low);maxValue=Math.max(open,close,high,low);config.valuePadding=(0,_lib.pluckNumber)(setData.valuepadding,conf.valuePadding);setBorderColor=(0,_lib.getFirstColor)((0,_lib.pluck)(setData.bordercolor,close<open?bearBorderColor:bullBorderColor));setAlpha=(0,_lib.pluckNumber)(setData.alpha,100);setColor=(0,_lib.getFirstColor)((0,_lib.pluck)(setData.color,close<open?bearFillColor:bullFillColor));config.color=isCandleStick?setColor:setBorderColor;config.alpha=setAlpha;config.setColor=config.color;config.setAlpha=config.alpha;config.borderColor=setBorderColor;config.borderAlpha=config.plotLineAlpha;config.colorArr=[{color:config.color,alpha:config.alpha},{color:config.borderColor,alpha:config.borderAlpha}];config.showValue=1;config.hoverEffects={};config.link=(0,_lib.pluck)(setData.link);config.setValue=config.y;if(config.setValue!==0&&conf.minAbsNonZeroValue>Math.abs(config.setValue)){conf.minAbsNonZeroValue=Math.abs(config.setValue);conf.minAbsNonZeroData=config}config.dataLabelStyle=dataset._configureDataLabelStyle(setData);if(minValue!==null){yMax=Math.max(yMax,minValue);yMin=Math.min(yMin,minValue)}if(maxValue!==null){yMax=Math.max(yMax,maxValue);yMin=Math.min(yMin,maxValue)}if(x!==null){xMax=Math.max(xMax,x);xMin=Math.min(xMin,x)}config.dashStyle=(0,_lib.pluckNumber)(setData.dashed)?(0,_lib.getDashStyle)(conf.plotLineDashLen,conf.plotLineDashGap):DASH_DEF;config.shadow={opacity:conf.showShadow?setAlpha/100:0};x=x!==null?x:index+1;config.toolText=dataset._parseToolText(index);config.toolTipValue=BLANKSTRING;config._x=x;config.y=open;config.previousY=close;config.dashed=(0,_lib.pluckNumber)(conf.plotLineDashed,setData.dashed,0)}}conf.yMax=yMax;conf.yMin=yMin;conf.xMax=xMax;conf.xMin=xMin;dataset.setState("dirty",true)};_proto.drawPlots=function drawPlots(){var dataset=this,config,animationManager=dataset.getFromEnv("animationManager"),conf=dataset.config,data=dataset.components.data,length=data.length,xAxis=dataset.getFromEnv("xAxis"),yAxis=dataset.getFromEnv("yAxis"),i,set,setLink,x,y,previousY,xPos,yPos,previousYPos,setElem,bars,trackerTolerance=conf.linethickness>5?conf.linethickness/2:2.5,container=dataset.getContainer("plotGroup"),highPos,lowPos,halfW,path,graphics;animationManager.setAnimation({el:container,attr:{opacity:dataset.getState("visible")?1:0},component:dataset});dataset.setColumnPosition();for(i=0;i<length;i+=1){set=data[i];config=set.config;graphics=set.graphics;y=config.y;setElem=null;if(y===null){setElem=graphics.element}else{x=config._x;setLink=config.link;config.setLink=config.link;xPos=xAxis.getPixel(x);previousY=config.previousY;previousYPos=yAxis.getPixel(previousY);yPos=yAxis.getPixel(y);highPos=yAxis.getPixel(config.high);lowPos=yAxis.getPixel(config.low);halfW=dataset.getFromEnv("columnXShift");set.errorBar=[];bars=set.errorBar;bars.push([{_xPos:xPos-trackerTolerance,_yPos:highPos,_height:Math.abs(highPos-lowPos),_width:2*trackerTolerance},{_xPos:xPos+halfW,_yPos:yPos,_height:2*trackerTolerance,_width:Math.abs(halfW)},{_xPos:xPos,_yPos:previousYPos,_height:2*trackerTolerance,_width:Math.abs(halfW)}]);path=[M,xPos,lowPos,L,xPos,highPos,M,xPos,yPos,L,xPos+halfW,yPos,M,xPos,previousYPos,L,xPos-halfW,previousYPos];setElem=graphics.element;setElem=animationManager.setAnimation({el:setElem||"path",container:container,attr:{path:path,cursor:setLink?POINTER:BLANKSTRING,fill:(0,_lib.toRaphaelColor)(config.color),stroke:(0,_lib.toRaphaelColor)(config.borderColor),"stroke-width":conf.linethickness,"stroke-dasharray":config.dashStyle,"stroke-linecap":ROUND,"stroke-linejoin":ROUND,"shape-rendering":"crisp",visibility:visibleStr},label:"path",component:dataset,callback:applyShadow.call(setElem,config.shadow)});setElem.data("eventArgs",set.trackerConfig.eventArgs);graphics.element=setElem}}};_proto._parseToolText=function _parseToolText(i){return _candlestick._parseToolText.call(this,i)};_proto._firePlotEvent=function _firePlotEvent(eventType,plotIndex,e){_candlestick._firePlotEvent.call(this,eventType,plotIndex,e)};_proto._checkPointerOverColumn=function _checkPointerOverColumn(){};_proto._getHoveredPlot=function _getHoveredPlot(chartX,chartY){var dataset=this,x,i,hoveredInfo,pXs,pX;x=dataset.getFromEnv("xAxis").getValue(chartX);pXs=_candlestick.getPlotIndices.call(dataset,x);for(i=pXs.length-1;i>-1;i--){pX=pXs[i];hoveredInfo=pX-x>0?dataset._checkPointerOverPlot(pX,chartX,chartY)||dataset._checkPointerOverPlot(pX-1,chartX,chartY):dataset._checkPointerOverPlot(pX+1,chartX,chartY)||dataset._checkPointerOverPlot(pX,chartX,chartY);if(hoveredInfo){break}}return hoveredInfo};_proto._checkPointerOverPlot=function _checkPointerOverPlot(pX,chartX,chartY){return _errorbar2d._checkPointerOverPlot.call(this,pX,chartX,chartY)};_proto._checkPointerOverErrorBar=function _checkPointerOverErrorBar(pX,chartX,chartY){return _errorbar2d._checkPointerOverErrorBar.call(this,pX,chartX,chartY)};_proto.drawLabel=function drawLabel(){};_proto.getDataLimits=function getDataLimits(){var conf=this.config;return{max:conf.yMax,min:conf.yMin,xMax:conf.xMax,xMin:conf.xMin}};_proto.getName=function getName(){return"candlestickbar"};return CandleStickBar}(_column.default);var _default=CandleStickBar;exports.default=_default;