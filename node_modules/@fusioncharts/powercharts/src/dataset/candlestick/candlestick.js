"use strict";var _interopRequireDefault=require("@babel/runtime/helpers/interopRequireDefault");exports.__esModule=true;exports._parseToolText=exports._firePlotEvent=exports.getPlotIndices=exports.default=void 0;var _inheritsLoose2=_interopRequireDefault(require("@babel/runtime/helpers/inheritsLoose"));var _lib=require("@fusioncharts/core/src/lib");var _errorbar2d=_interopRequireDefault(require("../../dataset/errorbar2d"));var _dependencyManager=require("@fusioncharts/core/src/dependency-manager");var _candlestick=_interopRequireDefault(require("./candlestick.animation"));var _column=require("@fusioncharts/charts/src/dataset/column");var colorStrings=_lib.preDefStr.colors,COLOR_B90000=colorStrings.B90000,COLOR_FFFFFF=colorStrings.FFFFFF,BLANKSTRING="",UNDEF,DASH_DEF="none",POINTER="pointer",DEFAULT_CURSOR="default",SHOWSHADOW="showShadow",ROLLOVER="DataPlotRollOver",ROLLOUT="DataPlotRollOut",LINE="line",BOLDSTARTTAG="<b>",BOLDENDTAG="</b>",BLANKSPACE=" ",BREAKSTRING="<br />",_firePlotEvent2=function _firePlotEvent(eventType,plotIndex,e){var dataset=this,chart=dataset.getFromEnv("chart"),dataStore=dataset.components.data,data=dataStore[plotIndex],toolText,currentToolTip=dataset.config.currentToolTip,setElement=data.graphics.element,originalEvent=e.originalEvent,style=chart.getFromEnv("paper").canvas.style,toolTipController=dataset.getFromEnv("toolTipController"),config,setLink;if(setElement){config=data.config;toolText=config.toolText;setLink=config.setLink;switch(eventType){case"fc-mouseover":if(toolText){if(currentToolTip){toolTipController.draw(originalEvent,toolText,currentToolTip)}else{currentToolTip=dataset.config.currentToolTip=toolTipController.draw(originalEvent,toolText)}}chart.plotEventHandler(setElement,e,ROLLOVER);setLink&&(style.cursor=POINTER);break;case"fc-mouseout":toolTipController.hide(currentToolTip);chart.plotEventHandler(setElement,e,ROLLOUT);setLink&&(style.cursor=DEFAULT_CURSOR);break;case"fc-click":chart.plotEventHandler(setElement,e);break;case"fc-mousemove":if(toolText){if(currentToolTip){toolTipController.draw(originalEvent,toolText,currentToolTip)}else{currentToolTip=dataset.config.currentToolTip=toolTipController.draw(originalEvent,toolText)}}}}},_getPlotIndices=function getPlotIndices(x){var dataset=this,i,minX=Math.floor(x),maxX=Math.ceil(x),data,returnIndices=[],sortedData=dataset.config.JSONData&&dataset.config.JSONData.data;for(i=sortedData.length;i--;){data=sortedData[i];if(data.x>=minX&&data.x<=maxX){returnIndices.push(i)}}return returnIndices},__parseToolText=function __parseToolText(i){var dataset=this,conf=dataset.config,data=dataset.components.data,chartAttr=dataset.getFromEnv("chart-attrib"),isLine=conf.plotType===LINE?1:0,toolText,BLANK=BLANKSTRING,setData=conf.JSONData.data[i],config=data[i].config,label=dataset.getFromEnv("xAxis").getLabel(config.x).label,open=config.open,close=config.close,yAxis=dataset.getFromEnv("yAxis"),high=config.high,low=config.low,volume=config.volume,volumeToolText=volume!==UNDEF?setData.volumetooltext:UNDEF;if(!conf.showTooltip){toolText=BLANK}else{toolText=(0,_lib.getValidValue)((0,_lib.parseUnsafeString)((0,_lib.pluck)(volumeToolText,setData.tooltext,conf.volumeToolText,conf.toolText),false));if(toolText!==UNDEF){toolText=(0,_lib.parseTooltext)(toolText,[3,5,6,10,54,55,56,57,58,59,60,61,81,82],{label:label,yaxisName:(0,_lib.parseUnsafeString)(chartAttr.yaxisname),xaxisName:(0,_lib.parseUnsafeString)(chartAttr.xaxisname),openValue:setData.open,openDataValue:yAxis.dataLabels(open),closeValue:setData.close,closeDataValue:yAxis.dataLabels(close),highValue:setData.high,highDataValue:yAxis.dataLabels(high),lowValue:setData.low,lowDataValue:yAxis.dataLabels(low),volumeValue:setData.volume,volumeDataValue:yAxis.dataLabels(volume)},setData,chartAttr)}else{toolText=open!==null&&!isLine?BOLDSTARTTAG+"Open:"+BOLDENDTAG+BLANKSPACE+yAxis.dataLabels(open)+BREAKSTRING:BLANK;toolText+=close!==null?BOLDSTARTTAG+"Close:"+BOLDENDTAG+BLANKSPACE+yAxis.dataLabels(close)+BREAKSTRING:BLANK;toolText+=high!==null&&!isLine?BOLDSTARTTAG+"High:"+BOLDENDTAG+BLANKSPACE+yAxis.dataLabels(high)+BREAKSTRING:BLANK;toolText+=low!==null&&!isLine?BOLDSTARTTAG+"Low:"+BOLDENDTAG+BLANKSPACE+yAxis.dataLabels(low)+BREAKSTRING:BLANK;toolText+=volume!==null?BOLDSTARTTAG+"Volume:"+BOLDENDTAG+BLANKSPACE+yAxis.dataLabels(volume):BLANK}}return toolText};exports._parseToolText=__parseToolText;exports.getPlotIndices=_getPlotIndices;exports._firePlotEvent=_firePlotEvent2;(0,_dependencyManager.addDep)({name:"candlestickAnimation",type:"animationRule",extension:_candlestick.default});var CandleStickDataset=function(_ErrorBar2DDataset){(0,_inheritsLoose2.default)(CandleStickDataset,_ErrorBar2DDataset);function CandleStickDataset(){return _ErrorBar2DDataset.apply(this,arguments)||this}var _proto=CandleStickDataset.prototype;_proto.trimData=function trimData(datasetJSON){if(!this.components&&this.components.data&&this.components.data.length){return}var comps=this.components,prevData=comps&&comps.data,prevDataLength=prevData&&prevData.length,data=datasetJSON.data,currDataLength=Array.isArray(data)&&data.filter((function(v){return v.high||v.open||v.close||v.low})).length||0,dataDiff=prevDataLength-currDataLength;if(dataDiff>0){this.removeData(currDataLength,dataDiff,false)}};_proto.removePlots=function removePlots(){var dataset=this,components=dataset.components,removeDataArr=components&&components.removeDataArr;(0,_column._removePlots)(removeDataArr,dataset.__removeElem)};_proto.configureAttributes=function configureAttributes(datasetJSON){if(!datasetJSON){return false}this.trimData(datasetJSON);this.config.JSONData=datasetJSON;var dataset=this,conf=dataset.config,chart=dataset.getFromEnv("chart"),JSONData=dataset.config.JSONData,dataArr=JSONData.data||[],chartAttr=chart.getFromEnv("dataSource").chart,dataLength=dataArr.length,numberFormatter=dataset.getFromEnv("number-formatter"),colorM=dataset.getFromEnv("color-manager"),setColor,setBorderColor,setAlpha,bearBorderColor=conf.bearBorderColor=(0,_lib.getFirstColor)((0,_lib.pluck)(chartAttr.bearbordercolor,COLOR_B90000)),bearFillColor=conf.bearFillColor=(0,_lib.getFirstColor)((0,_lib.pluck)(chartAttr.bearfillcolor,COLOR_B90000)),bullBorderColor=conf.bullBorderColor=(0,_lib.getFirstColor)((0,_lib.pluck)(chartAttr.bullbordercolor,colorM.getColor("canvasBorderColor"))),bullFillColor=conf.bullFillColor=(0,_lib.getFirstColor)((0,_lib.pluck)(chartAttr.bullfillcolor,COLOR_FFFFFF)),plotLineThickness=conf.linethickness=conf.plotBorderThickness=(0,_lib.pluckNumber)(chartAttr.plotlinethickness,1),plotLineDashLen=conf.plotLineDashLen=(0,_lib.pluckNumber)(chartAttr.plotlinedashlen,5),plotLineDashGap=conf.plotLineDashGap=(0,_lib.pluckNumber)(chartAttr.plotlinedashgap,4),pointShadow,index,dataObj,open,close,high,low,volume,minValue,maxValue,x,closeVal,borderColor,yVal,dataStore,setData,config,isCandleStick=false,plotSpacePercent,yMax=-Infinity,yMin=+Infinity,xMax=-Infinity,xMin=+Infinity,userMaxColWidth;dataset.setState("visible",(0,_lib.pluckNumber)(JSONData.visible,1)===1);dataset._conatinerHidden=!!dataset.getState("visible");conf.minAbsNonZeroValue=Infinity;conf.minAbsNonZeroData={};conf.defaultPadding={left:.5,right:.5};conf.parentYAxis=0;conf.toolText=(0,_lib.getValidValue)((0,_lib.parseUnsafeString)((0,_lib.pluck)(JSONData.tooltext,chartAttr.plottooltext),false));conf.name=(0,_lib.getValidValue)(JSONData.seriesname);conf.showTooltip=(0,_lib.pluckNumber)(chartAttr.showtooltip,1);conf.showShadow=(0,_lib.pluckNumber)(chartAttr.showshadow,colorM.getColor(SHOWSHADOW));conf.showErrorValue=true;conf.errorBarWidthPercent=0;isCandleStick=true;userMaxColWidth=(0,_lib.pluck)(chartAttr.maxcolwidth);conf.maxColWidth=Math.abs((0,_lib.pluckNumber)(userMaxColWidth,50))||1;plotSpacePercent=Math.max((0,_lib.pluckNumber)(chartAttr.plotspacepercent,20)%100,0);conf.plotSpacePercent=conf.groupPadding=plotSpacePercent/200;dataStore=dataset.components.data=dataset.components.data||(dataset.components.data=[]);conf.valuePadding=(0,_lib.pluckNumber)(JSONData.valuepadding,chartAttr.valuepadding,2);conf.plotBorderThickness=plotLineThickness;for(index=0;index<dataLength;index+=1){setData=dataArr[index];dataObj=dataStore[index];if(!dataObj){dataObj=dataStore[index]={}}!dataObj.config&&(dataObj.config={});!dataObj.graphics&&(dataObj.graphics={});config=dataObj.config;if(setData&&!setData.vline){config.setLink=(0,_lib.pluck)(setData.link);open=config.open=numberFormatter.getCleanValue(setData.open);close=config.close=numberFormatter.getCleanValue(setData.close);high=config.high=numberFormatter.getCleanValue(setData.high);low=config.low=numberFormatter.getCleanValue(setData.low);volume=config.volume=numberFormatter.getCleanValue(setData.volume,true);if(volume!==null){chart.config.drawVolume=true}x=config.x=numberFormatter.getCleanValue(setData.x);closeVal=config.closeVal=Math.min(open,close);yVal=config.yVal=Math.max(open,close);minValue=Math.min(open,close,high,low);maxValue=Math.max(open,close,high,low);config.valuePadding=(0,_lib.pluckNumber)(setData.valuepadding,conf.valuePadding);setBorderColor=(0,_lib.getFirstColor)((0,_lib.pluck)(setData.bordercolor,close<open?bearBorderColor:bullBorderColor));setAlpha=(0,_lib.pluckNumber)(setData.alpha,100);setColor=(0,_lib.getFirstColor)((0,_lib.pluck)(setData.color,close<open?bearFillColor:bullFillColor));config.dashed=(0,_lib.pluckNumber)(setData.dashed,0);config.plotBorderDashStyle=(0,_lib.pluckNumber)(setData.dashed)?(0,_lib.getDashStyle)(plotLineDashLen,plotLineDashGap):DASH_DEF;pointShadow={opacity:conf.showShadow?setAlpha/100:0};config.color=isCandleStick?setColor:setBorderColor;config.alpha=setAlpha;config.setColor=config.color;config.setAlpha=config.alpha;config.anchorImageUrl=(0,_lib.pluck)(setData.anchorimageurl,JSONData.anchorimageurl,chartAttr.anchorimageurl);borderColor=config.borderColor=setBorderColor;config.borderAlpha=config.plotLineAlpha;config.colorArr=[{color:config.color,alpha:config.alpha},{color:config.borderColor,alpha:config.borderAlpha}];config.showValue=1;config.hoverEffects={};config.y=Math.abs(close-open);config.previousY=closeVal;config.link=(0,_lib.pluck)(setData.link);config.errorValueArr=[];if(high-yVal>0){config.errorValue=true;config.errorValueArr.push({errorValue:yVal-high,errorStartValue:yVal,errorBarColor:borderColor,errorBarThickness:plotLineThickness,opacity:1})}if(low-closeVal<0){config.errorValue=true;config.errorValueArr.push({errorValue:closeVal-low,errorStartValue:closeVal,errorBarColor:borderColor,errorBarThickness:plotLineThickness,opacity:1})}config.setValue=yVal;if(yVal!==0&&conf.minAbsNonZeroValue>Math.abs(yVal)){conf.minAbsNonZeroValue=Math.abs(yVal);conf.minAbsNonZeroData=config}config.dataLabelStyle=dataset._configureDataLabelStyle(setData);if(minValue!==null){yMax=Math.max(yMax,minValue);yMin=Math.min(yMin,minValue)}if(maxValue!==null){yMax=Math.max(yMax,maxValue);yMin=Math.min(yMin,maxValue)}if(x!==null){xMax=Math.max(xMax,x);xMin=Math.min(xMin,x)}x=x!==null?x:index+1;config._x=x;config._y=yVal;config._b=closeVal;config.high=Math.max(open,close,high,low);config.low=Math.min(open,close,high,low);config.shadow=pointShadow;config.toolText=dataset._parseToolText(index);config.toolTipValue=BLANKSTRING;config.displayValue=(0,_lib.parseUnsafeString)((0,_lib.pluck)(setData.displayvalue,setData.valuetext,BLANKSTRING))}}conf.yMax=yMax;conf.yMin=yMin;conf.xMax=xMax;conf.xMin=xMin;dataset.setState("dirty",true)};_proto._parseToolText=function _parseToolText(i){return __parseToolText.call(this,i)};_proto.addDatasetSpecificEvtArgs=function addDatasetSpecificEvtArgs(_dataObj){var dataObj=_dataObj,config=dataObj.config,trackerConfig=dataObj.trackerConfig,eventArgs=trackerConfig.eventArgs;Object.assign(eventArgs,{open:config.open,close:config.close,high:config.high,low:config.low,volume:config.volume,alpha:config.alpha,x:config.x,displayValue:config.displayValue,color:config.color,borderColor:config.borderColor,dashed:config.dashed})};_proto.calculateScrollRange=function calculateScrollRange(){var dataset=this,conf=dataset.config,dataLen=dataset.components.data&&dataset.components.data.length;conf.scrollMinVal=conf.scrollMinValForLabel=0;conf.scrollMaxVal=conf.scrollMaxValForLabel=dataLen};_proto.getPlotIndices=function getPlotIndices(x){return _getPlotIndices.call(this,x)};_proto._getHoveredPlot=function _getHoveredPlot(chartX,chartY){var dataset=this,x,i,hoveredInfo,pXs,pX;x=dataset.getFromEnv("xAxis").getValue(chartX);pXs=dataset.getPlotIndices(x);for(i=pXs.length-1;i>-1;i--){pX=pXs[i];hoveredInfo=pX-x>0?dataset._checkPointerOverPlot(pX,chartX,chartY)||dataset._checkPointerOverPlot(pX-1,chartX,chartY):dataset._checkPointerOverPlot(pX+1,chartX,chartY)||dataset._checkPointerOverPlot(pX,chartX,chartY);if(hoveredInfo){break}}return hoveredInfo};_proto._firePlotEvent=function _firePlotEvent(eventType,plotIndex,e){_firePlotEvent2.call(this,eventType,plotIndex,e)};_proto.getDataLimits=function getDataLimits(){var conf=this.config;return{max:conf.yMax,min:conf.yMin,xMax:conf.xMax,xMin:conf.xMin}};_proto.getName=function getName(){return"candlestick"};return CandleStickDataset}(_errorbar2d.default);var _default=CandleStickDataset;exports.default=_default;