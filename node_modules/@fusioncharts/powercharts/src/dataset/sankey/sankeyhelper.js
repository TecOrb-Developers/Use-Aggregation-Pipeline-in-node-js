"use strict";exports.__esModule=true;exports.createGraph=createGraph;exports.createNodeLinks=createNodeLinks;exports.createNodeValues=createNodeValues;exports.traverseGraph=traverseGraph;exports.createNodeDimensions=createNodeDimensions;function _createForOfIteratorHelperLoose(o,allowArrayLike){var it=typeof Symbol!=="undefined"&&o[Symbol.iterator]||o["@@iterator"];if(it)return(it=it.call(o)).next.bind(it);if(Array.isArray(o)||(it=_unsupportedIterableToArray(o))||allowArrayLike&&o&&typeof o.length==="number"){if(it)o=it;var i=0;return function(){if(i>=o.length)return{done:true};return{done:false,value:o[i++]}}}throw new TypeError("Invalid attempt to iterate non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}function _unsupportedIterableToArray(o,minLen){if(!o)return;if(typeof o==="string")return _arrayLikeToArray(o,minLen);var n=Object.prototype.toString.call(o).slice(8,-1);if(n==="Object"&&o.constructor)n=o.constructor.name;if(n==="Map"||n==="Set")return Array.from(o);if(n==="Arguments"||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(n))return _arrayLikeToArray(o,minLen)}function _arrayLikeToArray(arr,len){if(len==null||len>arr.length)len=arr.length;for(var i=0,arr2=new Array(len);i<len;i++){arr2[i]=arr[i]}return arr2}var MAX=Math.max,MIN=Math.min,VERYSMALLNUMBER=1e-6,VERTICAL="vertical";function findNodeById(_nodes,_node){var nodes=_nodes,node=_node;return nodes.find((function(d){return d.id===node||d.label===node}))}function createNodeLinks(_ref){var nodes=_ref.nodes,links=_ref.links;nodes.forEach((function(_node){var node=_node;node.props.sourceLinks=[];node.props.targetLinks=[]}));links.forEach((function(_link,index){var link=_link,_link$props=link.props,source=_link$props.source,target=_link$props.target;if(typeof source!=="object")source=link.props.source=findNodeById(nodes,source);if(typeof target!=="object")target=link.props.target=findNodeById(nodes,target);source.props.sourceLinks.push(link);target.props.targetLinks.push(link);link.props.index=index}))}function ascendingHeight(a,b){return a.props.target.props.y0-b.props.target.props.y0}function ascendingWidth(a,b){return a.props.target.props.x0-b.props.target.props.x0}function sortLinks(_links,orientation){var links=_links;if(orientation===VERTICAL){links.sort(ascendingWidth)}else{links.sort(ascendingHeight)}return links}function createLinkDimensions(_ref2,props){var nodes=_ref2.nodes;var orientation=props&&props.orientation;for(var _iterator=_createForOfIteratorHelperLoose(nodes),_step;!(_step=_iterator()).done;){var node=_step.value;if(orientation===VERTICAL){var x0=node.props.x0,x1=x0,sortedSourceLinks=sortLinks(node.props.sourceLinks,orientation);for(var _iterator2=_createForOfIteratorHelperLoose(sortedSourceLinks),_step2;!(_step2=_iterator2()).done;){var link=_step2.value;link.props.x0=x0+link.props.linkWidth/2;link.props.y0=link.props.source.props.y1;x0+=link.props.linkWidth}for(var _iterator3=_createForOfIteratorHelperLoose(node.props.targetLinks),_step3;!(_step3=_iterator3()).done;){var _link2=_step3.value;_link2.props.x1=x1+_link2.props.linkWidth/2;_link2.props.y1=_link2.props.target.props.y0;x1+=_link2.props.linkWidth}}else{var y0=node.props.y0,y1=y0,_sortedSourceLinks=sortLinks(node.props.sourceLinks);for(var _iterator4=_createForOfIteratorHelperLoose(_sortedSourceLinks),_step4;!(_step4=_iterator4()).done;){var _link3=_step4.value;_link3.props.y0=y0+_link3.props.linkWidth/2;_link3.props.x0=_link3.props.source.props.x1;y0+=_link3.props.linkWidth}for(var _iterator5=_createForOfIteratorHelperLoose(node.props.targetLinks),_step5;!(_step5=_iterator5()).done;){var _link4=_step5.value;_link4.props.y1=y1+_link4.props.linkWidth/2;_link4.props.x1=_link4.props.target.props.x0;y1+=_link4.props.linkWidth}}}}function createNodeValues(_ref3){var nodes=_ref3.nodes;nodes&&nodes.forEach((function(_node){var totalSourceValue=0,totalTargetValue=0,node=_node;for(var _iterator6=_createForOfIteratorHelperLoose(node.props.sourceLinks),_step6;!(_step6=_iterator6()).done;){var value=_step6.value.value;totalSourceValue+=Number(value)}for(var _iterator7=_createForOfIteratorHelperLoose(node.props.targetLinks),_step7;!(_step7=_iterator7()).done;){var _value=_step7.value.value;totalTargetValue+=Number(_value)}node.props.value=MAX(totalSourceValue,totalTargetValue)}))}function createGraph(graph){createNodeLinks(graph);createNodeValues(graph);return graph}function traverseGraph(_ref4){var nodes=_ref4.nodes;var currentSet=new Set(nodes),nextSet=new Set,depth=0;while(currentSet.size){currentSet.forEach((function(_node){var node=_node;node.props.depth=depth;for(var _iterator8=_createForOfIteratorHelperLoose(node.props.sourceLinks),_step8;!(_step8=_iterator8()).done;){var link=_step8.value;nextSet.add(link.props.target)}}));if(++depth>nodes.length){return false}currentSet=nextSet;nextSet=new Set}return true}function createNodeDimensions(graphs,_props){var props=_props,iterations=6,nodes=graphs.nodes,maxDepth=MAX.apply(null,nodes.map((function(node){return node.props.depth})))+1;var columns=new Array(maxDepth);for(var _iterator9=_createForOfIteratorHelperLoose(nodes),_step9;!(_step9=_iterator9()).done;){var node=_step9.value;var layer=MAX(0,MIN(maxDepth-1,node.props.depth));node.props.layer=layer;if(columns[layer])columns[layer].push(node);else columns[layer]=[node]}setnodeXY(columns,maxDepth,props);if(props.nodeRelaxation){for(var i=0;i<iterations;++i){var convergence=Math.pow(.99,i),divergence=Math.max(1-convergence,(i+1)/6);relaxSources(columns,convergence,divergence,props);relaxTargets(columns,convergence,divergence,props)}}createLinkDimensions(graphs,props)}function setnodeXY(_columns,_maxDepth,_props){var columns=_columns,props=_props,maxDepth=_maxDepth,maxNodeWidth,minNodesLength,nodeGutter,nodeValueFactor,columngapFactor,orientation=props.orientation;maxNodeWidth=MAX.apply(null,columns[maxDepth-1].map((function(node){return node.nodeWidth})));columngapFactor=orientation===VERTICAL?(props.height[1]-props.height[0]-maxNodeWidth)/(maxDepth-1):(props.width[1]-props.width[0]-maxNodeWidth)/(maxDepth-1);nodeGutter=props.nodeGutter;minNodesLength=MAX.apply(null,columns.map((function(nodes){return nodes.length})));if(orientation===VERTICAL){if((minNodesLength-1)*nodeGutter>=props.width[1]-props.width[0]||(minNodesLength-1)*nodeGutter<0)nodeGutter=props.nodeGutter=10}else{if((minNodesLength-1)*nodeGutter>=props.height[1]-props.height[0]||(minNodesLength-1)*nodeGutter<0)nodeGutter=props.nodeGutter=10}nodeValueFactor=MIN.apply(null,columns.map((function(nodes){var totalValue=0;for(var _iterator10=_createForOfIteratorHelperLoose(nodes),_step10;!(_step10=_iterator10()).done;){var node=_step10.value;totalValue+=node.props.value}return orientation===VERTICAL?(props.width[1]-props.width[0]-(nodes.length-1)*nodeGutter)/totalValue:(props.height[1]-props.height[0]-(nodes.length-1)*nodeGutter)/totalValue})));if(!columngapFactor||columngapFactor===Infinity||columngapFactor===-Infinity)columngapFactor=0;if(!nodeValueFactor||nodeValueFactor===Infinity||nodeValueFactor===-Infinity)nodeValueFactor=0;for(var _iterator11=_createForOfIteratorHelperLoose(columns),_step11;!(_step11=_iterator11()).done;){var nodes=_step11.value;if(orientation===VERTICAL){var startX=props.width[0];for(var _iterator12=_createForOfIteratorHelperLoose(nodes),_step12;!(_step12=_iterator12()).done;){var node=_step12.value;for(var _iterator13=_createForOfIteratorHelperLoose(node.props.sourceLinks),_step13;!(_step13=_iterator13()).done;){var link=_step13.value;link.props.linkWidth=link.value*nodeValueFactor}node.props.y0=props.height[0]+node.props.layer*columngapFactor;node.props.y1=node.props.y0+node.nodeWidth;node.props.x0=startX;node.props.x1=node.props.x0+nodeValueFactor*node.props.value;startX=node.props.x1+nodeGutter}}else{var startY=props.height[0];for(var _iterator14=_createForOfIteratorHelperLoose(nodes),_step14;!(_step14=_iterator14()).done;){var _node2=_step14.value;for(var _iterator15=_createForOfIteratorHelperLoose(_node2.props.sourceLinks),_step15;!(_step15=_iterator15()).done;){var _link5=_step15.value;_link5.props.linkWidth=_link5.value*nodeValueFactor}_node2.props.x0=props.width[0]+_node2.props.layer*columngapFactor;_node2.props.x1=_node2.props.x0+_node2.nodeWidth;_node2.props.y0=startY;_node2.props.y1=_node2.props.y0+nodeValueFactor*_node2.props.value;startY=_node2.props.y1+nodeGutter}}}}function relaxTargets(columns,alpha,beta,props){var orientation=props&&props.orientation;for(var i=1,n=columns.length;i<n;++i){var targetShiftFactor=void 0;var column=columns[i];for(var _iterator16=_createForOfIteratorHelperLoose(column),_step16;!(_step16=_iterator16()).done;){var target=_step16.value;var y=0,w=0;for(var _iterator17=_createForOfIteratorHelperLoose(target.props.targetLinks),_step17;!(_step17=_iterator17()).done;){var link=_step17.value;var valueFactor=link.value*(target.props.layer-link.props.source.props.layer);y+=targetTop(link.props.source,target,props)*valueFactor;w+=valueFactor}if(!(w>0))continue;if(orientation===VERTICAL){targetShiftFactor=(y/w-target.props.x0)*alpha;target.props.x0+=targetShiftFactor;target.props.x1+=targetShiftFactor}else{targetShiftFactor=(y/w-target.props.y0)*alpha;target.props.y0+=targetShiftFactor;target.props.y1+=targetShiftFactor}}resolveCollisions(column,beta,props)}}function relaxSources(columns,alpha,beta,props){var orientation=props&&props.orientation;for(var n=columns.length,i=n-2;i>=0;--i){var sourceShiftFactor=void 0;var column=columns[i];for(var _iterator18=_createForOfIteratorHelperLoose(column),_step18;!(_step18=_iterator18()).done;){var source=_step18.value;var y=0,w=0;for(var _iterator19=_createForOfIteratorHelperLoose(source.props.sourceLinks),_step19;!(_step19=_iterator19()).done;){var link=_step19.value;var target=link.props.target;var valueFactor=link.value*(target.props.layer-source.props.layer);y+=sourceTop(source,target,props)*valueFactor;w+=valueFactor}if(!(w>0))continue;if(orientation===VERTICAL){sourceShiftFactor=(y/w-source.props.x0)*alpha;source.props.x0+=sourceShiftFactor;source.props.x1+=sourceShiftFactor}else{sourceShiftFactor=(y/w-source.props.y0)*alpha;source.props.y0+=sourceShiftFactor;source.props.y1+=sourceShiftFactor}}resolveCollisions(column,beta,props)}}function resolveCollisions(nodes,beta,props){var i=nodes.length>>1,subject=nodes[i];var orientation=props&&props.orientation;if(orientation===VERTICAL){resolveCollisionsBottomToTop(nodes,subject.props.x0-props.nodeGutter,i-1,beta,props);resolveCollisionsTopToBottom(nodes,subject.props.x1+props.nodeGutter,i+1,beta,props);resolveCollisionsBottomToTop(nodes,props.width[1],nodes.length-1,beta,props);resolveCollisionsTopToBottom(nodes,props.width[0],0,beta,props)}else{resolveCollisionsBottomToTop(nodes,subject.props.y0-props.nodeGutter,i-1,beta,props);resolveCollisionsTopToBottom(nodes,subject.props.y1+props.nodeGutter,i+1,beta,props);resolveCollisionsBottomToTop(nodes,props.height[1],nodes.length-1,beta,props);resolveCollisionsTopToBottom(nodes,props.height[0],0,beta,props)}}function resolveCollisionsTopToBottom(nodes,_y,_i,beta,props){var i=_i,y=_y,orientation=props&&props.orientation;for(;i<nodes.length;++i){var node=nodes[i],dy=(y-(orientation===VERTICAL?node.props.x0:node.props.y0))*beta;if(orientation===VERTICAL){if(dy>VERYSMALLNUMBER){node.props.x0+=dy;node.props.x1+=dy}y=node.props.x1+props.nodeGutter}else{if(dy>VERYSMALLNUMBER){node.props.y0+=dy;node.props.y1+=dy}y=node.props.y1+props.nodeGutter}}}function resolveCollisionsBottomToTop(nodes,_y,_i,beta,props){var i=_i,y=_y,orientation=props&&props.orientation;for(;i>=0;--i){var node=nodes[i],dy=((orientation===VERTICAL?node.props.x1:node.props.y1)-y)*beta;if(orientation===VERTICAL){if(dy>VERYSMALLNUMBER){node.props.x0-=dy;node.props.x1-=dy}y=node.props.x0-props.nodeGutter}else{if(dy>VERYSMALLNUMBER){node.props.y0-=dy;node.props.y1-=dy}y=node.props.y0-props.nodeGutter}}}function targetTop(source,target,props){var orientation=props&&props.orientation,shiftStart=(orientation===VERTICAL?source.props.x0:source.props.y0)-(source.props.sourceLinks.length-1)*props.nodeGutter/2;for(var _iterator20=_createForOfIteratorHelperLoose(source.props.sourceLinks),_step20;!(_step20=_iterator20()).done;){var link=_step20.value;var node=link.props.target,linkWidth=link.props.linkWidth;if(node===target)break;shiftStart+=linkWidth+props.nodeGutter}for(var _iterator21=_createForOfIteratorHelperLoose(target.props.targetLinks),_step21;!(_step21=_iterator21()).done;){var _link6=_step21.value;var _node3=_link6.props.source,_linkWidth=_link6.props.linkWidth;if(_node3===source)break;shiftStart-=_linkWidth}return shiftStart}function sourceTop(source,target,props){var orientation=props&&props.orientation,shiftStart=(orientation===VERTICAL?target.props.x0:target.props.y0)-(target.props.targetLinks.length-1)*props.nodeGutter/2;for(var _iterator22=_createForOfIteratorHelperLoose(target.props.targetLinks),_step22;!(_step22=_iterator22()).done;){var link=_step22.value;var node=link.props.source,linkWidth=link.props.linkWidth;if(node===source)break;shiftStart+=linkWidth+props.nodeGutter}for(var _iterator23=_createForOfIteratorHelperLoose(source.props.sourceLinks),_step23;!(_step23=_iterator23()).done;){var _link7=_step23.value;var _node4=_link7.props.target,_linkWidth2=_link7.props.linkWidth;if(_node4===target)break;shiftStart-=_linkWidth2}return shiftStart}