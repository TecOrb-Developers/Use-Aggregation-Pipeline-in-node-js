"use strict";var _interopRequireDefault=require("@babel/runtime/helpers/interopRequireDefault");exports.__esModule=true;exports.default=void 0;var _inheritsLoose2=_interopRequireDefault(require("@babel/runtime/helpers/inheritsLoose"));var _componentInterface=require("@fusioncharts/core/src/component-interface");var _lib=require("@fusioncharts/core/src/lib");var _numeric=_interopRequireDefault(require("@fusioncharts/core/src/axis/numeric"));var _checkbox=_interopRequireDefault(require("@fusioncharts/core/src/toolbox/tools/checkbox"));var checkboxTopPadding=4;var removeInfo=function removeInfo(_existingAxes,_axisMapById){var key,_info,i;for(i=_existingAxes.length-1;i>-1;i--){key=_existingAxes[i];_info=_axisMapById.get(key);_info.checkbox&&_info.checkbox.remove();_info.axis&&_info.axis.remove();_axisMapById["delete"](key)}},swap=function swap(a,b,map){var e1=[a,map.get(a)],e2=[b,map.get(b)],mapArray=Array.from(map.entries()),newMapArray=mapArray.map((function(_ref){var key=_ref[0],value=_ref[1];if(key===a){return e2}else if(key===b){return e1}return[key,value]}));return new Map(newMapArray)},factoryAxis=function factoryAxis(parent){var axesConf=parent.config.axesConf,axes,axisMapById,activeAxis,existingInfo,exsitingAxisMapById=parent.config.axisMapById,existingAxes=exsitingAxisMapById&&Array.from(exsitingAxisMapById.keys())||[],info,firstAxis=true,canvas=parent.getFromEnv("chart").getChildren("canvas")[0],axisRefVisualCartesian=canvas.getChildren("axisRefVisualCartesian")[0],redraw=function redraw(){return axisRefVisualCartesian.asyncDraw()},removeId=function removeId(id){var index=existingAxes.indexOf(id);index!==-1&&existingAxes.splice(index,1)};(0,_lib.componentFactory)(parent,_numeric.default,"yAxis",axesConf.length,axesConf);axes=(parent.getChildren("yAxis")||[]).slice(0);axisMapById=parent.config.axisMapById=new Map;(parent.config.side==="l"?axes.reverse():axes).forEach((function(axis){if(axis.getState("removed")||axis.config.showaxis===0){return}var axisId=axis.getId();info={};info.axis=axis;existingInfo=exsitingAxisMapById&&exsitingAxisMapById.get(axisId);info.checkbox=existingInfo&&existingInfo.checkbox;axisMapById.set(axisId,info);if(axis.config.showaxis===0){axis.hide()}else{axis.show()}canvas.attachAxis(axis,true);firstAxis&&(parent.config.besideCanvas=axisId);firstAxis=false;if(!axisCount){activeAxis=axis}axis.setLinkedItem("canvas",canvas);axisRefVisualCartesian.setLinkedItem(axis.getId(),axis);axisRefVisualCartesian.addExtEventListener("visiblerangeset",redraw,axis);axisCount++;removeId(axisId)}));activeAxis&&canvas.setPrimaryAxis("yAxis",activeAxis);removeInfo(existingAxes,exsitingAxisMapById)},axisCount=0;var AxisSelectorUI=function(_ComponentInterface){(0,_inheritsLoose2.default)(AxisSelectorUI,_ComponentInterface);function AxisSelectorUI(){var _this;_this=_ComponentInterface.call(this)||this;_this.registerFactory("axis",factoryAxis);return _this}AxisSelectorUI.resetAxisCount=function resetAxisCount(){axisCount=0};var _proto=AxisSelectorUI.prototype;_proto.configureAttributes=function configureAttributes(conf){if(conf===void 0){conf={}}var config=this.config;config.axesConf=conf.axesConf||[];config.checkboxesConf=conf.checkboxesConf||[];config.side=conf.side};_proto.placeAxis=function placeAxis(avlWidth){var axisSelectorUI=this,availableWidth=avlWidth,side=axisSelectorUI.config.side,axisMapById=axisSelectorUI.getAxesDetails(),axesPadding=axisSelectorUI.getFromEnv("chartConfig").axesPadding,rightPadding=0,leftPadding=0,dim,dimension={right:0,left:0};axisMapById.forEach((function(info){var value=info.value||(info.value={}),axis=info.axis;if(axis.getState("removed")||axis.config.showaxis===0){return}dim=axis.placeAxis(availableWidth*.7);if(side==="r"){availableWidth-=value.width=dim.right;dimension.right+=dim.right;rightPadding+=axesPadding}else{availableWidth-=value.width=dim.left;dimension.left+=dim.left;leftPadding+=axesPadding}}));return{dimension:dimension,rightPadding:rightPadding,leftPadding:leftPadding}};_proto.setAxisDimention=function setAxisDimention(){var axisSelectorUI=this,conf=axisSelectorUI.config,axisMapById=axisSelectorUI.getAxesDetails(),axesPadding=axisSelectorUI.getFromEnv("chartConfig").axesPadding,canvasConfig=axisSelectorUI.getFromEnv("chart").getChildren("canvas")[0].config,canvasBorderWidth=canvasConfig.canvasBorderWidth,canvasPaddingTop=canvasConfig.canvasPaddingTop,canvasPaddingBottom=canvasConfig.canvasPaddingBottom,canvasLeft=canvasConfig.canvasLeft,canvasTop=canvasConfig.canvasTop,canvasHeight=canvasConfig.canvasHeight,canvasRight=canvasLeft+canvasConfig.canvasWidth,isRight=conf.side==="r",oppositePos=conf.side==="r"?canvasLeft-canvasBorderWidth:canvasRight+canvasBorderWidth,padding=0;axisMapById.forEach((function(info){var value=info.value||(info.value={}),axis=info.axis;if(axis.config.showaxis===0||axis.getState("removed")){return}if(isRight){value.x=canvasRight+canvasBorderWidth+padding+axesPadding}else{value.x=canvasLeft-canvasBorderWidth-padding-axesPadding}value.y=canvasTop+canvasPaddingTop;value.height=canvasHeight-canvasPaddingTop-canvasPaddingBottom;value.opposite=oppositePos;padding+=value.width+axesPadding;axis.setAxisDimention({x:value.x,y:value.y,opposite:value.opposite,axisLength:value.height})}))};_proto.drawHotElements=function drawHotElements(){var axisSelectorUI=this,conf=axisSelectorUI.config,isRight=conf.side==="r",allowAxisShift=axisSelectorUI.getFromEnv("chartConfig").allowAxisShift,chart=axisSelectorUI.getFromEnv("chart"),axisMapById=conf.axisMapById,axisHotElements=axisSelectorUI.getGraphicalElement("axisHotElement")||[],k,length,counter=-1,attr={cursor:"col-resize",stroke:_lib.TRACKER_FILL,fill:_lib.TRACKER_FILL,visibility:true};if(allowAxisShift){axisMapById.forEach((function(info,key){var hotElement,value=info.value;attr.x=value.x+(isRight?0:-value.width);attr.y=value.y;attr.width=value.width;attr.height=value.height;if(!(hotElement=axisHotElements[++counter])){hotElement=axisSelectorUI.addGraphicalElement("axisHotElement",axisSelectorUI.getFromEnv("paper").rect(chart.getChildContainer("trackerGroup")),true);hotElement.on("fc-click",axisSelectorUI._resuffelAxis)}hotElement.attr(attr).data("axisDetails",{axisSelectorUI:axisSelectorUI,canvas:chart.getChildren("canvas")[0],axisId:key})}))}for(k=counter+1,length=axisHotElements.length;k<length;k++){axisSelectorUI.removeGraphicalElement(axisHotElements[k])}};_proto.drawCheckBoxes=function drawCheckBoxes(){var axisSelectorUI=this,conf=axisSelectorUI.config,chartConfig=axisSelectorUI.getFromEnv("chartConfig"),isRight=conf.side==="r",axisMapById=conf.axisMapById;if(chartConfig.allowSelection){axisMapById.forEach((function(info,key){var value=info.value,currCheckBox=info.checkbox,axisConfig=info.axis.config,checkboxClickHandler=function checkboxClickHandler(){var tool=this;tool.toggle();axisSelectorUI._dolegendInteraction.call(tool,key,tool.getFromEnv("chart"));axisConfig.checkBoxChecked=!axisConfig.checkBoxChecked},padding=isRight?info.axis.getAxisConfig("axisNamePadding"):-value.width;if(!currCheckBox){currCheckBox=info.checkbox=new _checkbox.default;axisSelectorUI.attachChild(currCheckBox,"checkbox",true);currCheckBox.configure({isChecked:true,text:"",stroke:chartConfig.checkBoxColor,symbolStroke:chartConfig.checkBoxColor,strokeWidth:1,symbolStrokeWidth:1,containerInfo:{id:"buttonGroup",label:"group",isParent:true}});currCheckBox.addEventListener("fc-click",checkboxClickHandler)}currCheckBox.setDimension({x:value.x+padding,y:value.y+value.height+checkboxTopPadding})}))}else{axisMapById.forEach((function(info,key){info.checkbox&&info.checkbox.remove();delete info.checkbox}))}};_proto._createLayers=function _createLayers(){var axisSelectorUI=this,parentLayer=axisSelectorUI.getFromEnv("chart").getChildContainer("selectorGroup");axisSelectorUI.createContainer("axisBottomGroup",{name:"axis-bottom-group"},parentLayer);axisSelectorUI.createContainer("axisTopGroup",{name:"axis-top-group"},parentLayer);axisSelectorUI.createContainer("buttonGroup",{name:"buttons"},parentLayer)};_proto.createContainer=function createContainer(containerName,attr,container){return this.addChildContainer(containerName,this.getFromEnv("animationManager").setAnimation({container:container,attr:attr,el:this.getChildContainer(containerName)||"group",component:this,label:"group"}))};_proto.draw=function draw(){this._createLayers();this.drawHotElements();this.drawCheckBoxes()};_proto._resuffelAxis=function _resuffelAxis(){var data=this.data("axisDetails"),axisSelectorUI=data.axisSelectorUI,conf=axisSelectorUI.config,canvas=data.canvas,axisId=data.axisId,axesDetails=axisSelectorUI.getAxesDetails();if(conf.besideCanvas!==axisId){axesDetails=axisSelectorUI.config.axisMapById=swap(conf.besideCanvas,axisId,axesDetails)}conf.besideCanvas=axisId;canvas.setPrimaryAxis("yAxis",axesDetails.get(axisId).axis);axisSelectorUI.setAxisDimention();axisSelectorUI.asyncDraw();canvas.getChildren("axisRefVisualCartesian")[0].asyncDraw()};_proto._dolegendInteraction=function _dolegendInteraction(axisId,chart){var checkbox=this,datasets=[],obj,dataset;chart.iterateComponents((function(child){if(child.getType()==="dataset"){datasets.push(child)}}));for(obj in datasets){if(datasets.hasOwnProperty(obj)){dataset=datasets[obj];if(dataset.getFromEnv("yAxis").getId()===axisId){if(!dataset.getState("visible")&&checkbox.config.checked){dataset.config.legendInteractivity=true;dataset.show()}else if(dataset.getState("visible")&&!checkbox.config.checked){dataset.config.legendInteractivity=true;dataset.hide()}}}}};_proto.manipulateCheckBox=function manipulateCheckBox(e){var data=e.data,clickedDS=data.dataset,axisId=clickedDS.getFromEnv("yAxis").getId(),vCanvas=clickedDS.getLinkedParent(),allDS=vCanvas.getChildren().dataset,checkboxUncheck=true,i,len,dataset,info,axisMapById=this.getAxesDetails();if(!(info=axisMapById.get(axisId))){return}if(data.state==="hide"){for(i=0,len=allDS.length;i<len;i++){dataset=allDS[i];if(dataset.getState("visible")){checkboxUncheck=false}}if(checkboxUncheck){info.checkbox&&info.checkbox.uncheck()}}else{info.checkbox&&info.checkbox.check()}};_proto.getAxesDetails=function getAxesDetails(){return this.config.axisMapById};_proto.getType=function getType(){return"customAxisUI"};_proto.getName=function getName(){return"multiAxisSelectorUI"};_proto.getAxes=function getAxes(){return Array.from(this.config.axisMapById.values()).map((function(elem){return elem.axis}))};return AxisSelectorUI}(_componentInterface.ComponentInterface);var _default=AxisSelectorUI;exports.default=_default;