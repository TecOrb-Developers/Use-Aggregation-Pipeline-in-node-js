#!/bin/bash

# ----------------------------------------------------------------------------------------------------------------------
# This script does the transpilation and minification before npm publish.
# This script will automatically executed by Learna using the pre-publish hook.
# It should be executed manually.
# ----------------------------------------------------------------------------------------------------------------------

# - Stop on first error
set -e

# Define constants
ROOT_DIR="./packages/fc-charts";
SOURCE_DIR="src";
TMP_SOURCE_DIR="_src";

# Remove the temp directory if exists
rm -rf ${ROOT_DIR}/${TMP_SOURCE_DIR};

# Rename src/ folder to _src/
mv ${ROOT_DIR}/${SOURCE_DIR} ${ROOT_DIR}/${TMP_SOURCE_DIR};

# List of files that will be ignored by babel
IGNORE_FILES="${ROOT_DIR}/${TMP_SOURCE_DIR}/_internal/vendors/__NAME__";

# Run the babel command in the _src directory and out files to src directory
npx babel --root-mode upward ${ROOT_DIR}/${TMP_SOURCE_DIR} -d ${ROOT_DIR}/${SOURCE_DIR} --ignore $IGNORE_FILES;

# Loop through all files in the src folder recursively and minify using Terser.
for f in $(find ${ROOT_DIR}/${SOURCE_DIR} -name '*.js')
do 
    npx terser $f -o $f;
    echo -e "âœ“ $f";
done

# Restore the original files by deleting the src folder and renaming the _src to src
# rm -rf ${ROOT_DIR}/${SOURCE_DIR};
# mv ${ROOT_DIR}/${TMP_SOURCE_DIR} ${ROOT_DIR}/${SOURCE_DIR};
