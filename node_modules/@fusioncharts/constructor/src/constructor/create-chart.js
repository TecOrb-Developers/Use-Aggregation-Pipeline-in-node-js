"use strict";var _interopRequireDefault=require("@babel/runtime/helpers/interopRequireDefault");exports.__esModule=true;exports.default=exports.globalStore=void 0;var _lib=require("@fusioncharts/core/src/lib");var _eventApi=require("@fusioncharts/core/src/event-api");var _dependencyManager=require("@fusioncharts/core/src/dependency-manager");var _schedular=require("@fusioncharts/core/src/schedular");var _globalStore=_interopRequireDefault(require("./global-store"));var _redluom=_interopRequireDefault(require("../decryption/core/redluom"));var percentRegex=/\%/,globalStore=new _globalStore.default,handleContainerResize=function(){var store={},intervalId,LocalFC,trackResize=function trackResize(){var item,itemObj,itemVar,parentEle,count=0,ref,s,offW,INTERVALMS=parseInt(LocalFC.options.resizeTrackingInterval,10)||300,jsVars={},storeContainerSize=function storeContainerSize(){jsVars.itemVar._containerOffsetW=jsVars.parentEle.offsetWidth;jsVars.itemVar._containerOffsetH=jsVars.parentEle.offsetHeight},offH;for(item in store){count+=1;itemObj=store[item];itemVar=itemObj.jsVars;ref=itemObj.ref;if(!itemObj.disposed&&(parentEle=ref&&ref.parentNode)&&(s=ref.style)&&(percentRegex.test(s.width)||percentRegex.test(s.height))){offW=parentEle.offsetWidth;offH=parentEle.offsetHeight;if(!itemVar.resizeLocked&&(offW&&itemVar._containerOffsetW!==offW||offH&&itemVar._containerOffsetH!==offH)){itemObj.resizeTo&&itemObj.resizeTo();jsVars.itemVar=itemVar;jsVars.parentEle=parentEle;setTimeout(storeContainerSize,1)}}else{delete store[item];count-=1}}if(!count){intervalId=clearTimeout(intervalId)}else{intervalId=setTimeout(trackResize,INTERVALMS)}};return function(sender,container,FusionCharts){var vars=sender.jsVars,element=container||sender.ref&&sender.ref.parentNode||{};LocalFC=FusionCharts;vars._containerOffsetW=element.parentNode.offsetWidth;vars._containerOffsetH=element.parentNode.offsetHeight;store[sender.id]=sender;if(!intervalId){intervalId=setTimeout(trackResize,parseInt(FusionCharts.options.resizeTrackingInterval,10)||300)}}}();exports.globalStore=globalStore;function createChart(FusionCharts,chartObj,container,typeArg,callback,message,style,suppressDataEvents){var Api,type=typeArg,instanceAPI=chartObj.apiInstance,eiMethods,vars=chartObj.jsVars,mapOptions,isMap,ToolTipController,toolTipController,chartWidth=percentRegex.test(chartObj.width)?container.offsetWidth:chartObj.width,chartHeight=percentRegex.test(chartObj.height)?container.offsetHeight:chartObj.height;container.FusionCharts=FusionCharts.items[chartObj.id];chartObj.__state.beforedrawFired=true;type=type||chartObj.chartType();Api=(0,_dependencyManager.getDep)(type,"chartapi");if(!Api&&(mapOptions=(0,_dependencyManager.getDep)(type,"maps"))){Api=(0,_dependencyManager.getDep)("maps","chartapi");isMap=true}if(instanceAPI&&instanceAPI.getName().toLowerCase()!==type.toLowerCase()){instanceAPI.remove({instant:true});instanceAPI=_lib.UNDEF}if(!instanceAPI||instanceAPI.getName().toLowerCase()!==type.toLowerCase()){instanceAPI=chartObj.apiInstance=new Api;globalStore.attachChild(instanceAPI,"chartAPI");instanceAPI.addToEnv("core-options",FusionCharts.options);instanceAPI.addToEnv("chartInstance",chartObj);instanceAPI.addToEnv("chart",instanceAPI);instanceAPI.addToEnv("chart-container",container);instanceAPI.addToEnv("eventListeners",[])}if(isMap){mapOptions=mapOptions[0];for(var attributes in mapOptions){if(mapOptions.hasOwnProperty(attributes)){instanceAPI.config[attributes]=mapOptions[attributes]}}}instanceAPI.addToEnv("chartWidth",Math.max(0,chartWidth));instanceAPI.addToEnv("chartHeight",Math.max(0,chartHeight));instanceAPI._removeWaitingJobs();instanceAPI.setDummyEImethods(type);instanceAPI.config.origRenderWidth=chartObj.__state.renderedWidth;instanceAPI.config.origRenderHeight=chartObj.__state.renderedHeight;if(type==="base"||message){isDataErroneous(chartObj,suppressDataEvents);setChartMsgStyle(chartObj,style);instanceAPI.createBaseComponent();instanceAPI.getFromEnv("animationManager").setAnimationState("chartmessage");instanceAPI.setChartMessage(message,chartObj,container)}else{if(!chartObj.__state.resize){if(!instanceAPI.getFromEnv("toolTipController")){ToolTipController=(0,_dependencyManager.getDep)("ToolTipController");toolTipController=new ToolTipController(container,instanceAPI);instanceAPI.addToEnv("toolTipController",toolTipController)}instanceAPI.disposeChartStyleSheet();container.jsVars=chartObj.jsVars;eiMethods=instanceAPI.eiMethods;chartObj.ref=container;vars.type=type;if(eiMethods&&typeof eiMethods!=="string"){for(var method in eiMethods){container[method]=eiMethods[method]}}if(!suppressDataEvents&&chartObj.__state.newDataArrived){(0,_eventApi.triggerEvent)("beforedataload",chartObj,{data:chartObj.getChartData((0,_dependencyManager.getDepsByType)("transcoder").JSON,true,true)},_lib.UNDEF,dataloadSuccess,dataloadCancel)}else{dataloadSuccess.call(chartObj,_lib.UNDEF,_lib.UNDEF,suppressDataEvents)}}else{instanceAPI.asyncDraw()}}!chartObj.disposed&&invokeCallback(chartObj,container,callback,{hasRendered:true,container:container},FusionCharts)}function dataloadSuccess(evtObj,evtData,silent){if(silent===void 0){silent=false}var chartObj=this,instanceAPI=chartObj.apiInstance,dataObj=chartObj.getChartData((0,_dependencyManager.getDepsByType)("transcoder").JSON,true,true).data;if(!silent){(0,_eventApi.triggerEvent)("dataloaded",chartObj,{},[chartObj.id])}chartObj.__state&&(chartObj.__state.newDataArrived=false);instanceAPI.addToEnv("dataSource",dataObj);instanceAPI.addToEnv("chart-attrib",dataObj.chart||{});if(instanceAPI._checkInvalidData()||instanceAPI._checkInvalidSpecificData()){instanceAPI.getContainer("parentgroup")&&instanceAPI.getContainer("parentgroup").hide();instanceAPI.createBaseComponent();instanceAPI.getFromEnv("animationManager").setAnimationState("chartmessage");instanceAPI.setChartMessage();instanceAPI.drawChartMessage();chartObj._sudoSetState(1);(0,_eventApi.triggerEvent)("nodatatodisplay",chartObj,{},[chartObj.id])}else{instanceAPI.config.hasChartMessage=false;instanceAPI.setData(Object.assign({},dataObj))}}function dataloadCancel(chartObj){var args=chartObj.sender.args,url=_lib.BLANK,dataFormat=args.dataFormat||"json";if(dataFormat.toLowerCase()==="jsonurl"||dataFormat.toLowerCase()==="xmlurl"){url=args.dataSource}(0,_eventApi.triggerEvent)("dataloadcancelled",chartObj,{url:url,dataFormat:dataFormat},[chartObj.id]);chartObj.__state&&(chartObj.__state.newDataArrived=false)}function postRenderHooks(chartObj,callback,param,FusionCharts){chartObj.apiInstance.addJob("fire-rendered",(function(){chartObj.apiInstance.config.hasRendered=param.hasRendered;!(chartObj._getState()==="waiting")&&typeof callback==="function"&&callback(param);if(!(chartObj._getState()==="waiting")){(0,_eventApi.triggerEvent)("drawcomplete",chartObj,{width:chartObj.jsVars.width,height:chartObj.jsVars.height,drawCount:chartObj.jsVars.drawCount,displayingMessage:chartObj._getState()==="waiting"||chartObj._getState()==="error",renderer:"javascript"},[chartObj.id]);chartObj.__state&&delete chartObj.__state.beforedrawFired}if(chartObj.disposed)return;if(chartObj._getState()==="ready"){chartObj.__state.rendering&&(0,_eventApi.triggerEvent)("rendered",chartObj,{renderer:"javascript"},[chartObj.id]);if(chartObj.disposed)return;(0,_eventApi.triggerEvent)("renderComplete",chartObj,{width:chartObj.jsVars.width,height:chartObj.jsVars.height,drawCount:chartObj.jsVars.drawCount,renderer:"javascript"});if(chartObj.disposed)return;chartObj.__state&&delete chartObj.__state.rendering;chartObj.__state.renderComplete=true;if(chartObj.args.creditLabel!==_lib.UNDEF){console.warn("FusionCharts.options.creditLabel property is deprecated. Please use FusionCharts.options.license with a valid license key to remove the watermark.")}_redluom.default._mapperParent(FusionCharts,chartObj)}}),_schedular.priorityList.postRender)}function invokeCallback(chartObj,container,callback,param,FusionCharts){var vars=chartObj.jsVars,instanceAPI=chartObj.apiInstance,fcObj=vars.fcObj,backEle=vars.overlayButton,dataObj=fcObj.getChartData((0,_dependencyManager.getDepsByType)("transcoder").JSON,true,true).data;vars.width=instanceAPI.getFromEnv("chartWidth");vars.height=instanceAPI.getFromEnv("chartHeight");vars.container=container;vars.hcObj=chartObj;vars.hcObj.container=container;vars.instanceAPI=instanceAPI;if(chartObj.hasRendered){if(vars.overlayButtonActive&&backEle){backEle.innerHTML=_lib.BLANK;backEle.appendChild(document.createTextNode(vars.overlayButtonMessage));chartObj.container.appendChild(backEle)}}if((dataObj.data||dataObj.dataset)&&(/\%/g.test(fcObj.width)||/\%/g.test(fcObj.height))&&container&&container.parentNode&&!FusionCharts.options.preventTrackResize){handleContainerResize(chartObj,container,FusionCharts)}postRenderHooks(chartObj,callback,param,FusionCharts)}function isDataErroneous(chartObj,silent){if(silent===void 0){silent=false}var errorneousData=chartObj.options.dataErroneous;if(errorneousData){chartObj.__state.dataReady=false;if(!silent){(0,_eventApi.triggerEvent)("dataInvalid",chartObj,{error:errorneousData},_lib.UNDEF,(function(){(0,_eventApi.triggerEvent)("dataxmlinvalid",chartObj,{},[chartObj.id])}))}return true}return false}function setChartMsgStyle(chartObj,style){if(style===void 0){style={}}chartObj._chartMessageImageStyle=style.image||{};chartObj._chartMessageStyle=style.message||{}}var _default=createChart;exports.default=_default;