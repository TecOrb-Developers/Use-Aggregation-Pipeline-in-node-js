"use strict";exports.__esModule=true;exports.getClipArray=exports.getClippedDatesWithin=exports.getClampRangesAround=exports.getValidDatesWithin=exports.getFloor=exports.clampDownDateWithinClip=exports.clampUpDateWithinClip=void 0;var _datetimeEnums=require("../datetime-enums");var capsFirst=function capsFirst(str){return str.charAt(0).toUpperCase()+str.slice(1)},clampDownDateWithinClip=function clampDownDateWithinClip(_initialDate,_offsetdate,_clipDates,_timeLimits){if(_timeLimits&&Array.isArray(_timeLimits)&&_timeLimits.length>0){if(Number(_offsetdate)>=Number(_timeLimits[1])){return _timeLimits[1]}else if(Number(_offsetdate)<=Number(_timeLimits[0])){return _timeLimits[0]}}if(!_clipDates||_clipDates.length<=0){return _offsetdate}var offsetDate=_offsetdate,initialDate=_initialDate,clipDates=_clipDates,clipArray=getValidDatesWithin(clipDates,initialDate,offsetDate),finalDate=getFinalClampDownDate(offsetDate,clipArray,clipDates,_timeLimits);return finalDate},getValidDatesWithin=function getValidDatesWithin(_clipDates,_date1,_date2){var clipDates=getClippedDatesWithin(_clipDates,_date1,_date2),clipArray=[];if(!_clipDates||_clipDates.length<=0){return clipArray}clipArray=getClipArray(clipDates,clipArray);return clipArray},getFinalClampDownDate=function getFinalClampDownDate(_date,_clipArray,_clipDates,timeLimits){var clipArray=_clipArray,clipDates=getClampRangesAround(_clipDates,_date),offsetdate=_date,finalDate,clipDuration=0;clipArray=getClipArray(clipDates,clipArray);if(clipArray.length>0){clipArray.forEach((function(date){clipDuration+=Number(date.to)-Number(date.from)}))}finalDate=new Date(Number(offsetdate.setTime(Number(offsetdate)+clipDuration)));if(Number(finalDate)===Number(offsetdate)){return offsetdate}finalDate=clampDownDateWithinClip(offsetdate,finalDate,_clipDates,timeLimits);return finalDate},getClampRangesAround=function getClampRangesAround(_clipDates,_date){var date=Number(_date),clipDates=_clipDates,clippingDuration=0,clipDatesArray=[];if(!_clipDates||_clipDates.length<=0){return clipDatesArray}if(Array.isArray(clipDates)){for(var i=0;i<clipDates.length;i++){var clipObject=clipDates[i],from=clipObject.from,to=clipObject.to;clippingDuration=to-from;if(clipObject.hasOwnProperty("repeat")){var repeatFrom=Number(from),repeatTo=Number(to),unitInMs=_datetimeEnums.DatetimeUnits[capsFirst(String(clipObject.repeat.unit))].ms,repeatAfter=unitInMs*clipObject.repeat.multiplier,clipFactor=Math.floor((date-repeatFrom)/repeatAfter),multiplier=clipFactor,clipDateFrom=void 0,clipDateTo=void 0;if(String(clipObject.repeat.unit).toLowerCase()==="month"){clipDateFrom=new Date(Number(new Date(repeatFrom).setMonth(new Date(repeatFrom).getMonth()+multiplier)));clipDateTo=new Date(Number(new Date(repeatTo).setMonth(new Date(repeatTo).getMonth()+multiplier)))}else if(String(clipObject.repeat.unit).toLowerCase()==="year"){clipDateFrom=new Date(Number(new Date(repeatFrom).setFullYear(new Date(repeatFrom).getFullYear()+multiplier)));clipDateTo=new Date(Number(new Date(repeatTo).setFullYear(new Date(repeatTo).getFullYear()+multiplier)))}else{clipDateFrom=new Date(Number(repeatFrom)+repeatAfter*clipFactor);clipDateTo=new Date(Number(clipDateFrom)+clippingDuration)}if(clipFactor<0){continue}if(date>=clipDateFrom&&date<clipDateTo){clipDatesArray.push({from:clipDateFrom,to:clipDateTo})}}else{if(from<=date&&to>date){clipDatesArray.push(clipObject)}}}}return clipDatesArray},getClippedDatesWithin=function getClippedDatesWithin(_clipDates,_date1,_date2){var date1=+_date1,date2=+_date2,clipDates=_clipDates,clippingDuration=0,clipDatesArray=[];if(Array.isArray(clipDates)){for(var i=0;i<clipDates.length;i++){var clipObject=clipDates[i],from=clipObject.from,to=clipObject.to;clippingDuration=to-from;if(clipObject.hasOwnProperty("repeat")){var repeatFrom=Number(from),repeatTo=Number(to),unitInMs=_datetimeEnums.DatetimeUnits[capsFirst(String(clipObject.repeat.unit))].ms,repeatAfter=unitInMs*clipObject.repeat.multiplier,clipFactor=Math.floor((date1-repeatFrom)/repeatAfter),multiplier=clipFactor,clipDateFrom=void 0,clipDateTo=void 0;if(String(clipObject.repeat.unit).toLowerCase()==="month"){clipDateFrom=new Date(Number(new Date(repeatFrom).setMonth(new Date(repeatFrom).getMonth()+multiplier)));clipDateTo=new Date(Number(new Date(repeatTo).setMonth(new Date(repeatTo).getMonth()+multiplier)))}else if(String(clipObject.repeat.unit).toLowerCase()==="year"){clipDateFrom=new Date(Number(new Date(repeatFrom).setFullYear(new Date(repeatFrom).getFullYear()+multiplier)));clipDateTo=new Date(Number(new Date(repeatTo).setFullYear(new Date(repeatTo).getFullYear()+multiplier)))}else{clipDateFrom=new Date(Number(repeatFrom)+repeatAfter*clipFactor);clipDateTo=new Date(Number(clipDateFrom)+clippingDuration)}if(clipFactor<0){continue}while(Number(clipDateFrom)<Number(date2)){if(Number(clipDateFrom)>Number(date1)&&Number(clipDateTo)<=Number(date2)){clipDatesArray.push({from:clipDateFrom,to:clipDateTo})}multiplier=Number(clipObject.repeat.multiplier);clipDateFrom=+clipDateFrom;clipDateTo=+clipDateTo;if(String(clipObject.repeat.unit).toLowerCase()==="month"){clipDateFrom=new Date(Number(new Date(clipDateFrom).setMonth(new Date(clipDateFrom).getMonth()+multiplier)));clipDateTo=new Date(Number(new Date(clipDateTo).setMonth(new Date(clipDateTo).getMonth()+multiplier)))}else if(String(clipObject.repeat.unit).toLowerCase()==="year"){clipDateFrom=new Date(Number(new Date(clipDateFrom).setFullYear(new Date(clipDateFrom).getFullYear()+multiplier)));clipDateTo=new Date(Number(new Date(clipDateTo).setFullYear(new Date(clipDateTo).getFullYear()+multiplier)))}else{clipDateFrom=new Date(Number(clipDateFrom)+repeatAfter);clipDateTo=new Date(Number(clipDateTo)+repeatAfter)}}}else{if(from>date1&&to<=date2){clipDatesArray.push(clipObject)}}}}return clipDatesArray},getClipArray=function getClipArray(_clipDates,_clipArray){var clipDates=_clipDates,clipArray=_clipArray,entryEnabled=true,i;if(!_clipDates||_clipDates.length<=0){return clipArray}var _loop=function _loop(){var clipDate=clipDates[i];entryEnabled=clipArray.every((function(date){if(clipDate.from>=date.from&&clipDate.to<=date.to){return false}else if(clipDate.from<=date.from&&clipDate.to>=date.to){date.entryEnabled=false}else if(clipDate.from>=date.from&&clipDate.from<=date.to&&clipDate.to>=date.to){clipDate.from=date.from;date.entryEnabled=false}else if(clipDate.to>=date.from&&clipDate.to<=date.to&&clipDate.from<=date.from){clipDate.to=date.to;date.entryEnabled=false}else{date.entryEnabled=true}return true}));if(entryEnabled){clipDate.entryEnabled=true;clipArray.push(clipDate)}};for(i=0;i<clipDates.length;i++){_loop()}clipArray=clipArray.filter((function(date){return date.entryEnabled===true}));return clipArray},clampUpDateWithinClip=function clampUpDateWithinClip(_initialDate,_offsetDate,_clipDates,_timeLimits){if(_timeLimits&&Array.isArray(_timeLimits)&&_timeLimits.length>0){if(Number(_offsetDate)>=Number(_timeLimits[1])){return _timeLimits[1]}else if(Number(_offsetDate)<=Number(_timeLimits[0])){return _timeLimits[0]}}if(!_clipDates||_clipDates.length<=0){return _offsetDate}var offsetDate=_offsetDate,clipDates=_clipDates,initialDate=_initialDate,clipArray=getValidDatesWithin(clipDates,offsetDate,initialDate),finalDate=getFinalClampUpDate(offsetDate,clipArray,clipDates,_timeLimits);return finalDate},getFinalClampUpDate=function getFinalClampUpDate(_date,_clipArray,_clipDates,timeLimits){var clipArray=_clipArray,clipDates=getClampRangesAround(_clipDates,_date),offsetdate=_date,finalDate,clipDuration=0;clipArray=getClipArray(clipDates,clipArray);if(clipArray.length>0){clipArray.forEach((function(date){clipDuration+=Number(date.to)-Number(date.from)}))}finalDate=new Date(Number(offsetdate.setTime(Number(offsetdate)-clipDuration)));if(Number(finalDate)===Number(offsetdate)){return offsetdate}finalDate=clampUpDateWithinClip(offsetdate,finalDate,_clipDates,timeLimits);return finalDate},getFloor=function getFloor(_date,_clipDates,_timeLimits){if(_timeLimits&&Array.isArray(_timeLimits)&&_timeLimits.length>0){if(Number(_date)>=Number(_timeLimits[1])){return _timeLimits[1]}else if(Number(_date)<=Number(_timeLimits[0])){return _timeLimits[0]}}if(!_clipDates||_clipDates.length<=0){return _date}var date=_date,finalDate,clipDates=getClampRangesAround(_clipDates,_date),clipArray=[];if(clipDates.length===0){return date}clipArray=getClipArray(clipDates,clipArray);finalDate=clipArray.reduce((function(prev,current){return prev.to>current.to?+new Date(Number(prev.to)):+new Date(Number(current.to))}),0);return Number(finalDate)===Number(date)?finalDate:getFloor(finalDate,_clipDates,_timeLimits)};exports.getFloor=getFloor;exports.clampUpDateWithinClip=clampUpDateWithinClip;exports.getClipArray=getClipArray;exports.getClippedDatesWithin=getClippedDatesWithin;exports.getClampRangesAround=getClampRangesAround;exports.getValidDatesWithin=getValidDatesWithin;exports.clampDownDateWithinClip=clampDownDateWithinClip;